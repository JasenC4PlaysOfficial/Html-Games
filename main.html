<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Games</title>
    <link rel="shortcut icon" href="https://www.google.com/favicon.ico" id="dynamic-favicon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0B0F19',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B0F19; /* Deep dark background */
            color: #E5E7EB;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563; 
        }

        .game-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Loader */
        .loader {
            border: 4px solid #1f2937;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .iframe-container {
            width: 100%;
            height: calc(100% - 48px); /* Subtract header height */
            border: none;
            background: white;
        }
        
        /* Chat Styles */
        .chat-msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }
        .msg-bot {
            background-color: #374151;
            color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            margin-right: auto;
        }
        .msg-user {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            margin-left: auto;
        }
        
        /* Markdown Styles within Chat */
        .chat-msg p { margin-bottom: 0.5em; }
        .chat-msg p:last-child { margin-bottom: 0; }
        .chat-msg strong { color: #fff; font-weight: 700; }
        .chat-msg em { font-style: italic; color: #d1d5db; }
        .chat-msg code { background: #1f2937; padding: 2px 4px; rounded: 4px; font-family: monospace; color: #e5e7eb; }
        .chat-msg pre { background: #111827; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .chat-msg pre code { background: transparent; padding: 0; color: #a5b4fc; }
        .chat-msg ul { list-style-type: disc; padding-left: 20px; margin: 8px 0; }
        .chat-msg ol { list-style-type: decimal; padding-left: 20px; margin: 8px 0; }
        .chat-msg h1, .chat-msg h2, .chat-msg h3 { font-weight: 800; color: #fff; margin-top: 12px; margin-bottom: 8px; }
        .chat-msg h1 { font-size: 1.25em; }
        .chat-msg h2 { font-size: 1.15em; }
        .chat-msg h3 { font-size: 1.05em; }
        .chat-msg a { color: #6366f1; text-decoration: underline; }
        .chat-msg table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }
        .chat-msg th, .chat-msg td { border: 1px solid #4b5563; padding: 6px 10px; text-align: left; }
        .chat-msg th { background-color: #1f2937; color: #fff; font-weight: bold; }
        .chat-msg tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }

        .typing-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(-4px); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-900 border-b border-gray-800 sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i class="fas fa-gamepad text-white text-lg"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight text-white hidden sm:block">Math Games</span>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- More Games (GN Math) -->
                    <button onclick="openMoreGames()" class="p-2 text-green-400 hover:text-white bg-gray-800 hover:bg-green-600 rounded-lg transition-colors border border-gray-700 flex items-center gap-2 text-sm font-bold" title="Open More Games">
                        <i class="fas fa-external-link-alt"></i> <span class="hidden sm:inline">More Games</span>
                    </button>

                    <!-- Settings / Tab Cloak -->
                    <button onclick="toggleSettings()" class="p-2 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-700" title="Settings & Tab Cloak">
                        <i class="fas fa-cog"></i>
                    </button>

                    <!-- Refresh Button -->
                    <button onclick="fetchGames()" class="p-2 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-700 hidden sm:block" title="Refresh Library">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    
                    <!-- AI Chat Button -->
                    <button onclick="toggleChat()" class="p-2 text-indigo-400 hover:text-white bg-gray-800 hover:bg-indigo-600 rounded-lg transition-all border border-gray-700 group relative" title="AI Assistant">
                        <i class="fas fa-robot group-hover:animate-bounce-slow"></i>
                        <span class="absolute -top-1 -right-1 flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                        </span>
                    </button>

                    <!-- Search Bar -->
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        <input type="text" id="search-bar" placeholder="Search..." 
                            class="bg-gray-800 text-sm text-gray-200 rounded-full pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-32 sm:w-64 transition-all border border-gray-700">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full relative">
        
        <!-- Header Section -->
        <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">All Games</h1>
                <p class="text-gray-400">Select a game to play</p>
                <p class="text-yellow-500 text-sm mt-2 font-bold flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i> You HAVE to open some games in a new tab for them to work!
                </p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="flex flex-col justify-center items-center h-64">
            <div class="loader mb-4"></div>
            <p class="text-gray-400 animate-pulse">Scanning repository for HTML files...</p>
        </div>

        <!-- Error State -->
        <div id="error-message" class="hidden flex flex-col justify-center items-center h-64 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Oops! Something went wrong.</h2>
            <p id="error-text" class="text-gray-400 max-w-md">Could not load games.</p>
            <button onclick="fetchGames()" class="mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white transition-colors">
                Try Again
            </button>
        </div>

        <!-- Games Grid -->
        <div id="games-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
            <!-- Game cards will be injected here -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-800 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2026 Math Games.</p>
        </div>
    </footer>

    <!-- Settings / Tab Cloak Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black bg-opacity-80 hidden flex flex-col items-center justify-center opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Tab Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Tab Title</label>
                    <input type="text" id="cloak-title" placeholder="Google Drive" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-600 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Tab Icon URL</label>
                    <input type="text" id="cloak-icon" placeholder="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-600 outline-none">
                </div>
                
                <!-- Quick Presets -->
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <button onclick="applyPreset('Google Drive', 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Drive</button>
                    <button onclick="applyPreset('Google Classroom', 'https://ssl.gstatic.com/classroom/favicon.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Classroom</button>
                    <button onclick="applyPreset('Google Docs', 'https://ssl.gstatic.com/images/branding/product/1x/docs_2020q4_32dp.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Docs</button>
                </div>

                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-800">
                    <button onclick="resetCloak()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Reset</button>
                    <button onclick="applyCloakManual()" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-medium">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex flex-col opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        
        <!-- AI Toolbar -->
        <div class="bg-gray-900 border-b border-gray-700 p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-full">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-lg">AI Chatbot</h3>
                    <p class="text-indigo-400 text-xs font-mono">UNRESTRICTED AI MODEL</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="Close AI">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-grow flex justify-center overflow-hidden bg-gray-950">
            <div class="w-full max-w-3xl flex flex-col h-full">
                
                <!-- Messages Container -->
                <div id="chat-messages" class="flex-grow overflow-y-auto p-6 flex flex-col gap-4">
                    <!-- Bot Welcome -->
                    <div class="chat-msg msg-bot shadow-md">
                        <div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div>
                        Hello! I am a fully functional AI assistant. I can see images and answer questions.<br><br>Upload an image or ask me anything!
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-6 border-t border-gray-800 bg-gray-900">
                    
                    <!-- Image Preview -->
                    <div id="image-preview" class="hidden mb-3 relative inline-block">
                        <img id="preview-img" src="" class="h-20 w-auto rounded-lg border border-indigo-500 shadow-lg">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Input Group -->
                    <div class="relative flex items-center bg-gray-800 rounded-xl border border-gray-700 shadow-inner focus-within:ring-2 focus-within:ring-indigo-600 transition-all">
                        
                        <!-- File Input (Hidden) -->
                        <input type="file" id="chat-file" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        
                        <!-- Upload Button -->
                        <button onclick="document.getElementById('chat-file').click()" class="pl-4 pr-2 text-gray-400 hover:text-indigo-400 transition-colors" title="Upload Image">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>

                        <input type="text" id="chat-input" placeholder="Ask anything... (Ctrl+V to paste images)" 
                            class="w-full bg-transparent text-white pl-2 pr-12 py-4 focus:outline-none"
                            onkeypress="handleChatKey(event)">
                        
                        <button id="send-btn" onclick="sendChatMessage()" class="absolute right-2 top-2 bottom-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 transition-all transform hover:scale-105">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-center text-gray-600 text-xs mt-3">Powered by Pollinations AI (GPT-4o-mini). Supports Vision.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Window Overlay -->
    <div id="game-modal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex flex-col opacity-0 transition-opacity duration-300">
        <div class="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <h3 id="modal-title" class="text-white font-semibold ml-2">Game Title</h3>
                <span id="game-loading" class="hidden text-xs text-indigo-400 animate-pulse ml-2 flex items-center"><i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="text-xs font-bold text-gray-500 mr-2 border border-gray-700 rounded px-2 py-1">CDN</div>
                
                <!-- Open in New Tab Button -->
                <button onclick="openInNewTab()" class="p-2 text-blue-400 hover:text-blue-300 hover:bg-gray-700 rounded-md transition-colors" title="Open in New Tab">
                    <i class="fas fa-external-link-alt"></i>
                </button>

                <div class="h-6 w-px bg-gray-700 mx-1"></div>
                <button onclick="toggleFullscreen()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-colors" title="Fullscreen"><i class="fas fa-expand"></i></button>
                <button onclick="closeGame()" class="p-2 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded-md transition-colors ml-2" title="Close"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="iframe-wrapper" class="flex-grow relative bg-black w-full h-full">
            <iframe id="game-frame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-modals" allow="fullscreen; autoplay; gamepad; pointer-lock; clipboard-read; clipboard-write"></iframe>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SOURCES = [
            { owner: 'JasenC4PlaysOfficial', repo: 'Html-Games', path: 'games', branch: 'main' }
        ];
        
        // Single Source of Truth for CDN - JSDelivr only
        const CDN_BASE_URL = (owner, repo, branch) => `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/`;

        // State
        let allGames = [];
        let currentGame = null;
        let isChatOpen = false;
        let isSettingsOpen = false;
        let currentImageFile = null;
        let currentGameHTML = ""; 

        // DOM Elements
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const gamesGrid = document.getElementById('games-grid');
        const searchBar = document.getElementById('search-bar');
        const modal = document.getElementById('game-modal');
        let gameFrame = document.getElementById('game-frame');
        const modalTitle = document.getElementById('modal-title');
        const gameLoadingIndicator = document.getElementById('game-loading');
        const iframeWrapper = document.getElementById('iframe-wrapper');
        
        const aiModal = document.getElementById('ai-modal');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const settingsModal = document.getElementById('settings-modal');

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', fetchGames);

        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            renderGames(allGames); // Re-render with updated query from search bar
        });

        chatInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    processImageFile(blob);
                    e.preventDefault(); 
                }
            }
        });

        // --- Core Logic ---

        async function fetchGames() {
            if (!loader || !errorDiv || !gamesGrid) return;

            loader.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            gamesGrid.classList.add('hidden');
            gamesGrid.innerHTML = '';
            
            allGames = []; 

            try {
                await Promise.all(SOURCES.map(source => fetchFromSource(source)));

                if (allGames.length === 0) throw new Error("No HTML games found in any repository.");

                allGames.sort((a, b) => a.name.localeCompare(b.name));
                
                renderGames(allGames);
                
                loader.classList.add('hidden');
                gamesGrid.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loader.classList.add('hidden');
                errorText.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function fetchFromSource(source) {
            const apiUrl = `https://api.github.com/repos/${source.owner}/${source.repo}/git/trees/${source.branch}?recursive=1`;
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) return;
                const data = await response.json();
                
                const filePaths = new Set(data.tree.map(item => item.path));
                const featuredFolders = new Set();
                
                data.tree.forEach(item => {
                    if (item.path.endsWith('featured.info')) {
                        const folder = item.path.substring(0, item.path.lastIndexOf('/'));
                        featuredFolders.add(folder);
                    }
                });

                const gamesMap = new Map();
                
                data.tree.forEach(item => {
                    const targetPath = source.path ? `${source.path}/` : '';
                    if (item.path.startsWith(targetPath) && item.path.endsWith('.html')) {
                        const parts = item.path.split('/');
                        const minDepth = source.path ? 3 : 2; // games/Folder/file.html vs Folder/file.html
                        
                        if (parts.length >= minDepth) {
                            const folderIndex = source.path ? 1 : 0;
                            const gameFolder = parts[folderIndex];
                            const fileName = parts.slice(folderIndex + 1).join('/'); 
                            
                            const folderPath = source.path ? `${source.path}/${gameFolder}` : gameFolder;
                            let iconPath = null;
                            if (filePaths.has(`${folderPath}/icon.png`)) iconPath = `${folderPath}/icon.png`;
                            else if (filePaths.has(`${folderPath}/icon.jpg`)) iconPath = `${folderPath}/icon.jpg`;
                            else if (filePaths.has(`${folderPath}/logo.png`)) iconPath = `${folderPath}/logo.png`;
                            
                            const isFeatured = featuredFolders.has(folderPath);

                            if (gamesMap.has(gameFolder)) {
                                if (fileName.toLowerCase() === 'index.html') {
                                    gamesMap.set(gameFolder, { path: item.path, sha: item.sha, icon: iconPath, isFeatured });
                                }
                            } else {
                                gamesMap.set(gameFolder, { path: item.path, sha: item.sha, icon: iconPath, isFeatured });
                            }
                        }
                    }
                });

                const sourceGames = Array.from(gamesMap, ([folderName, data]) => ({
                    name: formatGameName(folderName),
                    rawName: folderName,
                    fullPath: data.path,
                    sha: data.sha,
                    iconPath: data.icon,
                    isFeatured: data.isFeatured,
                    owner: source.owner,
                    repo: source.repo,
                    branch: source.branch
                }));
                
                allGames.push(...sourceGames);

            } catch (e) {
                console.error(`Error loading source ${source.repo}`, e);
            }
        }

        function createGameCard(game, index) {
            const iconUrl = game.iconPath ? CDN_BASE_URL(game.owner, game.repo, game.branch) + game.iconPath : null;
            const card = document.createElement('div');
            card.className = 'game-card bg-gray-800 rounded-xl overflow-hidden border border-gray-700 cursor-pointer animate-slide-up flex flex-col h-full';
            card.style.animationDelay = `${Math.min(index * 0.05, 1.0)}s`;
            
            let visualContent;
            if (iconUrl) {
                visualContent = `
                    <div class="h-40 w-full relative bg-gray-900 group">
                        <img src="${iconUrl}" alt="${game.name}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
                            <div class="bg-indigo-600 rounded-full p-3 transform scale-0 group-hover:scale-100 transition-transform duration-300 shadow-lg"><i class="fas fa-play text-white"></i></div>
                        </div>
                    </div>`;
            } else {
                const initials = game.name.substring(0, 2).toUpperCase();
                const hue = (game.name.length * 25) % 360;
                visualContent = `
                    <div class="h-40 w-full flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-900 relative group">
                        <div class="absolute inset-0 bg-opacity-20 flex items-center justify-center" style="background-color: hsla(${hue}, 60%, 50%, 0.2);">
                            <span class="text-4xl font-black text-white opacity-20 select-none group-hover:scale-110 transition-transform duration-300">${initials}</span>
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center">
                            <div class="bg-indigo-600 rounded-full p-3 transform scale-0 group-hover:scale-100 transition-transform duration-300 shadow-lg"><i class="fas fa-play text-white"></i></div>
                        </div>
                    </div>`;
            }

            card.innerHTML = `
                ${visualContent}
                <div class="p-4 flex-grow">
                    <h3 class="text-white font-bold text-lg truncate" title="${game.name}">${game.name}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs font-mono text-gray-500">JasenC4Plays</span>
                        <span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded">HTML5</span>
                    </div>
                </div>
            `;
            card.addEventListener('click', () => openGame(game));
            return card;
        }

        function renderGames(games) {
            gamesGrid.innerHTML = '';
            const query = searchBar.value.trim().toLowerCase();
            const displayGames = query.length > 0 ? games.filter(g => g.name.toLowerCase().includes(query)) : games;

            if (displayGames.length === 0) {
                gamesGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10"><p>No games found.</p></div>`;
                return;
            }

            if (query.length === 0) {
                const featured = displayGames.filter(g => g.isFeatured);
                const regular = displayGames.filter(g => !g.isFeatured);

                if (featured.length > 0) {
                    const featHeader = document.createElement('h2');
                    featHeader.className = "col-span-full text-2xl font-bold text-yellow-400 mb-2 mt-4 flex items-center gap-2 border-b border-gray-800 pb-2";
                    featHeader.innerHTML = '<i class="fas fa-star"></i> Featured';
                    gamesGrid.appendChild(featHeader);
                    featured.forEach((game, index) => gamesGrid.appendChild(createGameCard(game, index)));

                    const allHeader = document.createElement('h2');
                    allHeader.className = "col-span-full text-2xl font-bold text-white mb-2 mt-8 border-b border-gray-800 pb-2";
                    allHeader.textContent = "All Games";
                    gamesGrid.appendChild(allHeader);
                }
                regular.forEach((game, index) => gamesGrid.appendChild(createGameCard(game, index)));
            } else {
                displayGames.forEach((game, index) => gamesGrid.appendChild(createGameCard(game, index)));
            }
        }

        function formatGameName(folderName) {
            return folderName.replace(/-/g, ' ').replace(/([A-Z])/g, ' $1').trim();
        }

        function openMoreGames() {
            fetch("https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/autoupdate.html?t="+Date.now())
            .then(response => response.text())
            .then(text => {
                const newWin = window.open("about:blank", "_blank");
                if (newWin) {
                    newWin.document.open();
                    newWin.document.write(text);
                    newWin.document.close();
                }
            })
            .catch(err => alert("Could not load More Games."));
        }

        // --- Settings ---
        function toggleSettings() {
            isSettingsOpen = !isSettingsOpen;
            if (isSettingsOpen) {
                settingsModal.classList.remove('hidden');
                setTimeout(() => settingsModal.classList.remove('opacity-0'), 10);
            } else {
                settingsModal.classList.add('opacity-0');
                setTimeout(() => settingsModal.classList.add('hidden'), 300);
            }
        }

        function applyPreset(title, icon) {
            document.getElementById('cloak-title').value = title;
            document.getElementById('cloak-icon').value = icon;
            setCloak(title, icon);
            toggleSettings();
        }

        function applyCloakManual() {
            const title = document.getElementById('cloak-title').value;
            const icon = document.getElementById('cloak-icon').value;
            setCloak(title, icon);
            toggleSettings();
        }

        function resetCloak() {
            document.title = "Math Games";
            const link = document.querySelector("link[rel*='icon']");
            link.href = "https://www.google.com/favicon.ico";
            document.getElementById('cloak-title').value = "";
            document.getElementById('cloak-icon').value = "";
        }

        function setCloak(title, icon) {
            if (title) document.title = title;
            if (icon) {
                let link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                link.type = 'image/x-icon';
                link.rel = 'shortcut icon';
                link.href = icon;
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        }

        // --- Chat Bot ---
        let chatHistory = [{ role: 'system', content: 'You are AI Chatbot, a helpful, intelligent assistant. You have VISION capabilities.' }];

        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                aiModal.classList.remove('hidden');
                setTimeout(() => aiModal.classList.remove('opacity-0'), 10);
                chatInput.focus();
                document.body.style.overflow = 'hidden';
            } else {
                aiModal.classList.add('opacity-0');
                setTimeout(() => aiModal.classList.add('hidden'), 300);
                document.body.style.overflow = '';
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processImageFile(file);
        }

        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_DIM = 512;
                    if (width > height) { if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; } }
                    else { if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; } }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview-img').src = resizedDataUrl;
                    document.getElementById('image-preview').classList.remove('hidden');
                    currentImageFile = resizedDataUrl; 
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            document.getElementById('chat-file').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('preview-img').src = '';
            currentImageFile = null;
        }

        function addMessage(text, isUser, isHtml = false) {
            const div = document.createElement('div');
            div.className = `chat-msg ${isUser ? 'msg-user' : 'msg-bot'} animate-slide-up`;
            if (!isUser) {
                div.innerHTML = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div>` + (isHtml ? text : text);
            } else {
                 if (isHtml) div.innerHTML = text;
                 else div.textContent = text;
            }
            chatMessages.appendChild(div);
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 50);
            return div; 
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'chat-msg msg-bot animate-slide-up';
            div.innerHTML = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div><span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage() {
            const txt = chatInput.value.trim();
            const imageData = currentImageFile; 
            if (!txt && !imageData) return;

            let displayHtml = txt;
            let apiContent = txt;

            if (imageData) {
                displayHtml = `<div><img src="${imageData}" class="max-h-64 rounded-lg mb-2 border border-gray-600 shadow-md"></div><div class="whitespace-pre-wrap">${txt}</div>`;
                apiContent = [
                    { type: "image_url", image_url: { url: imageData } },
                    { type: "text", text: txt || "Analyze this image." }
                ];
                clearImage();
            }

            addMessage(displayHtml, true, true);
            chatInput.value = '';
            
            chatHistory.push({ role: 'user', content: apiContent });
            showTypingIndicator();

            const fetchAI = async (model, retries = 2) => {
                try {
                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: chatHistory, model: model, json: false })
                    });
                    if (!response.ok) throw new Error("API Error");
                    return await response.text();
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, 1500)); 
                        return fetchAI(model, retries - 1);
                    }
                    throw err;
                }
            };

            try {
                let aiText;
                try { aiText = await fetchAI('gpt-4o'); } 
                catch (e) { 
                    if (imageData) {
                         chatHistory.pop(); 
                         chatHistory.push({ role: 'user', content: "[Image Upload Failed] " + txt });
                    }
                    aiText = await fetchAI('openai');
                }

                removeTypingIndicator();
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-msg msg-bot animate-slide-up`;
                msgDiv.innerHTML = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div><div class="content-area"></div>`;
                chatMessages.appendChild(msgDiv);
                const contentArea = msgDiv.querySelector('.content-area');
                let currentText = "";
                const chars = aiText.split('');
                let i = 0;
                const typingInterval = setInterval(() => {
                    if (i < chars.length) {
                        currentText += chars[i];
                        contentArea.innerHTML = marked.parse(currentText);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        contentArea.innerHTML = marked.parse(aiText);
                        chatHistory.push({ role: 'assistant', content: aiText });
                    }
                }, 10); 
            } catch (err) {
                removeTypingIndicator();
                addMessage(`Connection error. Please try again.`, false);
            }
        }

        // --- Game Loading (Embed / srcdoc Strategy) ---

        async function openGame(game) {
            currentGame = game;
            modalTitle.textContent = game.name;
            gameFrame.src = 'about:blank';
            gameFrame.removeAttribute('srcdoc');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden';
            
            loadGameContent(game);
        }

        async function loadGameContent(game) {
            gameLoadingIndicator.classList.remove('hidden');
            currentGameHTML = ""; 

            try {
                // 1. Fetch from JSDelivr (Text only)
                const cdnUrl = CDN_BASE_URL(game.owner, game.repo, game.branch) + game.fullPath;
                const response = await fetch(cdnUrl);
                if (!response.ok) throw new Error("Failed to fetch game");
                let htmlCode = await response.text();

                // 2. Base Path for Assets (via JSDelivr)
                const assetBaseDir = cdnUrl.substring(0, cdnUrl.lastIndexOf('/') + 1);

                // 3. Inject <base> tag to force relative assets to load from CDN
                const baseTagRegex = /<base\s+href=["']([^"']+)["'][^>]*>/i;
                if (!htmlCode.match(baseTagRegex)) {
                    const newBaseTag = `<base href="${assetBaseDir}">`;
                    if (htmlCode.includes('<head>')) {
                        htmlCode = htmlCode.replace('<head>', '<head>' + newBaseTag);
                    } else {
                        htmlCode = newBaseTag + htmlCode;
                    }
                }

                // 4. Critical Polyfills for srcdoc/iframe execution
                const polyfill = `
                <script>
                    (function() {
                        const BASE_URL = "${assetBaseDir}";
                        console.log("Embed Polyfill Active. Base:", BASE_URL);

                        // Fix Unity IndexedDB Crash in iframe
                        try {
                            window.indexedDB = null;
                            window.mozIndexedDB = null;
                            window.webkitIndexedDB = null;
                            window.msIndexedDB = null;
                        } catch(e) {}

                        // Fix URL Constructor for Unity (new URL('file', 'about:srcdoc') crashes)
                        const OriginalURL = window.URL;
                        window.URL = function(url, base) {
                            if (!base || base === 'about:srcdoc' || base === 'about:blank') {
                                base = BASE_URL; 
                            }
                            try { return new OriginalURL(url, base); } 
                            catch(e) { return new OriginalURL(url); }
                        };
                        window.URL.createObjectURL = OriginalURL.createObjectURL;
                        window.URL.revokeObjectURL = OriginalURL.revokeObjectURL;
                    })();
                <\/script>`;

                if (htmlCode.includes('<head>')) {
                    htmlCode = htmlCode.replace('<head>', '<head>' + polyfill);
                } else {
                    htmlCode = polyfill + htmlCode;
                }

                // 5. Inject into iframe via srcdoc
                gameFrame.srcdoc = htmlCode;
                currentGameHTML = htmlCode;

            } catch (err) {
                console.error("Load failed:", err);
                gameFrame.src = CDN_BASE_URL(game.owner, game.repo, game.branch) + game.fullPath; 
            } finally {
                setTimeout(() => gameLoadingIndicator.classList.add('hidden'), 1000);
            }
        }

        function openInNewTab() {
            if (!currentGameHTML) {
                alert("Game content not ready yet.");
                return;
            }
            const newWin = window.open("about:blank", "_blank");
            if (!newWin) {
                alert("Pop-up blocked!");
                return;
            }
            newWin.document.open();
            newWin.document.write(currentGameHTML);
            newWin.document.close();
        }

        function closeGame() {
            try { if (gameFrame.contentWindow) gameFrame.contentWindow.onbeforeunload = null; } catch (e) { }
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                const newFrame = document.createElement('iframe');
                newFrame.id = 'game-frame';
                newFrame.className = 'w-full h-full border-0';
                newFrame.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-modals');
                newFrame.setAttribute('allow', 'fullscreen; autoplay; gamepad; pointer-lock');
                if (gameFrame.parentNode) gameFrame.parentNode.replaceChild(newFrame, gameFrame);
                gameFrame = newFrame;
                currentGame = null;
                currentGameHTML = "";
                exitFullscreen();
            }, 300);
            document.body.style.overflow = '';
        }

        function toggleFullscreen() {
            const elem = iframeWrapper;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.fullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!modal.classList.contains('hidden')) closeGame();
                if (!aiModal.classList.contains('hidden')) toggleChat();
                if (!settingsModal.classList.contains('hidden')) toggleSettings();
            }
        });
        window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = ''; });
    </script>
</body>
</html>