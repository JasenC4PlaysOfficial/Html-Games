<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Games</title>
    <link rel="shortcut icon" href="https://www.google.com/favicon.ico" id="dynamic-favicon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0B0F19',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B0F19; /* Deep dark background */
            color: #E5E7EB;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563; 
        }

        .game-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Loader */
        .loader {
            border: 4px solid #1f2937;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .iframe-container {
            width: 100%;
            height: calc(100% - 48px); /* Subtract header height */
            border: none;
            background: white;
        }
        
        /* Chat Styles */
        .chat-msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }
        .msg-bot {
            background-color: #374151;
            color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            margin-right: auto;
        }
        .msg-user {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            margin-left: auto;
        }
        
        /* Markdown Styles within Chat */
        .chat-msg p { margin-bottom: 0.5em; }
        .chat-msg p:last-child { margin-bottom: 0; }
        .chat-msg strong { color: #fff; font-weight: 700; }
        .chat-msg em { font-style: italic; color: #d1d5db; }
        .chat-msg code { background: #1f2937; padding: 2px 4px; rounded: 4px; font-family: monospace; color: #e5e7eb; }
        .chat-msg pre { background: #111827; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .chat-msg pre code { background: transparent; padding: 0; color: #a5b4fc; }
        .chat-msg ul { list-style-type: disc; padding-left: 20px; margin: 8px 0; }
        .chat-msg ol { list-style-type: decimal; padding-left: 20px; margin: 8px 0; }
        .chat-msg h1, .chat-msg h2, .chat-msg h3 { font-weight: 800; color: #fff; margin-top: 12px; margin-bottom: 8px; }
        .chat-msg h1 { font-size: 1.25em; }
        .chat-msg h2 { font-size: 1.15em; }
        .chat-msg h3 { font-size: 1.05em; }
        .chat-msg a { color: #6366f1; text-decoration: underline; }
        .chat-msg table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }
        .chat-msg th, .chat-msg td { border: 1px solid #4b5563; padding: 6px 10px; text-align: left; }
        .chat-msg th { background-color: #1f2937; color: #fff; font-weight: bold; }
        .chat-msg tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }

        .typing-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(-4px); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-900 border-b border-gray-800 sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i class="fas fa-gamepad text-white text-lg"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight text-white hidden sm:block">Math Games</span>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- More Games (GN Math) -->
                    <button onclick="openMoreGames()" class="p-2 text-green-400 hover:text-white bg-gray-800 hover:bg-green-600 rounded-lg transition-colors border border-gray-700 flex items-center gap-2 text-sm font-bold" title="Open More Games">
                        <i class="fas fa-external-link-alt"></i> <span class="hidden sm:inline">More Games</span>
                    </button>

                    <!-- Settings / Tab Cloak -->
                    <button onclick="toggleSettings()" class="p-2 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-700" title="Settings & Tab Cloak">
                        <i class="fas fa-cog"></i>
                    </button>

                    <!-- Refresh Button -->
                    <button onclick="fetchGames()" class="p-2 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-700 hidden sm:block" title="Refresh Library">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    
                    <!-- AI Chat Button -->
                    <button onclick="toggleChat()" class="p-2 text-indigo-400 hover:text-white bg-gray-800 hover:bg-indigo-600 rounded-lg transition-all border border-gray-700 group relative" title="AI Assistant">
                        <i class="fas fa-robot group-hover:animate-bounce-slow"></i>
                        <span class="absolute -top-1 -right-1 flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                        </span>
                    </button>

                    <!-- Search Bar -->
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        <input type="text" id="search-bar" placeholder="Search..." 
                            class="bg-gray-800 text-sm text-gray-200 rounded-full pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-32 sm:w-64 transition-all border border-gray-700">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full relative">
        
        <!-- Header Section -->
        <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">All Games</h1>
                <p class="text-gray-400">Select a game to play</p>
            </div>
            
            <!-- Source Filters -->
            <div class="flex gap-2 bg-gray-900 p-1 rounded-lg border border-gray-800">
                <button onclick="filterSource('all')" id="filter-all" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 shadow transition-colors">All</button>
                <button onclick="filterSource('jasen')" id="filter-jasen" class="px-4 py-2 text-sm font-medium rounded-md text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">Jasen</button>
                <button onclick="filterSource('talha')" id="filter-talha" class="px-4 py-2 text-sm font-medium rounded-md text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">Talha</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="flex flex-col justify-center items-center h-64">
            <div class="loader mb-4"></div>
            <p class="text-gray-400 animate-pulse">Scanning repository for HTML files...</p>
        </div>

        <!-- Error State -->
        <div id="error-message" class="hidden flex flex-col justify-center items-center h-64 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Oops! Something went wrong.</h2>
            <p id="error-text" class="text-gray-400 max-w-md">Could not load games.</p>
            <button onclick="fetchGames()" class="mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white transition-colors">
                Try Again
            </button>
        </div>

        <!-- Games Grid -->
        <div id="games-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
            <!-- Game cards will be injected here -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-800 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2026 Math Games.</p>
        </div>
    </footer>

    <!-- Settings / Tab Cloak Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black bg-opacity-80 hidden flex flex-col items-center justify-center opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Tab Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Tab Title</label>
                    <input type="text" id="cloak-title" placeholder="Google Drive" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-600 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Tab Icon URL</label>
                    <input type="text" id="cloak-icon" placeholder="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-600 outline-none">
                </div>
                
                <!-- Quick Presets -->
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <button onclick="applyPreset('Google Drive', 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Drive</button>
                    <button onclick="applyPreset('Google Classroom', 'https://ssl.gstatic.com/classroom/favicon.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Classroom</button>
                    <button onclick="applyPreset('Google Docs', 'https://ssl.gstatic.com/images/branding/product/1x/docs_2020q4_32dp.png')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-xs text-gray-300 border border-gray-700">Docs</button>
                </div>

                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-800">
                    <button onclick="resetCloak()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Reset</button>
                    <button onclick="applyCloakManual()" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-medium">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex flex-col opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        
        <!-- AI Toolbar -->
        <div class="bg-gray-900 border-b border-gray-700 p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-full">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-lg">AI Chatbot</h3>
                    <p class="text-indigo-400 text-xs font-mono">UNRESTRICTED AI MODEL</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="Close AI">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-grow flex justify-center overflow-hidden bg-gray-950">
            <div class="w-full max-w-3xl flex flex-col h-full">
                
                <!-- Messages Container -->
                <div id="chat-messages" class="flex-grow overflow-y-auto p-6 flex flex-col gap-4">
                    <!-- Bot Welcome -->
                    <div class="chat-msg msg-bot shadow-md">
                        <div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div>
                        Hello! I am a fully functional AI assistant. I can see images and answer questions.<br><br>Upload an image or ask me anything!
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-6 border-t border-gray-800 bg-gray-900">
                    
                    <!-- Image Preview -->
                    <div id="image-preview" class="hidden mb-3 relative inline-block">
                        <img id="preview-img" src="" class="h-20 w-auto rounded-lg border border-indigo-500 shadow-lg">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Input Group -->
                    <div class="relative flex items-center bg-gray-800 rounded-xl border border-gray-700 shadow-inner focus-within:ring-2 focus-within:ring-indigo-600 transition-all">
                        
                        <!-- File Input (Hidden) -->
                        <input type="file" id="chat-file" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        
                        <!-- Upload Button -->
                        <button onclick="document.getElementById('chat-file').click()" class="pl-4 pr-2 text-gray-400 hover:text-indigo-400 transition-colors" title="Upload Image">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>

                        <input type="text" id="chat-input" placeholder="Ask anything... (Ctrl+V to paste images)" 
                            class="w-full bg-transparent text-white pl-2 pr-12 py-4 focus:outline-none"
                            onkeypress="handleChatKey(event)">
                        
                        <button id="send-btn" onclick="sendChatMessage()" class="absolute right-2 top-2 bottom-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 transition-all transform hover:scale-105">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-center text-gray-600 text-xs mt-3">Powered by Pollinations AI (GPT-4o-mini). Supports Vision.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Window Overlay -->
    <div id="game-modal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex flex-col opacity-0 transition-opacity duration-300">
        <div class="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <h3 id="modal-title" class="text-white font-semibold ml-2">Game Title</h3>
                <span id="game-loading" class="hidden text-xs text-indigo-400 animate-pulse ml-2 flex items-center"><i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="server-btn" onclick="cycleMirror()" class="p-2 text-indigo-400 hover:text-indigo-300 hover:bg-gray-700 rounded-md transition-colors flex items-center gap-1" title="Switch Asset Source"><i class="fas fa-server"></i> <span id="server-label" class="text-xs font-bold">CDN 1</span></button>
                
                <!-- Open in New Tab Button -->
                <button onclick="openInNewTab()" class="p-2 text-blue-400 hover:text-blue-300 hover:bg-gray-700 rounded-md transition-colors" title="Open in New Tab">
                    <i class="fas fa-external-link-alt"></i>
                </button>

                <div class="h-6 w-px bg-gray-700 mx-1"></div>
                <button onclick="toggleFullscreen()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-colors" title="Fullscreen"><i class="fas fa-expand"></i></button>
                <button onclick="closeGame()" class="p-2 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded-md transition-colors ml-2" title="Close"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="iframe-wrapper" class="flex-grow relative bg-black w-full h-full">
            <iframe id="game-frame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-modals"></iframe>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SOURCES = [
            { owner: 'JasenC4PlaysOfficial', repo: 'Html-Games', path: 'games', branch: 'main', type: 'jasen' },
            { owner: 'he-is-talha', repo: 'html-css-javascript-games', path: '', branch: 'main', type: 'talha' }
        ];
        
        const MIRROR_TEMPLATES = [
            { name: "CDN 1", url: (owner, repo, branch) => `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/` },
            { name: "PAGES", url: (owner, repo, branch) => `https://${owner.toLowerCase()}.github.io/${repo}/` },
            { name: "STAT", url: (owner, repo, branch) => `https://cdn.statically.io/gh/${owner}/${repo}/${branch}/` }
        ];

        // State
        let allGames = [];
        let currentGame = null;
        let currentMirrorIndex = 0;
        let isChatOpen = false;
        let isSettingsOpen = false;
        let sourceFilter = 'all';
        let currentImageFile = null;
        let currentGameHTML = ""; // Store processed HTML for new tab

        // DOM Elements
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const gamesGrid = document.getElementById('games-grid');
        const searchBar = document.getElementById('search-bar');
        const modal = document.getElementById('game-modal');
        let gameFrame = document.getElementById('game-frame');
        const modalTitle = document.getElementById('modal-title');
        const gameLoadingIndicator = document.getElementById('game-loading');
        const iframeWrapper = document.getElementById('iframe-wrapper');
        const serverBtn = document.getElementById('server-btn');
        const serverLabel = document.getElementById('server-label');
        
        const aiModal = document.getElementById('ai-modal');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const settingsModal = document.getElementById('settings-modal');

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', fetchGames);

        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredGames = allGames.filter(game => 
                (sourceFilter === 'all' || game.sourceType === sourceFilter) &&
                game.name.toLowerCase().includes(query)
            );
            renderGames(filteredGames);
        });

        // --- Paste Handler for Chat ---
        chatInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    processImageFile(blob);
                    e.preventDefault(); 
                }
            }
        });

        // --- Core Logic ---

        async function fetchGames() {
            if (!loader || !errorDiv || !gamesGrid) {
                console.warn("DOM elements not ready yet.");
                return;
            }

            loader.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            gamesGrid.classList.add('hidden');
            gamesGrid.innerHTML = '';
            
            allGames = []; 

            try {
                await Promise.all(SOURCES.map(source => fetchFromSource(source)));

                if (allGames.length === 0) throw new Error("No HTML games found in any repository.");

                allGames.sort((a, b) => a.name.localeCompare(b.name));
                
                filterSource(sourceFilter); 
                
                loader.classList.add('hidden');
                gamesGrid.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loader.classList.add('hidden');
                errorText.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function fetchFromSource(source) {
            const apiUrl = `https://api.github.com/repos/${source.owner}/${source.repo}/git/trees/${source.branch}?recursive=1`;
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) return;
                const data = await response.json();
                
                // Create a Set of all file paths to quickly check for icons
                const filePaths = new Set(data.tree.map(item => item.path));
                
                const gamesMap = new Map();
                data.tree.forEach(item => {
                    const isInPath = source.path === '' ? true : item.path.startsWith(`${source.path}/`);
                    
                    if (isInPath && item.path.endsWith('.html')) {
                        const parts = item.path.split('/');
                        const minDepth = source.path === '' ? 2 : 3;
                        
                        if (parts.length >= minDepth) {
                            const folderIndex = source.path === '' ? 0 : 1;
                            const gameFolder = parts[folderIndex];
                            
                            // Reconstruct the full path to the folder
                            const folderPath = source.path === '' ? gameFolder : `${source.path}/${gameFolder}`;
                            
                            const fileName = parts.slice(folderIndex + 1).join('/'); 
                            
                            // Check for Icon existence
                            let iconPath = null;
                            if (filePaths.has(`${folderPath}/icon.png`)) iconPath = `${folderPath}/icon.png`;
                            else if (filePaths.has(`${folderPath}/icon.jpg`)) iconPath = `${folderPath}/icon.jpg`;
                            else if (filePaths.has(`${folderPath}/logo.png`)) iconPath = `${folderPath}/logo.png`;
                            
                            if (gamesMap.has(gameFolder)) {
                                // Prefer index.html if we found another html before
                                if (fileName.toLowerCase() === 'index.html') {
                                    gamesMap.set(gameFolder, { path: item.path, sha: item.sha, icon: iconPath });
                                }
                            } else {
                                gamesMap.set(gameFolder, { path: item.path, sha: item.sha, icon: iconPath });
                            }
                        }
                    }
                });

                const sourceGames = Array.from(gamesMap, ([folderName, data]) => ({
                    name: formatGameName(folderName, source.type),
                    rawName: folderName,
                    fullPath: data.path,
                    sha: data.sha,
                    iconPath: data.icon, // Store relative path to icon
                    owner: source.owner,
                    repo: source.repo,
                    branch: source.branch,
                    sourceType: source.type
                }));
                
                allGames.push(...sourceGames);

            } catch (e) {
                console.error(`Error loading source ${source.repo}`, e);
            }
        }

        function filterSource(type) {
            sourceFilter = type;
            
            document.getElementById('filter-all').className = `px-4 py-2 text-sm font-medium rounded-md transition-colors ${type === 'all' ? 'text-white bg-indigo-600 shadow' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`;
            document.getElementById('filter-jasen').className = `px-4 py-2 text-sm font-medium rounded-md transition-colors ${type === 'jasen' ? 'text-white bg-indigo-600 shadow' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`;
            document.getElementById('filter-talha').className = `px-4 py-2 text-sm font-medium rounded-md transition-colors ${type === 'talha' ? 'text-white bg-indigo-600 shadow' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`;

            const query = searchBar.value.toLowerCase();
            const filtered = allGames.filter(game => 
                (type === 'all' || game.sourceType === type) &&
                game.name.toLowerCase().includes(query)
            );
            renderGames(filtered);
        }

        function renderGames(games) {
            gamesGrid.innerHTML = '';
            if (games.length === 0) {
                gamesGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10"><p>No games found matching criteria.</p></div>`;
                return;
            }
            games.forEach((game, index) => {
                const hue = (game.name.length * 25) % 360;
                const initials = game.name.substring(0, 2).toUpperCase();
                
                // Determine Icon URL
                const iconUrl = game.iconPath ? 
                    MIRROR_TEMPLATES[0].url(game.owner, game.repo, game.branch) + game.iconPath : 
                    null;

                const card = document.createElement('div');
                card.className = 'game-card bg-gray-800 rounded-xl overflow-hidden border border-gray-700 cursor-pointer animate-slide-up flex flex-col h-full';
                card.style.animationDelay = `${Math.min(index * 0.05, 1.0)}s`;
                
                // Visual Content: Image OR HTML Preview (Iframe)
                let visualContent;
                if (iconUrl) {
                    visualContent = `
                        <div class="h-40 w-full relative bg-gray-900 group">
                            <img src="${iconUrl}" alt="${game.name}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
                                <div class="bg-indigo-600 rounded-full p-3 transform scale-0 group-hover:scale-100 transition-transform duration-300 shadow-lg"><i class="fas fa-play text-white"></i></div>
                            </div>
                        </div>`;
                } else {
                    // Use HTMLPreview to force rendering of the HTML file
                    // This bypasses strict MIME type checks that cause 'white screen' on some mirrors
                    const githubBlobUrl = `https://github.com/${game.owner}/${game.repo}/blob/${game.branch}/${game.fullPath}`;
                    const previewUrl = `https://htmlpreview.github.io/?${githubBlobUrl}`;
                    
                    visualContent = `
                        <div class="h-40 w-full relative bg-gray-100 group overflow-hidden">
                            <iframe 
                                src="${previewUrl}" 
                                class="absolute top-0 left-0 w-[400%] h-[400%] transform origin-top-left scale-[0.25] pointer-events-none border-0"
                                scrolling="no"
                                loading="lazy"
                                sandbox="allow-scripts allow-same-origin"
                                tabindex="-1"
                            ></iframe>
                            <!-- Overlay to prevent interaction and handle hover -->
                            <div class="absolute inset-0 bg-transparent z-10 group-hover:bg-black group-hover:bg-opacity-10 transition-all duration-300 flex items-center justify-center">
                                <div class="bg-indigo-600 rounded-full p-3 transform scale-0 group-hover:scale-100 transition-transform duration-300 shadow-lg">
                                    <i class="fas fa-play text-white"></i>
                                </div>
                            </div>
                        </div>`;
                }

                card.innerHTML = `
                    ${visualContent}
                    <div class="p-4 flex-grow">
                        <h3 class="text-white font-bold text-lg truncate" title="${game.name}">${game.name}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs font-mono text-gray-500">${game.sourceType === 'jasen' ? 'Jasen' : 'Talha'}</span>
                            <span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded">HTML5</span>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openGame(game));
                gamesGrid.appendChild(card);
            });
        }

        function formatGameName(folderName, type) {
            if (type === 'talha') {
                return folderName.replace(/^\d{2}-/, '').replace(/-Game$/i, '');
            } else {
                return folderName.replace(/-/g, ' ').replace(/([A-Z])/g, ' $1').trim();
            }
        }

        // --- More Games Feature ---
        function openMoreGames() {
            fetch("https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/autoupdate.html?t="+Date.now())
            .then(response => response.text())
            .then(text => {
                const newWin = window.open("about:blank", "_blank");
                if (newWin) {
                    newWin.document.open();
                    newWin.document.write(text);
                    newWin.document.close();
                }
            })
            .catch(err => alert("Could not load More Games."));
        }

        // --- Tab Cloak / Settings ---
        function toggleSettings() {
            isSettingsOpen = !isSettingsOpen;
            if (isSettingsOpen) {
                settingsModal.classList.remove('hidden');
                setTimeout(() => settingsModal.classList.remove('opacity-0'), 10);
            } else {
                settingsModal.classList.add('opacity-0');
                setTimeout(() => settingsModal.classList.add('hidden'), 300);
            }
        }

        function applyCloakManual() {
            const title = document.getElementById('cloak-title').value;
            const icon = document.getElementById('cloak-icon').value;
            setCloak(title, icon);
            toggleSettings();
        }

        function applyPreset(title, icon) {
            document.getElementById('cloak-title').value = title;
            document.getElementById('cloak-icon').value = icon;
            setCloak(title, icon);
            toggleSettings();
        }

        function resetCloak() {
            document.title = "Math Games";
            const link = document.querySelector("link[rel*='icon']");
            link.href = "https://www.google.com/favicon.ico"; // Default fallback
            document.getElementById('cloak-title').value = "";
            document.getElementById('cloak-icon').value = "";
        }

        function setCloak(title, icon) {
            if (title) document.title = title;
            if (icon) {
                let link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                link.type = 'image/x-icon';
                link.rel = 'shortcut icon';
                link.href = icon;
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        }

        // --- Chat Bot Logic ---
        let chatHistory = [
            { role: 'system', content: 'You are AI Chatbot, a helpful, intelligent assistant. You have VISION capabilities and can see/analyze images uploaded by the user. Use Markdown formatting.' }
        ];

        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                aiModal.classList.remove('hidden');
                setTimeout(() => aiModal.classList.remove('opacity-0'), 10);
                chatInput.focus();
                document.body.style.overflow = 'hidden';
            } else {
                aiModal.classList.add('opacity-0');
                setTimeout(() => aiModal.classList.add('hidden'), 300);
                document.body.style.overflow = '';
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        // --- Image Handling ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Resize image for preview and API efficiency
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // AGGRESSIVE RESIZE: Max 512px to ensure API acceptance
                    const MAX_DIM = 512;
                    if (width > height) {
                        if (width > MAX_DIM) {
                            height *= MAX_DIM / width;
                            width = MAX_DIM;
                        }
                    } else {
                        if (height > MAX_DIM) {
                            width *= MAX_DIM / height;
                            height = MAX_DIM;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // High compression (0.6)
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    document.getElementById('preview-img').src = resizedDataUrl;
                    document.getElementById('image-preview').classList.remove('hidden');
                    
                    currentImageFile = resizedDataUrl; 
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            document.getElementById('chat-file').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('preview-img').src = '';
            currentImageFile = null;
        }

        function addMessage(text, isUser, isHtml = false) {
            const div = document.createElement('div');
            div.className = `chat-msg ${isUser ? 'msg-user' : 'msg-bot'} animate-slide-up`;
            if (!isUser) {
                const header = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div>`;
                div.innerHTML = header + (isHtml ? text : text); 
            } else {
                 if (isHtml) div.innerHTML = text;
                 else div.textContent = text;
            }
            chatMessages.appendChild(div);
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 50);
            return div; 
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'chat-msg msg-bot animate-slide-up';
            div.innerHTML = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div>
                             <span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage() {
            const txt = chatInput.value.trim();
            const imageData = currentImageFile; 

            if (!txt && !imageData) return;

            let displayHtml = txt;
            let apiContent = txt;

            if (imageData) {
                displayHtml = `<div><img src="${imageData}" class="max-h-64 rounded-lg mb-2 border border-gray-600 shadow-md"></div><div class="whitespace-pre-wrap">${txt}</div>`;
                // IMPORTANT: Put Image FIRST in the array for better AI attention
                apiContent = [
                    { type: "image_url", image_url: { url: imageData } },
                    { type: "text", text: txt || "Analyze this image." }
                ];
                clearImage();
            }

            addMessage(displayHtml, true, true);
            chatInput.value = '';
            
            chatHistory.push({ role: 'user', content: apiContent });
            showTypingIndicator();

            // Retry Helper
            const fetchAI = async (model, retries = 2) => {
                try {
                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: chatHistory,
                            model: model, 
                            json: false
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 413) throw new Error("Image too large.");
                        throw new Error(`API Error: ${response.status}`);
                    }
                    return await response.text();
                } catch (err) {
                    if (retries > 0) {
                        console.warn(`AI Busy (${model}), retrying...`);
                        await new Promise(r => setTimeout(r, 1500)); 
                        return fetchAI(model, retries - 1);
                    }
                    throw err;
                }
            };

            try {
                let aiText;
                try {
                    // Use gpt-4o (Standard) for better Vision support than mini
                    aiText = await fetchAI('gpt-4o'); 
                } catch (e) {
                    console.warn("Primary model failed, trying fallback...", e);
                    // If vision fails, strip image from history and retry with text-only
                    if (imageData) {
                         chatHistory.pop(); 
                         chatHistory.push({ role: 'user', content: "[Image Upload Failed - Retrying text only] " + txt });
                    }
                    aiText = await fetchAI('openai');
                }

                removeTypingIndicator();
                
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-msg msg-bot animate-slide-up`;
                msgDiv.innerHTML = `<div class="font-bold text-indigo-400 text-xs mb-1">AI Chatbot</div><div class="content-area"></div>`;
                chatMessages.appendChild(msgDiv);
                
                const contentArea = msgDiv.querySelector('.content-area');
                let currentText = "";
                const chars = aiText.split('');
                let i = 0;

                const typingInterval = setInterval(() => {
                    if (i < chars.length) {
                        currentText += chars[i];
                        contentArea.innerHTML = marked.parse(currentText);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        contentArea.innerHTML = marked.parse(aiText);
                        
                        // For history, keep the full response
                        chatHistory.push({ role: 'assistant', content: aiText });
                        
                        // Optimization: If we just sent an image, replace it in history with a placeholder
                        // to save bandwidth for the NEXT turn.
                        if (imageData && chatHistory.length >= 2) {
                            const lastUserMsg = chatHistory[chatHistory.length - 2];
                            if (Array.isArray(lastUserMsg.content)) {
                                lastUserMsg.content = "[User uploaded an image] " + (txt || "");
                            }
                        }
                    }
                }, 10); 

            } catch (err) {
                console.error("AI Fatal Error:", err);
                removeTypingIndicator();
                addMessage(`I'm having trouble connecting to the server. Please try again.`, false);
            }
        }

        // --- Game Logic ---

        function getActiveMirrorUrl(game) {
            const template = MIRROR_TEMPLATES[currentMirrorIndex];
            return template.url(game.owner, game.repo, game.branch) + game.fullPath;
        }

        function cycleMirror() {
            if (!currentGame) return;
            currentMirrorIndex = (currentMirrorIndex + 1) % MIRROR_TEMPLATES.length;
            serverLabel.textContent = MIRROR_TEMPLATES[currentMirrorIndex].name;
            loadGameContent(currentGame);
        }

        async function openGame(game) {
            currentGame = game;
            modalTitle.textContent = game.name;
            gameFrame.src = 'about:blank';
            gameFrame.removeAttribute('srcdoc');
            currentGameHTML = ""; // Reset
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden';
            await loadGameContent(game);
        }

        async function loadGameContent(game) {
            gameLoadingIndicator.classList.remove('hidden');
            
            try {
                let htmlCode = "";
                const cdnUrl = `https://cdn.jsdelivr.net/gh/${game.owner}/${game.repo}@${game.branch}/${game.fullPath}`;
                
                try {
                    const response = await fetch(cdnUrl);
                    if (!response.ok) throw new Error("CDN Fetch Failed");
                    htmlCode = await response.text();
                } catch (e) {
                    console.warn("CDN blocked, falling back to GitHub API...", e);
                    const apiUrl = `https://api.github.com/repos/${game.owner}/${game.repo}/git/blobs/${game.sha}`;
                    const apiResp = await fetch(apiUrl);
                    if (!apiResp.ok) throw new Error("API Fetch Failed: " + apiResp.status);
                    const apiData = await apiResp.json();
                    htmlCode = atob(apiData.content); 
                }

                const mirrorUrl = getActiveMirrorUrl(game);
                const assetBaseDir = mirrorUrl.substring(0, mirrorUrl.lastIndexOf('/') + 1);

                const baseTagRegex = /<base\s+href=["']([^"']+)["'][^>]*>/i;
                const match = htmlCode.match(baseTagRegex);
                let effectiveBase = assetBaseDir;

                if (match) {
                    effectiveBase = match[1];
                } else {
                    const newBaseTag = `<base href="${assetBaseDir}">`;
                    if (htmlCode.includes('<head>')) {
                        htmlCode = htmlCode.replace('<head>', '<head>' + newBaseTag);
                    } else {
                        htmlCode = newBaseTag + htmlCode;
                    }
                }

                // Detect Unity/Emscripten Games
                const isUnity = /UnityLoader|UnityProgress|Build\/|fnae|framework\.js|wasm/i.test(htmlCode);

                const networkPatch = `
                <script>
                    (function() {
                        const BASE_URL = "${effectiveBase}";
                        console.log("Patch Active. Unity Mode: ${isUnity}");

                        // --- MOCK STORAGE ---
                        // Prevents security errors in iframe
                        class MockStorage {
                            constructor() { this.store = {}; }
                            getItem(key) { return this.store[key] || null; }
                            setItem(key, value) { this.store[key] = String(value); }
                            removeItem(key) { delete this.store[key]; }
                            clear() { this.store = {}; }
                            get length() { return Object.keys(this.store).length; }
                            key(n) { return Object.keys(this.store)[n]; }
                        }
                        try {
                            // Only mock if native is restricted
                            if (!window.localStorage) {
                                Object.defineProperty(window, 'localStorage', { value: new MockStorage() });
                                Object.defineProperty(window, 'sessionStorage', { value: new MockStorage() });
                            }
                        } catch(e) {}

                        // --- UNITY SPECIFIC FIX ---
                        // Only nuke IndexedDB for Unity games (prevents iframe freeze)
                        // Standard games (Three.js/Crossy Road) might need IDB, so we leave it alone for them.
                        if (${isUnity}) {
                            try {
                                window.indexedDB = null;
                                window.mozIndexedDB = null;
                                window.webkitIndexedDB = null;
                                window.msIndexedDB = null;
                                console.log("Unity IDB Disabled");
                            } catch(e) {}
                        }

                        // --- NETWORK INTERCEPTOR ---
                        // Forces relative paths to use the CDN Base URL
                        const originalFetch = window.fetch;
                        window.fetch = function(input, init) {
                            if (typeof input === "string" && !input.match(/^https?:/i) && !input.startsWith("//") && !input.startsWith("blob:") && !input.startsWith("data:")) {
                                const cleanPath = input.startsWith("/") ? input.substring(1) : input;
                                input = BASE_URL + cleanPath;
                            }
                            return originalFetch(input, init);
                        };

                        const originalOpen = XMLHttpRequest.prototype.open;
                        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
                            if (typeof url === "string" && !url.match(/^https?:/i) && !url.startsWith("//") && !url.startsWith("blob:") && !url.startsWith("data:")) {
                                const cleanPath = url.startsWith("/") ? url.substring(1) : url;
                                url = BASE_URL + cleanPath;
                            }
                            return originalOpen.apply(this, arguments);
                        };
                    })();
                <\/script>`;

                if (htmlCode.includes('<head>')) {
                    htmlCode = htmlCode.replace('<head>', '<head>' + networkPatch);
                } else {
                    htmlCode = networkPatch + htmlCode;
                }

                currentGameHTML = htmlCode; // Store for New Tab
                gameFrame.srcdoc = htmlCode;

            } catch (err) {
                console.error("Critical Load Failure:", err);
                gameFrame.removeAttribute('srcdoc');
                currentGameHTML = ""; // Clear if failed
                gameFrame.src = `https://${game.owner.toLowerCase()}.github.io/${game.repo}/${game.fullPath}`;
            } finally {
                setTimeout(() => gameLoadingIndicator.classList.add('hidden'), 1000);
            }
        }

        function openInNewTab() {
            if (!currentGame) return;
            
            // Check if we are in fallback mode (direct src) or embed mode
            const isDirectFallback = !gameFrame.srcdoc && gameFrame.src && gameFrame.src !== 'about:blank';

            const newWin = window.open('about:blank', '_blank');
            if (!newWin) {
                alert("Pop-up blocked! Please allow pop-ups for this site to open the game in a new tab.");
                return;
            }

            if (isDirectFallback) {
                newWin.location.href = gameFrame.src;
            } else if (currentGameHTML) {
                newWin.document.open();
                newWin.document.write(currentGameHTML);
                newWin.document.close();
            } else {
                newWin.close();
                alert("Game is still loading, please wait...");
            }
        }

        function closeGame() {
            try { if (gameFrame.contentWindow) gameFrame.contentWindow.onbeforeunload = null; } catch (e) { }
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                const newFrame = document.createElement('iframe');
                newFrame.id = 'game-frame';
                newFrame.className = 'w-full h-full border-0';
                newFrame.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-modals');
                if (gameFrame.parentNode) gameFrame.parentNode.replaceChild(newFrame, gameFrame);
                gameFrame = newFrame;
                currentGame = null;
                exitFullscreen();
            }, 300);
            document.body.style.overflow = '';
        }

        function toggleFullscreen() {
            const elem = iframeWrapper;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.fullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!modal.classList.contains('hidden')) closeGame();
                if (!aiModal.classList.contains('hidden')) toggleChat();
                if (!settingsModal.classList.contains('hidden')) toggleSettings();
            }
        });
        window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = ''; });
    </script>
</body>
</html>