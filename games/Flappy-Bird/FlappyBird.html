<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird Pro - NES Edition</title>
    <style>
        @font-face {
            font-family: 'FlappyFont';
            src: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/fonts/04B_19__.TTF') format('truetype');
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            font-family: 'FlappyFont', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
        }

        #game-container {
            position: relative;
            background-color: #70c5ce;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* --- UI BUTTONS --- */
        .game-btn {
            position: absolute;
            bottom: 5vh; 
            background: #E57338;
            border: 2px solid #FFF;
            color: white;
            padding: 10px 20px;
            font-family: 'FlappyFont', sans-serif;
            font-size: 3vh; 
            cursor: pointer;
            text-shadow: 2px 2px 0 #000;
            box-shadow: 0 4px 0 #9e4f24;
            text-transform: uppercase;
            z-index: 10;
            white-space: nowrap;
            display: none; 
            min-width: 120px;
            text-align: center;
        }
        
        .game-btn:active, .game-btn.active-press { transform: translateY(4px); box-shadow: none; }
        .game-btn.focused, .shop-item.focused, .setting-row.focused, .close-x.focused {
            border-color: #FFD700; box-shadow: 0 0 15px #FFD700; transform: scale(1.05); z-index: 20;
        }

        #shopTriggerBtn { left: 5vw; }
        #startTriggerBtn { left: 50%; transform: translateX(-50%); background: #73BF2E; box-shadow: 0 4px 0 #4d851e; }
        #settingsTriggerBtn { right: 5vw; background: #4ec0ca; box-shadow: 0 4px 0 #2e8b94; }

        /* Modals */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: flex-start;
            color: white; padding-top: 5vh; box-sizing: border-box;
        }
        .modal h2 { margin: 0 0 2vh 0; font-size: 5vh; color: #FFD700; text-shadow: 2px 2px 0 #000; }
        .close-x {
            position: absolute; top: 2vh; right: 2vh; background: #d32f2f;
            border: 2px solid #FFF; color: white; font-family: 'FlappyFont', sans-serif;
            font-size: 3vh; width: 5vh; height: 5vh; display: flex; align-items: center;
            justify-content: center; cursor: pointer; box-shadow: 0 4px 0 #8b0000;
        }
        .close-x:active { transform: translateY(2px); box-shadow: none; }
        .coin-display { font-size: 3vh; margin-bottom: 2vh; color: #FFF; }
        .shop-items { display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; gap: 10px; width: 90%; height: 70%; overflow-y: auto; padding: 5px; }
        .shop-item { background: #4ec0ca; border: 2px solid #fff; padding: 5px; width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 3px 3px 0 #000; flex-shrink: 0; }
        .shop-item.locked { filter: grayscale(1); opacity: 0.6; }
        .shop-item.selected { border-color: #FFD700; background: #fff; color: #333; }
        .shop-item img { width: 50px; margin-bottom: 5px; object-fit: contain; image-rendering: pixelated; }
        .item-cost { font-size: 16px; text-align: center; }
        .setting-row { margin: 20px 0; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 10px; border: 2px solid transparent; }
        .setting-label { font-size: 24px; margin-bottom: 10px; color: #EEE; }
        select, .toggle-btn { font-family: 'FlappyFont', sans-serif; font-size: 20px; padding: 10px; border-radius: 5px; border: 2px solid #FFF; background: #E57338; color: white; cursor: pointer; width: 200px; text-align: center; }
        .toggle-btn { background: #73BF2E; }
        .toggle-btn.off { background: #d32f2f; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #70c5ce; z-index: 200; display: flex; justify-content: center; align-items: center; color: white; font-size: 30px; text-shadow: 2px 2px 0 #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="loading-overlay">LOADING...</div>
    <button id="shopTriggerBtn" class="game-btn" data-nav="menu" data-index="0">SHOP</button>
    <button id="startTriggerBtn" class="game-btn" data-nav="menu" data-index="1">START</button>
    <button id="settingsTriggerBtn" class="game-btn" data-nav="menu" data-index="2">SETTINGS</button>

    <div id="shop-modal" class="modal">
        <button id="closeShopX" class="close-x" data-nav="shop_close">X</button>
        <h2>SKIN SHOP</h2>
        <div class="coin-display">COINS: <span id="shopCoinCount">0</span></div>
        <div class="shop-items" id="shopItemsContainer"></div>
    </div>

    <div id="settings-modal" class="modal">
        <button id="closeSettingsX" class="close-x" data-nav="settings_close">X</button>
        <h2>SETTINGS</h2>
        <div class="setting-row" id="setting-res-row" data-nav="settings" data-index="0"><div class="setting-label">RESOLUTION</div><select id="resolutionSelect" tabindex="-1"><option value="retro">Performance</option><option value="native">Native</option><option value="720">720p</option><option value="1080">1080p</option></select></div>
        <div class="setting-row" id="setting-fs-row" data-nav="settings" data-index="1"><div class="setting-label">FULLSCREEN</div><button id="fullscreenToggle" class="toggle-btn off" tabindex="-1">OFF</button></div>
    </div>
</div>

<script>
    // --- 1. Audio Engine ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const soundBuffers = {};
    let audioResumed = false;
    let bgmSource = null;

    async function resumeAudio() {
        if (!audioResumed && audioCtx) {
            try { await audioCtx.resume(); audioResumed = true; } catch (e) {}
        }
    }
    window.addEventListener('keydown', resumeAudio, { once: true });
    window.addEventListener('pointerdown', resumeAudio, { once: true });

    async function loadSound(url, key) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
        } catch(e) {}
    }

    function playSound(name, loop = false) {
        if (!audioResumed) resumeAudio(); 
        let key = name;
        if (userData.equippedSkin === 'amongus') {
            if (name === 'point') key = 'au_point'; else if (name === 'hit' || name === 'die') key = 'au_kill';
        } else if (userData.equippedSkin === 'bigo') {
            if (name === 'flap') key = 'bigo_flap'; else if (name === 'chomp') key = 'bigo_chomp'; 
        } else if (userData.equippedSkin === 'mario') {
            if (name === 'flap') key = 'mario_jump'; else if (name === 'die') key = 'mario_die'; else if (name === 'hit') key = 'mario_stomp'; else if (name === 'coin') key = 'mario_coin';
            else if (name === 'break') key = 'mario_break';
        }
        const buffer = soundBuffers[key];
        if (buffer) {
            const src = audioCtx.createBufferSource();
            src.buffer = buffer; src.loop = loop; src.connect(audioCtx.destination); src.start(0); return src;
        }
        return null;
    }

    function stopBGM() { if (bgmSource) { try { bgmSource.stop(); } catch(e){} bgmSource = null; } }
    function startBGM() { stopBGM(); if (userData.equippedSkin === 'mario') { bgmSource = playSound('mario_bgm', true); } }

    // --- 2. Assets ---
    const ASSETS = {
        sprites: {
            bg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png",
            base: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/base.png",
            pipe: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png",
            msg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/message.png",
            gameover: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/gameover.png",
            birdYellow: [ "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-downflap.png", "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png", "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-upflap.png" ]
        },
        audio: {
            flap: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/wing.wav",
            point: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/point.wav",
            hit: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/hit.wav",
            die: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/die.wav",
            coin: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/swoosh.wav",
            au_point: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Task%20Complete.mp3",
            au_kill: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Impostor%20Kill.mp3",
            bigo_flap: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Stomp.mp3",
            bigo_chomp: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Chomp.mp3",
            mario_jump: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/jump-small.wav",
            mario_die: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/mariodie.wav",
            mario_bgm: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/aboveground_bgm.ogg",
            mario_stomp: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/kick.wav",
            mario_coin: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/coin.wav",
            mario_break: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/breakblock.wav"
        }
    };

    // --- 3. Asset Generators ---
    function drawRoundRect(ctx, x, y, w, h, r) {
        ctx.beginPath(); ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y); ctx.quadraticCurveTo(x+w, y, x+w, y+r);
        ctx.lineTo(x+w, y+h-r); ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h);
        ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath();
    }

    function createAmongUsAsset(type) {
        const cvs = document.createElement('canvas'); cvs.width = 34; cvs.height = 24; const cx = cvs.getContext('2d');
        const color = '#C51111'; const visor = '#9ECEF5';
        if (type === 'dead') {
            cx.fillStyle='#DDD'; cx.fillRect(14,8,6,8); cx.beginPath(); cx.arc(14,8,3,0,Math.PI*2); cx.fill(); cx.beginPath(); cx.arc(20,8,3,0,Math.PI*2); cx.fill();
            cx.fillStyle=color; cx.beginPath(); cx.moveTo(6,16); cx.lineTo(28,16); cx.lineTo(28,20); cx.quadraticCurveTo(28,24,24,24); cx.lineTo(10,24); cx.quadraticCurveTo(6,24,6,20); cx.fill(); cx.stroke();
        } else {
            cx.fillStyle=color; drawRoundRect(cx, 0,6,10,14,2); cx.fill(); cx.stroke();
            cx.beginPath(); drawRoundRect(cx, 6,2,22,22,8); cx.fill(); cx.stroke();
            cx.fillStyle=visor; cx.beginPath(); cx.ellipse(22,9,8,5,0,0,Math.PI*2); cx.fill(); cx.stroke();
            cx.fillStyle='#FFF'; cx.beginPath(); cx.ellipse(20,7,4,2,0,0,Math.PI*2); cx.fill();
        }
        return cvs;
    }

    function createBigOAsset() { const cvs = document.createElement('canvas'); cvs.width = 44; cvs.height = 34; const cx = cvs.getContext('2d'); cx.fillStyle='#F5CBA7'; cx.beginPath(); cx.arc(22,17,16,0,Math.PI*2); cx.fill(); cx.fillStyle='#2980B9'; cx.beginPath(); cx.arc(22,28,16,Math.PI,0); cx.fill(); cx.fillStyle='#4A235A'; cx.beginPath(); cx.arc(22,17,16,0.2,2.9); cx.lineTo(22,22); cx.fill(); cx.fillStyle='#000'; cx.beginPath(); cx.arc(16,14,2,0,Math.PI*2); cx.fill(); cx.beginPath(); cx.arc(28,14,2,0,Math.PI*2); cx.fill(); cx.strokeStyle='#000'; cx.lineWidth=2; cx.beginPath(); cx.arc(22,17,16,0,Math.PI*2); cx.stroke(); return cvs; }
    function createGDAsset() { const cvs = document.createElement('canvas'); cvs.width=30; cvs.height=30; const cx=cvs.getContext('2d'); cx.fillStyle = '#FFD700'; cx.fillRect(0,0,30,30); cx.fillStyle = '#000'; cx.fillRect(6,6,6,6); cx.fillRect(18,6,6,6); cx.fillRect(6,18,18,4); cx.strokeStyle = '#000'; cx.lineWidth = 2; cx.strokeRect(1,1,28,28); return cvs; }
    function createBurgerAsset() { const cvs = document.createElement('canvas'); cvs.width=24; cvs.height=20; const cx=cvs.getContext('2d'); cx.fillStyle='#E67E22'; cx.fillRect(2,14,20,4); cx.fillStyle='#2ECC71'; cx.fillRect(1,12,22,2); cx.fillStyle='#6E2C00'; cx.fillRect(2,8,20,4); cx.fillStyle='#E67E22'; cx.beginPath(); cx.arc(12,8,10,Math.PI,0); cx.fill(); cx.fillStyle='#F5B7B1'; cx.fillRect(8,2,2,2); cx.fillRect(14,3,2,2); cx.fillRect(11,5,2,2); cx.strokeStyle='#000'; cx.lineWidth=1; cx.strokeRect(2,14,20,4); return cvs; }
    function createSpaceBg() { const cvs = document.createElement('canvas'); cvs.width=320; cvs.height=480; const cx=cvs.getContext('2d'); cx.fillStyle='#050510'; cx.fillRect(0,0,320,480); cx.fillStyle='#FFF'; for(let i=0; i<100; i++) { cx.globalAlpha=Math.random(); cx.fillRect(Math.random()*320, Math.random()*480, 1, 1); } cx.globalAlpha=1.0; return cvs; }
    function createSantaAsset() { const cvs = document.createElement('canvas'); cvs.width = 48; cvs.height = 30; const cx = cvs.getContext('2d'); cx.fillStyle='#8B0000'; cx.beginPath(); cx.moveTo(10,20); cx.lineTo(35,20); cx.lineTo(38,15); cx.lineTo(8,15); cx.fill(); cx.strokeStyle='#C0C0C0'; cx.lineWidth=2; cx.beginPath(); cx.moveTo(5,25); cx.lineTo(40,25); cx.quadraticCurveTo(45,20,42,15); cx.stroke(); cx.fillStyle='#2E8B57'; cx.beginPath(); cx.arc(15,12,8,0,Math.PI*2); cx.fill(); cx.fillStyle='#D32F2F'; cx.beginPath(); cx.arc(28,14,6,0,Math.PI*2); cx.fill(); cx.fillStyle='#FFCCBC'; cx.beginPath(); cx.arc(28,8,4,0,Math.PI*2); cx.fill(); cx.fillStyle='#FFF'; cx.beginPath(); cx.arc(28,10,4,0,Math.PI,false); cx.fill(); cx.fillStyle='#D32F2F'; cx.beginPath(); cx.moveTo(24,6); cx.lineTo(32,6); cx.lineTo(28,0); cx.fill(); return cvs; }
    function createChimneyAsset() { const cvs = document.createElement('canvas'); cvs.width=52; cvs.height=320; const cx=cvs.getContext('2d'); cx.fillStyle='#8D6E63'; cx.fillRect(0,0,52,320); cx.fillStyle='#5D4037'; for(let y=0; y<320; y+=20) { cx.fillRect(0,y,52,2); for(let x=(y%40===0?0:26); x<52; x+=52) cx.fillRect(x,y,2,20); } cx.strokeStyle='#3E2723'; cx.lineWidth=4; cx.strokeRect(0,0,52,320); return cvs; }

    // --- AUTHENTIC MARIO ASSETS (Using Sprite Maps) ---
    function drawSpriteMap(ctx, map, palette) {
        for (let y = 0; y < map.length; y++) {
            for (let x = 0; x < map[y].length; x++) {
                const char = map[y][x];
                if (palette[char]) { ctx.fillStyle = palette[char]; ctx.fillRect(x, y, 1, 1); }
            }
        }
    }

    const marioPalette = { 'R': '#D72C16', 'B': '#955529', 'S': '#F8C685', 'K': '#000' };
    function createMarioSprite(type) {
        const cvs = document.createElement('canvas'); cvs.width = 16; cvs.height = 16; const cx = cvs.getContext('2d');
        let map = [];
        let idle = [".....RRRRR......","....RRRRRRRRR...","....BBBSSB......","...BBSBSSSB.....","...BBSBSSSB.....","...BBSBSSSB.....","....BBSSSS......",".......BB.......",".....RRRBRR.....","....RRRRRRRR....","....RRRRRRRR....","....BBBBR.......","...SSRR.........","..SSSS..........","..SSSS..........","................"];
        if(type==='walk') {
            map = [".....RRRRR......","....RRRRRRRRR...","....BBBSSB......","...BBSBSSSB.....","...BBSBSSSB.....","...BBSBSSSB.....","....BBSSSS......",".......BB.......",".....RRRBRR.....","....RRRRRRRR....","....RRRRRRRR....",".....BBBBR......","....SSRR........","...SSSS.........","..........BBB...",".........BBBB..."];
        } else if(type==='jump') {
            map = [".....RRRRR......","....RRRRRRRRR...","....BBBSSB......","...BBSBSSSB.....","...BBSBSSSB.....","...BBSBSSSB.....","....BBSSSS......",".......BB.......",".....RRRBRR.....","....RRRRRRRR....","....RRRRRRRR....","....BBB.R.......","...SS...R.......","..SSS..RR.......","......SSSS......","......SSSS......"];
        } else if(type==='dead') {
            map = [".....RRRRR......","....RRRRRRRRR...","....BBBSSB......","...BBSBSSSB.....","...BBSBSSSB.....","...BBSBSSSB.....","....BBSSSS......",".......BB.......",".....RRRBRR.....","....RRRRRRRR....","....RRRRRRRR....","....BBBBBB......","....SS..SS......","...SSS..SSS.....","...SSS..SSS.....","................"];
        } else { map = idle; }
        drawSpriteMap(cx, map, marioPalette); return cvs;
    }

    function createGoombaSprite(frame) {
        const cvs = document.createElement('canvas'); cvs.width = 16; cvs.height = 16; const cx = cvs.getContext('2d');
        const p = {'B': '#C84C0C', 'K': '#000', 'W': '#FFF'};
        let map = (frame===0) ? 
            ["................","........BBBB....",".......BBBBBB...","......BBBBBBBB..","......BBBBBBBB..",".....KKBBBBBBKK.",".....KWWBBBBWWK.",".....KWKBBBBKWK.",".....KWKBBBBKWK.",".....BBBBBBBBBB.","......BBBBBBBB..",".......BBBBBB...",".......KK..KK...","......KKK..KKK..","......KKK..KKK..","................"] :
            ["................","........BBBB....",".......BBBBBB...","......BBBBBBBB..","......BBBBBBBB..",".....KKBBBBBBKK.",".....KWWBBBBWWK.",".....KWKBBBBKWK.",".....KWKBBBBKWK.",".....BBBBBBBBBB.","......BBBBBBBB..",".......BBBBBB...",".......KK..KK...",".......KK..KK...",".......KK..KK...","................"];
        drawSpriteMap(cx, map, p); return cvs;
    }

    function createBrickSprite() {
        const cvs = document.createElement('canvas'); cvs.width = 16; cvs.height = 16; const cx = cvs.getContext('2d');
        let map = ["BBBKKBBBBBBBBKBB","BBBKKBBBBBBBBKBB","BBBKKBBBBBBBBKBB","KKKKKKKKKKKKKKKK","BBKBBBBBBBBKBBBB","BBKBBBBBBBBKBBBB","BBKBBBBBBBBKBBBB","KKKKKKKKKKKKKKKK","BBBKKBBBBBBBBKBB","BBBKKBBBBBBBBKBB","BBBKKBBBBBBBBKBB","KKKKKKKKKKKKKKKK","BBKBBBBBBBBKBBBB","BBKBBBBBBBBKBBBB","BBKBBBBBBBBKBBBB","KKKKKKKKKKKKKKKK"];
        drawSpriteMap(cx, map, {'B': '#B85000', 'K': '#000'}); return cvs;
    }

    function createGroundSprite() {
        const cvs = document.createElement('canvas'); cvs.width = 16; cvs.height = 16; const cx = cvs.getContext('2d');
        let map = ["OOOOOOOKKKOOOOOO","OOOOOOKBBKKOOOOO","OOOOOKBBBBKKOOOO","OOOOKBBBBBBKKOOO","OOOKBBBBBBBBKKOO","OOKBBBBBBBBBBKKO","OKBBBBBBBBBBBBKK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK","KBBBBBBBBBBBBBBK"];
        drawSpriteMap(cx, map, {'O': '#E79C21', 'B': '#955529', 'K': '#000'}); return cvs;
    }

    function createMarioCoin() {
        const cvs = document.createElement('canvas'); cvs.width = 12; cvs.height = 16; const cx = cvs.getContext('2d');
        cx.fillStyle='#000'; cx.fillRect(2,0,8,16); cx.fillStyle='#F8B800'; cx.fillRect(3,1,6,14); cx.fillStyle='#FFF'; cx.fillRect(4,2,1,10); return cvs;
    }

    // --- 4. Game Logic ---
    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    let gameSettings = { resolution: localStorage.getItem('fb_res') || 'retro' };
    document.getElementById('resolutionSelect').value = gameSettings.resolution;
    const LOGICAL_HEIGHT = 480; let logicalWidth = 320; let globalScale = 1;

    function resize() {
        const winW = window.innerWidth; const winH = window.innerHeight;
        if (gameSettings.resolution === 'retro') {
            const ratio = winH / LOGICAL_HEIGHT; canvas.height = LOGICAL_HEIGHT; canvas.width = Math.ceil(winW / ratio); if (canvas.width < 320) canvas.width = 320; globalScale = 1; 
        } else if (gameSettings.resolution === 'native') {
            canvas.width = winW; canvas.height = winH; globalScale = winH / LOGICAL_HEIGHT;
        } else {
            const targetH = parseInt(gameSettings.resolution); canvas.height = targetH; canvas.width = Math.ceil(winW * (targetH / winH)); globalScale = targetH / LOGICAL_HEIGHT;
        }
        logicalWidth = canvas.width / globalScale; ctx.imageSmoothingEnabled = false;
    }
    window.addEventListener('resize', resize);
    resize();

    let frames = 0; let screenShake = 0; const DEGREE = Math.PI / 180;
    const state = { current: 0, getReady: 0, game: 1, over: 2, falling: 3 };
    let userData = {
        highScore: parseInt(localStorage.getItem('fb_highScore')) || 0, coins: parseInt(localStorage.getItem('fb_coins')) || 0,
        unlockedSkins: JSON.parse(localStorage.getItem('fb_skins')) || ['yellow', 'amongus', 'bigo', 'gd', 'santa', 'mario'], equippedSkin: localStorage.getItem('fb_equipped') || 'yellow'
    };
    const images = {}; let crackParams = { active: false, width: 0, x: 0 }; 
    function getGameSpeed() { if (userData.equippedSkin === 'gd') return 5; if (userData.equippedSkin === 'mario') return 3.5; return 2; }

    // --- MARIO STATE ---
    let marioState = { timer: 0, groundSegments: [], platforms: [], enemies: [], coins: [], camX: 0, died: false };
    function initMarioLevel() {
        marioState.timer = 0; marioState.camX = 0; marioState.died = false;
        marioState.groundSegments = [{x: 0, w: logicalWidth * 2}];
        marioState.platforms = []; marioState.enemies = []; marioState.coins = [];
    }
    function updateMarioLevel(dt) {
        let lastSeg = marioState.groundSegments[marioState.groundSegments.length - 1];
        if (lastSeg.x + lastSeg.w < marioState.camX + logicalWidth + 200) {
            let gapSize = Math.random() < 0.3 ? 70 + Math.random() * 40 : 0; 
            let newW = 200 + Math.random() * 400; let nextX = lastSeg.x + lastSeg.w + gapSize;
            marioState.groundSegments.push({x: nextX, w: newW});
            
            // CLEANUP OBJECTS
            marioState.groundSegments = marioState.groundSegments.filter(s => s.x + s.w > marioState.camX - 100);
            marioState.platforms = marioState.platforms.filter(p => p.x + p.w > marioState.camX - 100);
            marioState.enemies = marioState.enemies.filter(e => e.x > marioState.camX - 100);
            marioState.coins = marioState.coins.filter(c => c.x > marioState.camX - 100);

            if (gapSize === 0) {
                if (Math.random() < 0.5) marioState.enemies.push({x: nextX + 50 + Math.random() * (newW-100), y: LOGICAL_HEIGHT - 112 - 32, type: 'goomba', dead: false});
                if (Math.random() < 0.3) marioState.coins.push({x: nextX + Math.random() * newW, y: LOGICAL_HEIGHT - 112 - 32, collected: false});
            } else { marioState.coins.push({x: nextX - gapSize/2, y: LOGICAL_HEIGHT - 112 - 60, collected: false}); }
            if (Math.random() < 0.4) {
                let platH = 100 + Math.random() * 100; let platW = 64 + Math.random() * 64; let platX = nextX + 50;
                marioState.platforms.push({x: platX, y: LOGICAL_HEIGHT - 112 - platH, w: platW});
                if (Math.random() < 0.5) marioState.coins.push({x: platX + platW/2, y: LOGICAL_HEIGHT - 112 - platH - 20, collected: false});
            }
        }
        marioState.camX += getGameSpeed() * dt; marioState.timer += dt / 60;
    }

    const debrisSystem = { 
        particles: [], 
        create: function(x, y) { for(let i=0; i<40; i++) { this.particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, life: 60, color: Math.random() < 0.5 ? '#558022' : '#73BF2E', size: Math.random() * 6 + 3 }); } },
        createBrickDebris: function(x, y) {
            // Classic Mario brick break: 4 pieces
            this.particles.push({x:x, y:y, vx:-2, vy:-5, life:40, color:'#B85000', size:8});
            this.particles.push({x:x, y:y, vx:2, vy:-5, life:40, color:'#B85000', size:8});
            this.particles.push({x:x, y:y, vx:-2, vy:-8, life:40, color:'#B85000', size:8});
            this.particles.push({x:x, y:y, vx:2, vy:-8, life:40, color:'#B85000', size:8});
        },
        update: function(dt) { for(let i=0; i<this.particles.length; i++) { let p = this.particles[i]; p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 0.5 * dt; p.life -= dt; if(p.life <= 0) { this.particles.splice(i, 1); i--; } } }, 
        draw: function() { for(let p of this.particles) { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); } } 
    };
    const snowSystem = { particles: [], update: function(dt) { if (this.particles.length < 50) { this.particles.push({ x: Math.random() * logicalWidth, y: -10, size: Math.random() * 2 + 1, speed: Math.random() * 1 + 0.5 }); } for (let i=0; i<this.particles.length; i++) { let p = this.particles[i]; p.y += p.speed * dt; p.x += Math.sin(frames / 50 + i) * 0.5 * dt; if (p.y > LOGICAL_HEIGHT) { p.y = -10; p.x = Math.random() * logicalWidth; } } }, draw: function() { ctx.fillStyle = '#FFF'; for(let p of this.particles) { ctx.fillRect(p.x, p.y, p.size, p.size); } } };

    // --- GAME DRAWING LAYERS ---
    const bg = {
        draw: function() {
            ctx.save();
            if(screenShake > 0) { let dx = (Math.random()-0.5)*screenShake; let dy = (Math.random()-0.5)*screenShake; ctx.translate(dx, dy); screenShake *= 0.9; if(screenShake < 0.5) screenShake = 0; }
            if (userData.equippedSkin === 'mario') { ctx.fillStyle = '#6b8cff'; ctx.fillRect(0,0, logicalWidth, LOGICAL_HEIGHT); } 
            else { 
                let cur = images.bg; 
                if (userData.equippedSkin === 'amongus' || userData.equippedSkin === 'santa') cur = images.bgSpace; 
                if(cur) { 
                    const bgW = 276; const count = Math.ceil(logicalWidth / bgW) + 1; 
                    for(let i=0; i<count; i++) ctx.drawImage(cur, i * bgW, LOGICAL_HEIGHT - 512); 
                } else { ctx.fillStyle = "#70c5ce"; ctx.fillRect(0, 0, logicalWidth, LOGICAL_HEIGHT); }
            }
            ctx.restore(); 
        }
    };

    const fg = {
        h: 112, x: 0,
        draw: function() {
            if (userData.equippedSkin === 'mario') {
                let groundY = LOGICAL_HEIGHT - 112;
                for(let seg of marioState.groundSegments) {
                    let drawX = seg.x - marioState.camX;
                    if (drawX + seg.w > 0 && drawX < logicalWidth) {
                        for (let tx = 0; tx < seg.w; tx += 32) {
                            for(let ty=0; ty<112; ty+=32) { if(images.marioGround) ctx.drawImage(images.marioGround, drawX + tx, groundY + ty, 32, 32); else { ctx.fillStyle='#E45C10'; ctx.fillRect(drawX+tx, groundY+ty, 32, 32); } }
                        }
                    }
                }
                return;
            }
            let floorY = LOGICAL_HEIGHT - 112;
            const baseW = 336; const count = Math.ceil(logicalWidth / baseW) + 1;
            ctx.save();
            if (images.base) {
                if (userData.equippedSkin === 'amongus') ctx.filter = 'hue-rotate(220deg) saturate(1.5) brightness(0.8)';
                for(let i=0; i<count; i++) ctx.drawImage(images.base, this.x + (i * baseW), floorY);
            } else {
                ctx.fillStyle = "#DED895"; ctx.fillRect(0, floorY, logicalWidth, 112);
            }
            if (userData.equippedSkin === 'santa') { ctx.fillStyle = "#FFF"; ctx.globalAlpha = 0.8; ctx.fillRect(0, floorY, logicalWidth, 15); ctx.globalAlpha = 1.0; }
            if (crackParams.active) { ctx.fillStyle = "#000"; ctx.fillRect(crackParams.x - crackParams.width/2, floorY, crackParams.width, 112); }
            ctx.restore();
        },
        update: function(dt) { if (userData.equippedSkin !== 'mario' && (state.current === state.game || state.current === state.getReady)) this.x = (this.x - getGameSpeed() * dt) % 336; }
    };

    const marioObjects = {
        draw: function() {
            if (userData.equippedSkin !== 'mario') return;
            for (let plat of marioState.platforms) {
                let dx = plat.x - marioState.camX;
                if (dx > -100 && dx < logicalWidth) { 
                    for(let i=0; i<plat.w; i+=32) { if(images.brick) ctx.drawImage(images.brick, dx + i, plat.y, 32, 32); else { ctx.fillStyle='#B85000'; ctx.fillRect(dx+i, plat.y, 32, 32); } } 
                }
            }
            for (let coin of marioState.coins) {
                if (!coin.collected) { let dx = coin.x - marioState.camX; if(dx>-50&&dx<logicalWidth && images.marioCoin) ctx.drawImage(images.marioCoin, dx, coin.y, 20, 28); }
            }
            for (let en of marioState.enemies) {
                let dx = en.x - marioState.camX;
                if (dx > -50 && dx < logicalWidth && !en.dead) { 
                    let frame = Math.floor(frames / 10) % 2; let sprite = (frame === 0) ? images.goomba1 : images.goomba2;
                    if(sprite) ctx.drawImage(sprite, dx, en.y, 32, 32); else { ctx.fillStyle='brown'; ctx.fillRect(dx, en.y, 32, 32); }
                }
            }
        },
        update: function(dt) {
            if (state.current !== state.game || userData.equippedSkin !== 'mario') return;
            updateMarioLevel(dt);
            for (let en of marioState.enemies) {
                if (en.dead) continue; let dx = en.x - marioState.camX;
                let enCenterX = dx + 16; let enCenterY = en.y + 16;
                if (Math.abs(bird.x - enCenterX) < 20 && Math.abs(bird.y - enCenterY) < 20) {
                    if (bird.speed > 0 && bird.y < en.y + 10) { en.dead = true; bird.speed = -4.0; playSound('hit'); } 
                    else { if (state.current === state.game && !marioState.died) { state.current = state.over; marioState.died = true; stopBGM(); playSound('mario_die'); } }
                }
            }
            for (let coin of marioState.coins) {
                if (!coin.collected) {
                    let dx = coin.x - marioState.camX;
                    if (Math.abs(bird.x - (dx+10)) < 25 && Math.abs(bird.y - (coin.y+14)) < 25) {
                        coin.collected = true; userData.coins++; playSound('coin'); document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`; saveData();
                    }
                }
            }
        }
    };

    const bird = {
        animation: [0, 1, 2, 1], x: 50, y: 150, w: 34, h: 24, radius: 12, frame: 0, speed: 0, gravity: 0.25, jump: 4.6, rotation: 0, onGround: false,
        flap: function() {
            if (userData.equippedSkin === 'gd') { if (this.onGround) { this.speed = -8.8; this.onGround = false; } } 
            else if (userData.equippedSkin === 'mario') { if (this.onGround) { this.speed = -7.0; this.onGround = false; } } 
            else { this.speed = -this.jump; this.rotation = -25 * DEGREE; }
        },
        draw: function() {
            let sprite;
            if (state.current === state.over && userData.equippedSkin === 'amongus') { if (images.birdDeadAU) { const img = new Image(); img.src = images.birdDeadAU.toDataURL(); sprite = img; } } 
            else if (userData.equippedSkin === 'mario') {
                if (state.current === state.over) sprite = images.marioDead; else if (!this.onGround) sprite = images.marioJump; else { let f = Math.floor((frames / 5) % 3); sprite = (f === 0) ? images.marioIdle : images.marioWalk; }
            } else { if(images.birds && images.birds[userData.equippedSkin]) { let arr = images.birds[userData.equippedSkin]; if (arr && arr.length) sprite = arr[this.animation[this.frame]]; } }
            if(!sprite) return;
            let drawW = this.w; let drawH = this.h;
            if (userData.equippedSkin === 'bigo') { drawW = 44; drawH = 34; }
            if (userData.equippedSkin === 'gd') { drawW = 30; drawH = 30; }
            if (userData.equippedSkin === 'santa') { drawW = 48; drawH = 30; }
            if (userData.equippedSkin === 'mario') { drawW = 32; drawH = 32; } 
            ctx.save(); ctx.translate(this.x, this.y); let rot = this.rotation; if (state.current === state.over && userData.equippedSkin === 'amongus') rot = 0; if (state.current === state.falling) rot = 0; if (userData.equippedSkin === 'mario') rot = 0; ctx.rotate(rot);
            if (sprite.complete || sprite instanceof HTMLCanvasElement) { ctx.drawImage(sprite, -drawW/2, -drawH/2, drawW, drawH); }
            ctx.restore();
        },
        update: function(dt) {
            let period = state.current === state.getReady ? 10 : 5; this.frame += frames % period === 0 ? 1 : 0; this.frame %= this.animation.length;
            if(userData.equippedSkin === 'bigo') this.radius = 18; else if(userData.equippedSkin === 'gd') this.radius = 15; else if(userData.equippedSkin === 'santa') this.radius = 14; else if(userData.equippedSkin === 'mario') this.radius = 14; else this.radius = 12;
            if(state.current === state.getReady) { if (userData.equippedSkin === 'gd' || userData.equippedSkin === 'mario') { this.y = LOGICAL_HEIGHT - 112 - 20; this.rotation = 0; this.speed = 0; } else { this.y = 150; this.rotation = 0; this.speed = 0; } } 
            else if (state.current === state.falling) { this.speed += (this.gravity * 1.5) * dt; this.y += this.speed * dt; crackParams.width += 3 * dt; if (this.y > LOGICAL_HEIGHT + 60) { state.current = state.over; playSound('hit'); } } 
            else {
                let g = (userData.equippedSkin === 'gd' || userData.equippedSkin === 'mario') ? 0.45 : this.gravity;
                this.speed += g * dt; this.y += this.speed * dt;
                if (userData.equippedSkin === 'mario') {
                    let floorY = LOGICAL_HEIGHT - 112; let grounded = false; let absoluteX = marioState.camX + this.x;
                    
                    // Platform Collision
                    for(let i=0; i<marioState.platforms.length; i++) {
                        let plat = marioState.platforms[i];
                        let px = plat.x - marioState.camX;
                        // X Overlap
                        if (this.x + this.radius > px && this.x - this.radius < px + plat.w) {
                            let platBottom = plat.y + 32;
                            // 1. Land on top
                            if (this.y + this.radius >= plat.y && this.y + this.radius <= plat.y + 12 && this.speed >= 0) { 
                                this.y = plat.y - this.radius; this.speed = 0; grounded = true; 
                            }
                            // 2. Break from below (Hit Bottom)
                            else if (this.y - this.radius <= platBottom && this.y - this.radius >= platBottom - 16 && this.speed < 0) {
                                marioState.platforms.splice(i, 1); i--;
                                this.speed = 0;
                                debrisSystem.createBrickDebris(px + plat.w/2, plat.y + 16);
                                playSound('break');
                            }
                            // 3. Side Hit (Death) - Only if not breaking and not landing
                            else if (this.y - this.radius < platBottom && this.y + this.radius > plat.y + 12) {
                                if (state.current === state.game && !marioState.died) { state.current = state.over; marioState.died = true; stopBGM(); playSound('mario_die'); }
                            }
                        }
                    }
                    
                    let overGround = false; for (let seg of marioState.groundSegments) { if (absoluteX >= seg.x && absoluteX <= seg.x + seg.w) { overGround = true; break; } }
                    if (overGround) { if (this.y >= floorY - 16 && this.y <= floorY + 2 && this.speed >= 0) { this.y = floorY - 16; this.speed = 0; grounded = true; } } 
                    else { if (this.y > floorY && state.current === state.game && !marioState.died) { state.current = state.over; marioState.died = true; stopBGM(); playSound('mario_die'); } }
                    this.onGround = grounded;
                    if (this.y > LOGICAL_HEIGHT + 50 && state.current === state.game && !marioState.died) { state.current = state.over; marioState.died = true; stopBGM(); playSound('mario_die'); }
                } else {
                    if (this.speed >= this.jump) { this.rotation = 90 * DEGREE; this.frame = 1; } else { this.rotation = -25 * DEGREE; }
                    if (userData.equippedSkin !== 'gd') {
                        let floorY = LOGICAL_HEIGHT - 112 - this.h/2;
                        if(this.y >= floorY) {
                            if (userData.equippedSkin === 'bigo') { if (state.current === state.game) { state.current = state.falling; screenShake = 25; crackParams.active = true; crackParams.x = this.x; crackParams.width = 10; playSound('hit'); } } 
                            else { this.y = floorY; if(state.current === state.game) { state.current = state.over; if(userData.equippedSkin === 'amongus') playSound('die'); else playSound('hit'); } }
                        }
                    }
                }
            }
        }
    };

    const pipes = { position: [], w: 52, gap: 100, lastSpawn: 0, update: function(dt) { if (userData.equippedSkin === 'mario') return; if(state.current !== state.game) return; let spawnRate = 100; this.lastSpawn += dt; if(this.lastSpawn > spawnRate) { this.lastSpawn = 0; let spikeCount = 0; if (userData.equippedSkin === 'gd') spikeCount = Math.floor(Math.random() * 3) + 1; this.position.push({ x: logicalWidth, y: -150 * (Math.random() + 1), passed: false, hasCoin: userData.equippedSkin !== 'bigo' && userData.equippedSkin !== 'gd' && Math.random() < 0.4, hasBurger: userData.equippedSkin === 'bigo', collected: false, broken: false, spikes: spikeCount }); } for(let i=0; i<this.position.length; i++) { let p = this.position[i]; let bY = p.y + 320 + this.gap; let collided = false; if (userData.equippedSkin === 'gd') { let spikeY = LOGICAL_HEIGHT - 112; let birdBottom = bird.y + bird.radius; let birdRight = bird.x + bird.radius; let birdLeft = bird.x - bird.radius; let spikesW = p.spikes * 30; if (birdRight > p.x + 10 && birdLeft < p.x + spikesW - 10) { if (birdBottom > spikeY - 20) collided = true; } } else { if (!p.broken) { if(bird.x+bird.radius > p.x && bird.x-bird.radius < p.x+this.w && (bird.y-bird.radius < p.y+320 || bird.y+bird.radius > bY)) { collided = true; } } } if (collided) { if (userData.equippedSkin === 'bigo') { if (!p.broken) { p.broken = true; debrisSystem.create(p.x + this.w/2, p.y + 320); playSound('hit'); screenShake = 10; } } else { state.current = state.over; playSound('hit'); if (userData.equippedSkin !== 'amongus' && userData.equippedSkin !== 'gd') setTimeout(() => playSound('die'), 300); } } let scoreCondition = false; if (userData.equippedSkin === 'bigo') { if (p.hasBurger && !p.collected) { let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2; if(Math.hypot(bird.x-cx, bird.y-cy) < 35) { p.collected = true; score.value++; userData.highScore = Math.max(score.value, userData.highScore); playSound('chomp'); saveData(); } } } else if (userData.equippedSkin === 'gd') { if(!p.passed && bird.x > p.x + (p.spikes*30)) scoreCondition = true; } else { if(!p.passed && bird.x - bird.radius > p.x + this.w) scoreCondition = true; } if(scoreCondition) { p.passed = true; score.value++; userData.highScore = Math.max(score.value, userData.highScore); playSound('point'); saveData(); } if(p.hasCoin && !p.collected) { let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2; if (userData.equippedSkin === 'gd') { cx = p.x + (p.spikes*30) + 100; cy = LOGICAL_HEIGHT - 112 - 20; } if(Math.hypot(bird.x-cx, bird.y-cy) < 30) { p.collected = true; userData.coins++; saveData(); playSound('coin'); document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`; } } p.x -= getGameSpeed() * dt; if(p.x + 150 <= 0) { this.position.shift(); i--; } } }, draw: function() { if (userData.equippedSkin === 'mario') return; let isAU = userData.equippedSkin === 'amongus'; let isGD = userData.equippedSkin === 'gd'; let isSanta = userData.equippedSkin === 'santa'; for(let p of this.position) { if (!p.broken) { if (isGD) { let floorY = LOGICAL_HEIGHT - 112; ctx.fillStyle = '#333'; ctx.beginPath(); for(let i=0; i<p.spikes; i++) { let sx = p.x + (i * 30); ctx.moveTo(sx, floorY); ctx.lineTo(sx + 15, floorY - 30); ctx.lineTo(sx + 30, floorY); } ctx.fill(); ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2; ctx.stroke(); } else if (isSanta) { let topY = p.y; let bottomY = p.y + 320 + this.gap; ctx.save(); ctx.translate(p.x + this.w/2, topY + 160); ctx.rotate(Math.PI); ctx.drawImage(images.chimney, -this.w/2, -160, this.w, 320); ctx.fillStyle='#FFF'; ctx.fillRect(-this.w/2 - 2, 160-15, this.w+4, 15); ctx.restore(); ctx.save(); ctx.drawImage(images.chimney, p.x, bottomY); ctx.fillStyle='#FFF'; ctx.fillRect(p.x - 2, bottomY, this.w+4, 15); ctx.restore(); } else { if (images.pipe) { let topY = p.y; let bottomY = p.y + 320 + this.gap; ctx.save(); if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)'; ctx.translate(p.x + this.w/2, topY + 160); ctx.rotate(Math.PI); ctx.drawImage(images.pipe, -this.w/2, -160, this.w, 320); ctx.restore(); ctx.save(); if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)'; ctx.drawImage(images.pipe, p.x, bottomY); ctx.restore(); } else { ctx.fillStyle = "green"; ctx.fillRect(p.x, p.y, this.w, 320); ctx.fillRect(p.x, p.y + 320 + this.gap, this.w, 320); } } } if(p.hasBurger && !p.collected && images.burger) { ctx.drawImage(images.burger, p.x + this.w/2 - 12, p.y + 320 + this.gap/2 - 10); } if(p.hasCoin && !p.collected) { let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2; if (isGD) { cx = p.x + (p.spikes*30) + 100; cy = LOGICAL_HEIGHT - 112 - 20; } ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle = '#FFF'; ctx.font = '12px FlappyFont'; ctx.fillText("$", cx-3, cy+3); } } } };

    const score = { value: 0, draw: function() { ctx.fillStyle = '#FFF'; ctx.strokeStyle = '#000'; if (state.current === state.game) { ctx.lineWidth = 2; ctx.font = '35px FlappyFont'; let text = this.value; if (userData.equippedSkin === 'mario') text = marioState.timer.toFixed(2); ctx.fillText(text, logicalWidth / 2, 50); ctx.strokeText(text, logicalWidth / 2, 50); } }, reset: function() { this.value = 0; } };

    // --- INPUT ---
    const Input = {
        active: 'mouse', focusIndex: 1, navContext: 'menu', lastAxis: 0, btnPressed: false,
        update: function() { const pads = navigator.getGamepads ? navigator.getGamepads() : []; const pad = pads[0]; if (pad) this.handleGamepad(pad); },
        handleGamepad: function(pad) { const axisX = pad.axes[0]; const axisY = pad.axes[1]; const btnA = pad.buttons[0].pressed; const btnB = pad.buttons[1].pressed; const dpadLeft = pad.buttons[14].pressed; const dpadRight = pad.buttons[15].pressed; const dpadUp = pad.buttons[12].pressed; const dpadDown = pad.buttons[13].pressed; let move = 0; if (axisX < -0.5 || dpadLeft) move = -1; else if (axisX > 0.5 || dpadRight) move = 1; if (this.navContext === 'menu' || this.navContext === 'shop') { if (move !== 0 && this.lastAxis === 0) { this.moveFocus(move); this.active = 'gamepad'; resumeAudio(); } } else if (this.navContext === 'settings') { let vMove = 0; if (axisY < -0.5 || dpadUp) vMove = -1; else if (axisY > 0.5 || dpadDown) vMove = 1; if (vMove !== 0 && this.lastAxis === 0) { this.moveFocus(vMove); this.active = 'gamepad'; resumeAudio(); } if (move !== 0 && this.lastAxis === 0) { this.changeSetting(move); } } this.lastAxis = (Math.abs(axisX) > 0.5 || Math.abs(axisY) > 0.5 || dpadLeft || dpadRight || dpadUp || dpadDown) ? 1 : 0; if (btnA && !this.btnPressed) { this.btnPressed = true; this.active = 'gamepad'; resumeAudio(); this.triggerAction(); } else if (!btnA) { this.btnPressed = false; } if (btnB && (this.navContext === 'shop' || this.navContext === 'settings')) { this.closeModal(); } },
        moveFocus: function(dir) { let max = 0; if (this.navContext === 'menu') max = 2; if (this.navContext === 'shop') max = shopConfig.length - 1; if (this.navContext === 'settings') max = 1; this.focusIndex += dir; if (this.focusIndex < 0) this.focusIndex = max; if (this.focusIndex > max) this.focusIndex = 0; this.renderFocus(); },
        renderFocus: function() { document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused')); if (this.navContext === 'menu') { const btns = [ document.getElementById('shopTriggerBtn'), document.getElementById('startTriggerBtn'), document.getElementById('settingsTriggerBtn') ]; if(btns[this.focusIndex]) btns[this.focusIndex].classList.add('focused'); } else if (this.navContext === 'shop') { const items = document.querySelectorAll('.shop-item'); if(items[this.focusIndex]) { items[this.focusIndex].classList.add('focused'); items[this.focusIndex].scrollIntoView({block: 'center', behavior: 'smooth'}); } } else if (this.navContext === 'settings') { const rows = document.querySelectorAll('.setting-row'); if(rows[this.focusIndex]) rows[this.focusIndex].classList.add('focused'); } },
        triggerAction: function() { if (state.current === state.game) { bird.flap(); playSound('flap'); return; } if (state.current === state.over) { resetGame(); state.current = state.getReady; return; } if (this.navContext === 'menu') { if (this.focusIndex === 0) document.getElementById('shopTriggerBtn').click(); else if (this.focusIndex === 1) { state.current = state.game; bird.flap(); playSound('flap'); if (userData.equippedSkin === 'mario') startBGM(); } else if (this.focusIndex === 2) document.getElementById('settingsTriggerBtn').click(); } else if (this.navContext === 'shop') { const item = shopConfig[this.focusIndex]; handleShopClick(item); } else if (this.navContext === 'settings') { if (this.focusIndex === 1) document.getElementById('fullscreenToggle').click(); } },
        changeSetting: function(dir) { if (this.focusIndex === 0) { const sel = document.getElementById('resolutionSelect'); let idx = sel.selectedIndex + dir; if (idx >= 0 && idx < sel.options.length) { sel.selectedIndex = idx; sel.dispatchEvent(new Event('change')); } } },
        openModal: function(context) { this.navContext = context; this.focusIndex = 0; setTimeout(() => this.renderFocus(), 50); },
        closeModal: function() { if (this.navContext === 'shop') document.getElementById('closeShopX').click(); if (this.navContext === 'settings') document.getElementById('closeSettingsX').click(); this.navContext = 'menu'; this.focusIndex = 1; this.renderFocus(); }
    };

    window.addEventListener('keydown', (e) => {
        resumeAudio();
        if (state.current === state.game) { if (['Space','ArrowUp','Enter','KeyW'].includes(e.code)) { bird.flap(); playSound('flap'); } return; }
        Input.active = 'gamepad';
        switch(e.code) {
            case 'ArrowLeft': if(Input.navContext !== 'settings') Input.moveFocus(-1); else Input.changeSetting(-1); break;
            case 'ArrowRight': if(Input.navContext !== 'settings') Input.moveFocus(1); else Input.changeSetting(1); break;
            case 'ArrowUp': if(Input.navContext === 'settings') Input.moveFocus(-1); else if(Input.navContext === 'shop') Input.moveFocus(-3); break;
            case 'ArrowDown': if(Input.navContext === 'settings') Input.moveFocus(1); else if(Input.navContext === 'shop') Input.moveFocus(3); break;
            case 'Enter': case 'Space': if (Input.navContext === 'menu') { Input.triggerAction(); } else if (state.current === state.getReady) { state.current = state.game; bird.flap(); playSound('flap'); if (userData.equippedSkin === 'mario') startBGM(); } else { Input.triggerAction(); } break;
            case 'Escape': case 'Backspace': if(Input.navContext !== 'menu') Input.closeModal(); break;
        }
    });

    // --- MAIN DRAW & LOOP ---
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save(); if (globalScale !== 1) ctx.scale(globalScale, globalScale);
        bg.draw(); 
        try {
            pipes.draw(); 
            // Safety: Only draw Mario Objects if textures are ready
            if (images.brick && images.goomba1) marioObjects.draw(); 
            debrisSystem.draw(); bird.draw(); fg.draw(); score.draw(); 
            if (userData.equippedSkin === 'santa') snowSystem.draw();
        } catch(e) { console.error("Draw error:", e); }

        if (state.current === state.getReady) {
            if (images.msg) ctx.drawImage(images.msg, logicalWidth/2 - images.msg.width/2, 100);
            document.getElementById('shopTriggerBtn').style.display = 'block'; 
            document.getElementById('startTriggerBtn').style.display = 'block'; 
            document.getElementById('settingsTriggerBtn').style.display = 'block'; 
            document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`;
        } else if (state.current === state.over) {
            document.getElementById('shopTriggerBtn').style.display = 'none';
            document.getElementById('startTriggerBtn').style.display = 'none';
            document.getElementById('settingsTriggerBtn').style.display = 'none';
            let centerX = logicalWidth / 2;
            if (images.gameover) ctx.drawImage(images.gameover, centerX - images.gameover.width/2, 80);
            ctx.fillStyle = '#DED895'; ctx.fillRect(centerX - 100, 140, 200, 110); ctx.strokeRect(centerX - 100, 140, 200, 110);
            ctx.fillStyle = '#E57338'; ctx.font = '18px FlappyFont'; ctx.textAlign = 'left';
            ctx.fillText("SCORE", centerX - 85, 170); ctx.fillText("BEST", centerX - 85, 210);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'right';
            let displayScore = score.value; let displayHigh = userData.highScore;
            if (userData.equippedSkin === 'mario') { displayScore = marioState.timer.toFixed(2) + "s"; }
            ctx.fillText(displayScore, centerX + 70, 170); ctx.fillText(displayHigh, centerX + 70, 210);
            ctx.fillStyle = '#73BF2E'; ctx.fillRect(centerX - 41, 263, 83, 35); ctx.strokeRect(centerX - 41, 263, 83, 35);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'center'; ctx.fillText("RESTART", centerX, 288);
            if(score.value >= 10) { ctx.fillStyle = score.value >= 20 ? '#FFD700' : '#C0C0C0'; ctx.beginPath(); ctx.arc(centerX - 65, 195, 18, 0, Math.PI*2); ctx.fill(); ctx.stroke(); }
        } else {
            document.getElementById('shopTriggerBtn').style.display = 'none';
            document.getElementById('startTriggerBtn').style.display = 'none';
            document.getElementById('settingsTriggerBtn').style.display = 'none';
        }
        ctx.restore(); 
    }

    function update(dt) {
        bird.update(dt); fg.update(dt); pipes.update(dt); marioObjects.update(dt); debrisSystem.update(dt);
        if (userData.equippedSkin === 'santa') snowSystem.update(dt);
        Input.update(); frames++; 
    }

    let lastTime = performance.now();
    const targetFPS = 60;
    function loop(timestamp) {
        if (!timestamp) timestamp = performance.now();
        const rawDelta = timestamp - lastTime; lastTime = timestamp;
        let dt = rawDelta / (1000 / targetFPS); if (dt > 3.0) dt = 3.0; 
        update(dt); draw(); requestAnimationFrame(loop);
    }

    function resetGame() { 
        stopBGM(); bird.speed = 0; bird.y = 150; pipes.position = []; score.value = 0; frames = 0; 
        debrisSystem.particles = []; crackParams={active:false,width:0,x:0}; pipes.lastSpawn = 0; 
        if (userData.equippedSkin === 'mario') initMarioLevel();
        Input.focusIndex = 1; Input.renderFocus();
    }
    
    function saveData() { localStorage.setItem('fb_highScore', userData.highScore); localStorage.setItem('fb_coins', userData.coins); localStorage.setItem('fb_skins', JSON.stringify(userData.unlockedSkins)); localStorage.setItem('fb_equipped', userData.equippedSkin); }

    const shopConfig = [ { id: 'yellow', name: 'Original', price: 0 }, { id: 'amongus', name: 'Among Us', price: 0 }, { id: 'bigo', name: 'Big O', price: 0 }, { id: 'gd', name: 'Dash', price: 0 }, { id: 'santa', name: 'Santa', price: 0 }, { id: 'mario', name: 'Mario Run', price: 0 } ];

    function initShop() {
        const container = document.getElementById('shopItemsContainer'); container.innerHTML = '';
        shopConfig.forEach((item, index) => {
            const div = document.createElement('div'); div.className = 'shop-item'; div.id = `shop-item-${item.id}`;
            div.onclick = (e) => { e.stopPropagation(); handleShopClick(item); };
            const img = document.createElement('img');
            if(item.id === 'amongus') img.src = createAmongUsAsset('alive').toDataURL();
            else if(item.id === 'bigo') img.src = createBigOAsset().toDataURL();
            else if(item.id === 'gd') img.src = createGDAsset().toDataURL();
            else if(item.id === 'santa') img.src = createSantaAsset().toDataURL();
            else if(item.id === 'mario') img.src = createMarioSprite('walk').toDataURL();
            else if(ASSETS.sprites.birdYellow && ASSETS.sprites.birdYellow[0]) img.src = ASSETS.sprites.birdYellow[0];
            const name = document.createElement('div'); name.innerText = item.name; name.style.fontSize = '12px'; name.style.marginTop = '5px';
            const cost = document.createElement('div'); cost.className = 'item-cost';
            div.appendChild(img); div.appendChild(name); div.appendChild(cost); container.appendChild(div);
        });
        updateShopUI();
    }

    function updateShopUI() {
        document.getElementById('shopCoinCount').innerText = userData.coins;
        shopConfig.forEach((item, index) => {
            const el = document.getElementById(`shop-item-${item.id}`);
            const costEl = el.querySelector('.item-cost');
            const isUnlocked = userData.unlockedSkins.includes(item.id);
            const isEquipped = userData.equippedSkin === item.id;
            el.classList.remove('locked', 'selected');
            if (!isUnlocked) el.classList.add('locked'); if (isEquipped) el.classList.add('selected');
            costEl.innerText = isEquipped ? "EQUIPPED" : (isUnlocked ? "OWNED" : `${item.price} COINS`);
            if(Input.navContext === 'shop' && Input.focusIndex === index) { el.classList.add('focused'); } else { el.classList.remove('focused'); }
        });
    }

    function handleShopClick(item) {
        if (userData.unlockedSkins.includes(item.id)) {
            userData.equippedSkin = item.id; playSound('flap');
            if(item.id === 'mario') { initMarioLevel(); } else { stopBGM(); }
        } else {
            if (userData.coins >= item.price) {
                userData.coins -= item.price; userData.unlockedSkins.push(item.id); userData.equippedSkin = item.id; playSound('point');
                if(item.id === 'mario') { initMarioLevel(); } else { stopBGM(); }
            } else playSound('hit');
        }
        saveData(); updateShopUI();
    }

    // UI Events
    const shopModal = document.getElementById('shop-modal'); const settingsModal = document.getElementById('settings-modal');
    document.getElementById('shopTriggerBtn').onclick = (e) => { e.stopPropagation(); updateShopUI(); shopModal.style.display = 'flex'; Input.openModal('shop'); };
    document.getElementById('startTriggerBtn').onclick = (e) => { e.stopPropagation(); state.current = state.game; bird.flap(); playSound('flap'); if(userData.equippedSkin === 'mario') startBGM(); };
    document.getElementById('settingsTriggerBtn').onclick = (e) => { e.stopPropagation(); settingsModal.style.display = 'flex'; Input.openModal('settings'); };
    document.getElementById('closeShopX').onclick = (e) => { e.stopPropagation(); shopModal.style.display = 'none'; Input.closeModal(); };
    document.getElementById('closeSettingsX').onclick = (e) => { e.stopPropagation(); settingsModal.style.display = 'none'; Input.closeModal(); };
    
    function getGameCoords(e) { let rect = canvas.getBoundingClientRect(); let rawX = (e.clientX - rect.left) * (canvas.width / rect.width); let rawY = (e.clientY - rect.top) * (canvas.height / rect.height); return { x: rawX / globalScale, y: rawY / globalScale }; }
    canvas.addEventListener('pointerdown', (e) => {
        if (shopModal.style.display === 'flex' || settingsModal.style.display === 'flex') return;
        if (state.current === state.over) {
            let coords = getGameCoords(e); let centerX = logicalWidth / 2;
            if (coords.x >= centerX - 41 && coords.x <= centerX + 42 && coords.y >= 263 && coords.y <= 298) { resetGame(); state.current = state.getReady; }
            return;
        }
        if (state.current === state.getReady) { state.current = state.game; if(userData.equippedSkin === 'mario') startBGM(); }
        if (state.current === state.game) { bird.flap(); playSound('flap'); }
    });

    async function initGame() {
        const audioProms = Object.keys(ASSETS.audio).map(k => loadSound(ASSETS.audio[k], k));
        const loadImg = (src) => new Promise(r => { const img = new Image(); if(!src.startsWith('data')) img.crossOrigin = "anonymous"; img.onload = () => r(img); img.onerror = () => r(null); img.src = src; });
        images.bg = await loadImg(ASSETS.sprites.bg);
        images.base = await loadImg(ASSETS.sprites.base);
        images.pipe = await loadImg(ASSETS.sprites.pipe);
        images.msg = await loadImg(ASSETS.sprites.msg);
        images.gameover = await loadImg(ASSETS.sprites.gameover);
        images.bgSpace = createSpaceBg();
        images.birdDeadAU = createAmongUsAsset('dead');
        images.burger = createBurgerAsset();
        const auAlive = createAmongUsAsset('alive');
        const bigOAlive = createBigOAsset();
        const gdAlive = createGDAsset();
        images.chimney = createChimneyAsset();
        images.brick = createBrickSprite();
        images.marioGround = createGroundSprite();
        images.marioIdle = createMarioSprite('idle');
        images.marioWalk = createMarioSprite('walk');
        images.marioJump = createMarioSprite('jump');
        images.marioDead = createMarioSprite('dead');
        images.goomba1 = createGoombaSprite(0);
        images.goomba2 = createGoombaSprite(1);
        images.marioCoin = createMarioCoin();

        images.birds = {};
        for(let c of ['yellow', 'blue', 'red', 'amongus', 'bigo', 'gd', 'santa', 'mario']) {
            images.birds[c] = [];
            if(c === 'amongus') { const img = new Image(); img.src = auAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if (c === 'bigo') { const img = new Image(); img.src = bigOAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if (c === 'gd') { const img = new Image(); img.src = gdAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if(c === 'santa') { const img = new Image(); img.src = createSantaAsset().toDataURL(); images.birds[c] = [img, img, img]; }
            else if(c === 'mario') { const img = new Image(); img.src = createMarioSprite('walk').toDataURL(); images.birds[c] = [img, img, img]; }
            else if(ASSETS.sprites['bird' + c.charAt(0).toUpperCase() + c.slice(1)]) {
                const arr = ASSETS.sprites['bird'+c.charAt(0).toUpperCase()+c.slice(1)];
                for(let s of arr) images.birds[c].push(await loadImg(s));
            }
        }
        await Promise.all(audioProms);
        document.getElementById('loading-overlay').style.display = 'none';
        initShop();
        if(userData.equippedSkin === 'mario') initMarioLevel();
        lastTime = performance.now();
        requestAnimationFrame(loop);
    }
    initGame();
</script>
</body>
</html>