<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird Pro</title>
    <style>
        @font-face { font-family: 'FlappyFont'; src: url('https://raw.githubusercontent.com/paulkr/Flappy-Bird/master/lib/res/fonts/flappy-font.ttf') format('truetype'); }
        body { margin: 0; padding: 0; background-color: #333; height: 100vh; width: 100vw; overflow: hidden; touch-action: none; font-family: 'FlappyFont', sans-serif; user-select: none; -webkit-user-select: none; cursor: default; }
        #game-container { position: relative; background-color: #70c5ce; width: 100%; height: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        /* UI BUTTONS */
        .game-btn { position: absolute; bottom: 5vh; background: #E57338; border: 2px solid #FFF; color: white; padding: 10px 20px; font-family: 'FlappyFont', sans-serif; font-size: 3vh; cursor: pointer; text-shadow: 2px 2px 0 #000; box-shadow: 0 4px 0 #9e4f24; text-transform: uppercase; z-index: 10; white-space: nowrap; display: none; min-width: 120px; text-align: center; }
        .game-btn:active, .game-btn.active-press { transform: translateY(4px); box-shadow: none; }
        .game-btn.focused, .shop-item.focused, .setting-row.focused, .close-x.focused, .custom-select.focused, .toggle-btn.focused, .data-btn.focused { border-color: #FFD700; box-shadow: 0 0 15px #FFD700; transform: scale(1.05); z-index: 20; }
        #shopTriggerBtn { left: 5vw; } #startTriggerBtn { left: 50%; transform: translateX(-50%); background: #73BF2E; box-shadow: 0 4px 0 #4d851e; } #settingsTriggerBtn { right: 5vw; background: #4ec0ca; box-shadow: 0 4px 0 #2e8b94; }
        /* Crossy D-Pad */
        #crossy-controls { position: absolute; bottom: 20px; left: 20px; z-index: 50; display: none; flex-direction: column; align-items: center; gap: 10px; }
        .dpad-row { display: flex; gap: 10px; }
        .dpad-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.3); border: 2px solid #FFF; border-radius: 10px; color: #FFF; font-size: 24px; touch-action: manipulation; user-select: none; -webkit-user-select: none; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .dpad-btn:active { background: rgba(255,255,255,0.6); transform: scale(0.95); }
        /* Modals */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: flex-start; color: white; padding-top: 5vh; box-sizing: border-box; }
        .modal h2 { margin: 0 0 2vh 0; font-size: 5vh; color: #FFD700; text-shadow: 2px 2px 0 #000; }
        .close-x { position: absolute; top: 2vh; right: 2vh; background: #d32f2f; border: 2px solid #FFF; color: white; font-family: 'FlappyFont', sans-serif; font-size: 3vh; width: 5vh; height: 5vh; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 0 #8b0000; }
        .close-x:active { transform: translateY(2px); box-shadow: none; }
        .coin-display { font-size: 3vh; margin-bottom: 2vh; color: #FFF; }
        .shop-items { display: flex; flex-wrap: wrap; justify-content: center; align-content: flex-start; gap: 10px; width: 90%; height: 70%; overflow-y: auto; padding: 5px; }
        .shop-item { background: #4ec0ca; border: 2px solid #fff; padding: 5px; width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 3px 3px 0 #000; flex-shrink: 0; }
        .shop-item.locked { filter: grayscale(1); opacity: 0.6; }
        .shop-item.selected { border-color: #FFD700; background: #fff; color: #333; }
        .shop-item img { width: 50px; margin-bottom: 5px; object-fit: contain; image-rendering: pixelated; }
        .item-cost { font-size: 16px; text-align: center; }
        .setting-row { margin: 20px 0; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 10px; border: 2px solid transparent; }
        .setting-label { font-size: 24px; margin-bottom: 10px; color: #EEE; }
        /* Custom Select */
        .custom-select { position: relative; font-family: 'FlappyFont', sans-serif; width: 250px; text-align: center; cursor: pointer; user-select: none; z-index: 50; }
        .select-selected { background-color: #E57338; color: #fff; padding: 10px; border: 2px solid #fff; border-radius: 5px; box-shadow: 0 4px 0 #9e4f24; }
        .select-selected:after { position: absolute; content: ""; top: 18px; right: 15px; width: 0; height: 0; border: 6px solid transparent; border-color: #fff transparent transparent transparent; }
        .select-selected.select-arrow-active:after { border-color: transparent transparent #fff transparent; top: 10px; }
        .select-items { position: absolute; background-color: #E57338; top: 100%; left: 0; right: 0; z-index: 99; border: 2px solid #fff; border-radius: 5px; max-height: 200px; overflow-y: auto; }
        .select-items div { color: #fff; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); cursor: pointer; }
        .select-items div:hover, .same-as-selected { background-color: rgba(0, 0, 0, 0.2); }
        .select-hide { display: none; }
        .toggle-btn { font-family: 'FlappyFont', sans-serif; font-size: 20px; padding: 10px; border-radius: 5px; border: 2px solid #FFF; background: #73BF2E; color: white; cursor: pointer; width: 200px; text-align: center; box-shadow: 0 4px 0 #4d851e; }
        .toggle-btn.off { background: #d32f2f; box-shadow: 0 4px 0 #8b0000; }
        .data-btn-container { display: flex; gap: 20px; }
        .data-btn { font-family: 'FlappyFont', sans-serif; font-size: 18px; padding: 8px; border-radius: 5px; border: 2px solid #FFF; background: #4ec0ca; color: white; cursor: pointer; width: 110px; text-align: center; box-shadow: 0 4px 0 #2e8b94; }
        .data-btn:active { transform: translateY(2px); box-shadow: none; }
        #data-io-modal { z-index: 150; display: none; }
        .io-area { width: 80%; height: 150px; background: #FFF; color: #333; font-family: monospace; padding: 10px; border-radius: 5px; margin-bottom: 20px; resize: none; }
        .io-actions { display: flex; gap: 20px; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #70c5ce; z-index: 200; display: flex; justify-content: center; align-items: center; color: white; font-size: 30px; text-shadow: 2px 2px 0 #000; }
    </style>
</head>
<body>
<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="crossy-controls">
        <div class="dpad-btn" id="c-up">▲</div>
        <div class="dpad-row"><div class="dpad-btn" id="c-left">◀</div><div class="dpad-btn" id="c-down">▼</div><div class="dpad-btn" id="c-right">▶</div></div>
    </div>
    <div id="loading-overlay">LOADING...</div>
    <button id="shopTriggerBtn" class="game-btn" data-nav="menu" data-index="0">SHOP</button>
    <button id="startTriggerBtn" class="game-btn" data-nav="menu" data-index="1">START</button>
    <button id="settingsTriggerBtn" class="game-btn" data-nav="menu" data-index="2">SETTINGS</button>
    <div id="shop-modal" class="modal">
        <button id="closeShopX" class="close-x" data-nav="shop_close">X</button>
        <h2>SKIN SHOP</h2>
        <div class="coin-display">COINS: <span id="shopCoinCount">0</span></div>
        <div class="shop-items" id="shopItemsContainer"></div>
    </div>
    <div id="settings-modal" class="modal">
        <button id="closeSettingsX" class="close-x" data-nav="settings_close">X</button>
        <h2>SETTINGS</h2>
        <div class="setting-row" id="setting-res-row" data-nav="settings" data-index="0">
            <div class="setting-label">RESOLUTION</div>
            <div class="custom-select" id="resolutionDropdown">
                <div class="select-selected" id="currentResDisplay">Performance</div>
                <div class="select-items select-hide" id="resOptions">
                    <div data-value="retro">Performance</div><div data-value="native">Native</div><div data-value="720">720p</div><div data-value="1080">1080p</div>
                </div>
            </div>
        </div>
        <div class="setting-row" id="setting-fs-row" data-nav="settings" data-index="1">
            <div class="setting-label">FULLSCREEN</div>
            <button id="fullscreenToggle" class="toggle-btn off" tabindex="-1">OFF</button>
        </div>
        <div class="setting-row" id="setting-data-row" data-nav="settings" data-index="2">
            <div class="setting-label">GAME DATA</div>
            <div class="data-btn-container"><button id="exportDataBtn" class="data-btn" tabindex="-1">EXPORT</button><button id="importDataBtn" class="data-btn" tabindex="-1">IMPORT</button></div>
        </div>
    </div>
    <div id="data-io-modal" class="modal">
        <button id="closeDataX" class="close-x">X</button>
        <h2 id="io-title">EXPORT DATA</h2>
        <div style="font-size: 16px; margin-bottom: 10px; color: #DDD;">COPY OR PASTE CODE BELOW</div>
        <textarea id="io-textarea" class="io-area"></textarea>
        <div class="io-actions"><button id="io-action-btn" class="game-btn" style="position: relative; bottom: auto; display: block;">COPY</button></div>
    </div>
</div>

<script>
    // --- 1. Audio Engine ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    // FIX: interactive latency hint drastically reduces delay
    const audioCtx = new AudioContext({ latencyHint: 'interactive' });
    const soundBuffers = {};
    let audioResumed = false;
    let bgmSource = null;
    let isTouch = false;
    window.addEventListener('touchstart', function() { isTouch = true; }, {once: true});

    async function resumeAudio() {
        if (audioCtx.state === 'suspended') {
            try { await audioCtx.resume(); audioResumed = true; } catch (e) {}
        } else {
            audioResumed = true;
        }
    }
    window.addEventListener('keydown', resumeAudio, { once: true });
    window.addEventListener('pointerdown', resumeAudio, { once: true });

    async function loadSound(url, key) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
        } catch(e) {}
    }

    function playSound(name, loop = false) {
        if (audioCtx.state === 'suspended') resumeAudio();
        let key = name;
        const skin = userData.equippedSkin;
        if (skin === 'amongus') { if (name === 'point') key = 'au_point'; else if (name === 'hit' || name === 'die') key = 'au_kill'; }
        else if (skin === 'bigo') { if (name === 'flap') key = 'bigo_flap'; else if (name === 'chomp') key = 'bigo_chomp'; }
        else if (skin === 'mario') { if (name === 'flap') key = 'mario_jump'; else if (name === 'die') key = 'mario_die'; else if (name === 'hit') key = 'mario_stomp'; else if (name === 'coin') key = 'mario_coin'; else if (name === 'break') key = 'mario_break'; }
        else if (skin === 'ufo' || skin === 'clown') { if (name === 'flap') key = 'coin'; }
        else if (skin === 'crossy') { if (name === 'flap') key = 'mario_jump'; if (name === 'hit') key = 'mario_stomp'; }
        const buffer = soundBuffers[key];
        if (buffer) {
            const src = audioCtx.createBufferSource();
            src.buffer = buffer; src.loop = loop; src.connect(audioCtx.destination); src.start(0); return src;
        }
        return null;
    }
    function stopBGM() { if (bgmSource) { try { bgmSource.stop(); } catch(e){} bgmSource = null; } }
    function startBGM() { stopBGM(); if (userData.equippedSkin === 'mario') { bgmSource = playSound('mario_bgm', true); } }

    // --- 2. Assets ---
    const MARIO_BASE_URL = "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Sprites/";
    const ASSETS = {
        sprites: {
            bg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png",
            base: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/base.png",
            pipe: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png",
            msg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/message.png",
            gameover: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/gameover.png",
            birdYellow: [ "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-downflap.png", "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png", "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-upflap.png" ],
            marioWalk: [MARIO_BASE_URL+"walk1.png", MARIO_BASE_URL+"walk2.png", MARIO_BASE_URL+"walk3.png"],
            marioJump: MARIO_BASE_URL+"jump.png", marioDead: MARIO_BASE_URL+"dead.png", marioBrick: MARIO_BASE_URL+"brick.png", marioGround: MARIO_BASE_URL+"ground.png",
            marioCoin: [MARIO_BASE_URL+"coin1.png", MARIO_BASE_URL+"coin2.png", MARIO_BASE_URL+"coin3.png", MARIO_BASE_URL+"coin4.png"],
            marioGoomba: [MARIO_BASE_URL+"goombwalk1.png", MARIO_BASE_URL+"goombwalk2.png"]
        },
        audio: {
            flap: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/wing.wav",
            point: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/point.wav",
            hit: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/hit.wav",
            die: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/die.wav",
            coin: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/swoosh.wav",
            au_point: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Task%20Complete.mp3",
            au_kill: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Impostor%20Kill.mp3",
            bigo_flap: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Stomp.mp3",
            bigo_chomp: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Chomp.mp3",
            mario_jump: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/jump-small.wav",
            mario_die: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/mariodie.wav",
            mario_bgm: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/aboveground_bgm.ogg",
            mario_stomp: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/kick.wav",
            mario_coin: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/coin.wav",
            mario_break: "https://raw.githubusercontent.com/reruns/mario/gh-pages/sounds/breakblock.wav"
        }
    };

    function drawRoundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
    function createAsset(w,h,fn){const c=document.createElement('canvas');c.width=w;c.height=h;const x=c.getContext('2d');fn(x);return c;}

    const Gen = {
        au:()=>createAsset(34,24,c=>{const cl='#C51111';c.fillStyle=cl;drawRoundRect(c,0,6,10,14,2);c.fill();c.stroke();c.beginPath();drawRoundRect(c,6,2,22,22,8);c.fill();c.stroke();c.fillStyle='#9ECEF5';c.beginPath();c.ellipse(22,9,8,5,0,0,6.28);c.fill();c.stroke();c.fillStyle='#FFF';c.beginPath();c.ellipse(20,7,4,2,0,0,6.28);c.fill();}),
        au_dead:()=>createAsset(34,24,c=>{c.fillStyle='#DDD';c.fillRect(14,8,6,8);c.beginPath();c.arc(14,8,3,0,6.28);c.fill();c.beginPath();c.arc(20,8,3,0,6.28);c.fill();c.fillStyle='#C51111';c.beginPath();c.moveTo(6,16);c.lineTo(28,16);c.lineTo(28,20);c.quadraticCurveTo(28,24,24,24);c.lineTo(10,24);c.quadraticCurveTo(6,24,6,20);c.fill();c.stroke();}),
        bigo:()=>createAsset(50,50,c=>{
            // Head
            c.fillStyle='#FFCCB3';c.beginPath();c.arc(25,25,22,0,6.28);c.fill();
            // Beard (Brown goatee/circle beard)
            c.fillStyle='#4E342E';c.beginPath();c.arc(25,35,12,0,6.28);c.fill();
            // Mouth (inside beard)
            c.fillStyle='#500';c.beginPath();c.arc(25,35,4,0,6.28);c.fill();
            // Glasses (Black rims)
            c.strokeStyle='#000'; c.lineWidth=2; c.fillStyle='rgba(200,255,255,0.6)';
            c.beginPath(); c.arc(18,20,7,0,6.28); c.fill(); c.stroke(); // Left Lens
            c.beginPath(); c.arc(32,20,7,0,6.28); c.fill(); c.stroke(); // Right Lens
            c.beginPath(); c.moveTo(25,20); c.lineTo(25,20); c.stroke(); // Bridge
            // Eyes
            c.fillStyle='#000';
            c.beginPath(); c.arc(18,20,2,0,6.28); c.fill();
            c.beginPath(); c.arc(32,20,2,0,6.28); c.fill();
        }),
        gd:()=>createAsset(30,30,c=>{c.fillStyle='#FFD700';c.fillRect(0,0,30,30);c.lineWidth=2;c.strokeStyle='#000';c.strokeRect(0,0,30,30);c.fillStyle='#000';c.fillRect(6,6,8,8);c.fillRect(18,6,8,8);c.fillRect(6,18,18,6);}),
        crossy:()=>createAsset(32,32,c=>{c.fillStyle='#FFF';c.fillRect(8,8,16,16);c.fillStyle='#F00';c.fillRect(12,4,4,4);c.fillStyle='#F90';c.fillRect(24,12,4,4);c.fillStyle='#000';c.fillRect(18,10,2,2);c.fillStyle='#F90';c.fillRect(12,24,2,4);c.fillRect(18,24,2,4);}),
        car:()=>createAsset(40,20,c=>{c.fillStyle='#3498db';c.fillRect(0,5,40,15);c.fillStyle='#87CEEB';c.fillRect(5,0,20,5);c.fillStyle='#000';c.fillRect(5,15,6,5);c.fillRect(29,15,6,5);}),
        log:()=>createAsset(60,20,c=>{c.fillStyle='#8D6E63';c.fillRect(0,0,60,20);c.fillStyle='#5D4037';c.fillRect(5,2,50,16);}),
        burger:()=>createAsset(24,20,c=>{c.fillStyle='#E67E22';c.fillRect(2,14,20,4);c.fillStyle='#2ECC71';c.fillRect(1,12,22,2);c.fillStyle='#6E2C00';c.fillRect(2,8,20,4);c.fillStyle='#E67E22';c.beginPath();c.arc(12,8,10,3.14,0);c.fill();c.fillStyle='#F5B7B1';c.fillRect(8,2,2,2);c.fillRect(14,3,2,2);c.fillRect(11,5,2,2);c.strokeStyle='#000';c.lineWidth=1;c.strokeRect(2,14,20,4);}),
        space:()=>createAsset(320,480,c=>{c.fillStyle='#050510';c.fillRect(0,0,320,480);c.fillStyle='#FFF';for(let i=0;i<100;i++){c.globalAlpha=Math.random();c.fillRect(Math.random()*320,Math.random()*480,1,1);}c.globalAlpha=1.0;}),
    };

    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d', {alpha: false});
    let gameSettings = { resolution: localStorage.getItem('fb_res') || 'retro' };
    
    function initDropdown() {
        const selected = document.getElementById('currentResDisplay');
        const items = document.getElementById('resOptions');
        const options = items.getElementsByTagName('div');
        for(let opt of options) { if(opt.getAttribute('data-value') === gameSettings.resolution) { selected.innerText = opt.innerText; break; } }
        selected.addEventListener('click', function(e) { e.stopPropagation(); items.classList.toggle('select-hide'); this.classList.toggle('select-arrow-active'); });
        for(let opt of options) {
            opt.addEventListener('click', function(e) {
                e.stopPropagation(); gameSettings.resolution = this.getAttribute('data-value'); localStorage.setItem('fb_res', gameSettings.resolution);
                selected.innerText = this.innerText; items.classList.add('select-hide'); selected.classList.remove('select-arrow-active'); resize();
            });
        }
        document.addEventListener('click', function() { items.classList.add('select-hide'); selected.classList.remove('select-arrow-active'); });
    }
    initDropdown();

    const LOGICAL_HEIGHT = 480; let logicalWidth = 320; let globalScale = 1;
    function resize() {
        const winW = window.innerWidth; const winH = window.innerHeight;
        if (gameSettings.resolution === 'retro') {
            const ratio = winH / LOGICAL_HEIGHT; canvas.height = LOGICAL_HEIGHT; canvas.width = Math.ceil(winW / ratio); if (canvas.width < 320) canvas.width = 320; globalScale = 1; 
        } else if (gameSettings.resolution === 'native') {
            canvas.width = winW; canvas.height = winH; globalScale = winH / LOGICAL_HEIGHT;
        } else {
            const targetH = parseInt(gameSettings.resolution); canvas.height = targetH; canvas.width = Math.ceil(winW * (targetH / winH)); globalScale = targetH / LOGICAL_HEIGHT;
        }
        logicalWidth = canvas.width / globalScale; ctx.imageSmoothingEnabled = false;
    }
    window.addEventListener('resize', resize);
    resize();

    let frames = 0; let screenShake = 0; let flashOpacity = 0;
    const DEGREE = Math.PI / 180;
    const state = { current: 0, getReady: 0, game: 1, over: 2, falling: 3 };
    let userData = {
        highScore: parseInt(localStorage.getItem('fb_highScore')) || 0, coins: parseInt(localStorage.getItem('fb_coins')) || 0,
        unlockedSkins: JSON.parse(localStorage.getItem('fb_skins')) || ['yellow'], equippedSkin: localStorage.getItem('fb_equipped') || 'yellow',
        shield: 0
    };
    if(!userData.unlockedSkins.includes('yellow')) userData.unlockedSkins.push('yellow');
    const images = {}; let crackParams = { active: false, width: 0, x: 0 }; 

    function getGameSpeed() { 
        const s = userData.equippedSkin;
        if (s === 'gd') return 5; if (s === 'mario') return 4.5;
        return 2; 
    }

    const particlePool = [];
    function getParticle() { return particlePool.length > 0 ? particlePool.pop() : {x:0,y:0,vx:0,vy:0,life:0,color:'#FFF',size:1,type:'normal'}; }
    function releaseParticle(p) { particlePool.push(p); }

    const debrisSystem = { 
        particles: [], 
        create: function(x, y) { for(let i=0; i<20; i++) { let p = getParticle(); p.x=x; p.y=y; p.vx=(Math.random()-0.5)*15; p.vy=(Math.random()-0.5)*15; p.life=60; p.color=Math.random()<0.5?'#558022':'#73BF2E'; p.size=Math.random()*6+3; p.type='normal'; this.particles.push(p); } },
        createBrickDebris: function(x, y) { const dirs = [[-2,-5],[2,-5],[-2,-8],[2,-8]]; for(let d of dirs) { let p = getParticle(); p.x=x; p.y=y; p.vx=d[0]; p.vy=d[1]; p.life=40; p.color='#B85000'; p.size=12; p.type='normal'; this.particles.push(p); } },
        createGDExplosion: function(x, y) { for(let i=0; i<15; i++) { let p = getParticle(); p.x=x; p.y=y; p.vx=(Math.random()-0.5)*15; p.vy=(Math.random()-0.5)*15; p.life=60; p.color=Math.random()<0.7?'#FFD700':'#000'; p.size=Math.random()*6+4; p.type='normal'; this.particles.push(p); } },
        createConfetti: function(x, y) { const colors = ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6']; for(let i=0; i<15; i++) { let p = getParticle(); p.x=x; p.y=y; p.vx=(Math.random()-0.5)*15; p.vy=(Math.random()-0.5)*15; p.life=80; p.color=colors[Math.floor(Math.random()*colors.length)]; p.size=Math.random()*5+2; p.type='normal'; this.particles.push(p); } },
        createBubbles: function(x, y) { if(Math.random() > 0.3) return; let p = getParticle(); p.x=x; p.y=y; p.vx=-2; p.vy=-Math.random()*2; p.life=100; p.color='rgba(255,255,255,0.6)'; p.size=Math.random()*4+2; p.type='bubble'; this.particles.push(p); },
        update: function(dt) { for(let i=this.particles.length-1; i>=0; i--) { let p = this.particles[i]; p.x += p.vx * dt; p.y += p.vy * dt; if(p.type === 'normal') p.vy += 0.5 * dt; p.life -= dt; if(p.life <= 0) { releaseParticle(p); this.particles.splice(i, 1); } } }, 
        draw: function() { for(let p of this.particles) { ctx.fillStyle = p.color; if(p.type === 'bubble') { ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, 6.28); ctx.fill(); } else ctx.fillRect(p.x, p.y, p.size, p.size); } } 
    };

    let marioState = { timer: 0, groundSegments: [], platforms: [], enemies: [], coins: [], camX: 0, died: false };
    function initMarioLevel() { marioState.timer = 0; marioState.camX = 0; marioState.died = false; marioState.groundSegments = [{x: 0, w: logicalWidth * 2}]; marioState.platforms = []; marioState.enemies = []; marioState.coins = []; }
    function updateMarioLevel(dt) {
        if (state.current === state.getReady) {
             marioState.camX += getGameSpeed() * dt;
             if (marioState.groundSegments.length < 2) { let last = marioState.groundSegments[marioState.groundSegments.length-1]; if (last.x + last.w < marioState.camX + logicalWidth + 100) marioState.groundSegments.push({x: last.x + last.w, w: logicalWidth * 1.5}); }
             if (marioState.groundSegments[0].x + marioState.groundSegments[0].w < marioState.camX - 50) marioState.groundSegments.shift();
             return;
        }
        let lastSeg = marioState.groundSegments[marioState.groundSegments.length - 1];
        if (lastSeg.x + lastSeg.w < marioState.camX + logicalWidth + 200) {
            let gapSize = Math.random() < 0.3 ? 70 + Math.random() * 40 : 0; 
            let newW = 200 + Math.random() * 400; let nextX = lastSeg.x + lastSeg.w + gapSize;
            marioState.groundSegments.push({x: nextX, w: newW});
            for(let i=marioState.groundSegments.length-1; i>=0; i--) { if(marioState.groundSegments[i].x + marioState.groundSegments[i].w <= marioState.camX - 100) marioState.groundSegments.splice(i,1); }
            for(let i=marioState.platforms.length-1; i>=0; i--) { if(marioState.platforms[i].x + marioState.platforms[i].w <= marioState.camX - 100) marioState.platforms.splice(i,1); }
            for(let i=marioState.enemies.length-1; i>=0; i--) { if(marioState.enemies[i].x <= marioState.camX - 100) marioState.enemies.splice(i,1); }
            for(let i=marioState.coins.length-1; i>=0; i--) { if(marioState.coins[i].x <= marioState.camX - 100) marioState.coins.splice(i,1); }
            if (gapSize === 0) { if (Math.random() < 0.5) marioState.enemies.push({x: nextX + 50 + Math.random() * (newW-100), y: LOGICAL_HEIGHT - 112 - 32, type: 'goomba', dead: false}); if (Math.random() < 0.3) marioState.coins.push({x: nextX + Math.random() * newW, y: LOGICAL_HEIGHT - 112 - 32, collected: false}); } else { marioState.coins.push({x: nextX - gapSize/2, y: LOGICAL_HEIGHT - 112 - 60, collected: false}); }
            if (Math.random() < 0.4) { let platH = 100 + Math.random() * 100; let platW = 64 + Math.random() * 64; let platX = nextX + 50; marioState.platforms.push({x: platX, y: LOGICAL_HEIGHT - 112 - platH, w: platW}); if (Math.random() < 0.5) marioState.coins.push({x: platX + platW/2, y: LOGICAL_HEIGHT - 112 - platH - 40, collected: false}); }
        }
        marioState.camX += getGameSpeed() * dt; marioState.timer += dt / 60;
    }

    let crossyState = { tiles: [], tileW: 40, camX: 0, birdWorldX: 0, groundY: 0, objects: [], lastGenX: 0 };
    function initCrossyLevel() { crossyState.camX = 0; crossyState.birdWorldX = 0; crossyState.groundY = LOGICAL_HEIGHT / 2; crossyState.tiles = []; crossyState.objects = []; for(let i=0; i<10; i++) crossyState.tiles.push({x: i*40, type: 'grass'}); crossyState.lastGenX = 9 * 40; }
    function updateCrossyLevel(dt) {
        while (crossyState.lastGenX < crossyState.camX + logicalWidth + 200) {
            crossyState.lastGenX += 40; let type = 'grass'; const r = Math.random(); if (r < 0.3) type = 'road'; else if (r < 0.5) type = 'river'; else if (r < 0.6) type = 'rail'; let prev = crossyState.tiles[crossyState.tiles.length-1]; if (prev.type === 'road' && Math.random() < 0.6) type = 'road'; if (prev.type === 'river' && Math.random() < 0.6) type = 'river'; if (prev.type === 'rail') type = 'grass'; let tile = {x: crossyState.lastGenX, type: type, timer: 0}; crossyState.tiles.push(tile); if (type === 'road') { crossyState.objects.push({type:'car', x: crossyState.lastGenX, y: crossyState.groundY - 10, speed: (2+Math.random()*3)*(Math.random()<0.5?1:-1), tileX: crossyState.lastGenX }); } else if (type === 'river') { crossyState.objects.push({type:'log', x: crossyState.lastGenX, y: crossyState.groundY + 10, speed: (1+Math.random()*2)*(Math.random()<0.5?1:-1), tileX: crossyState.lastGenX }); } else if (type === 'rail' || type === 'grass') { if(Math.random()<0.3) crossyState.objects.push({type:'coin', x: crossyState.lastGenX, y: crossyState.groundY, tileX: crossyState.lastGenX, collected: false}); if(type==='rail'){ tile.trainTimer=Math.random()*200; tile.trainActive=false; } }
        }
        for(let i=crossyState.tiles.length-1; i>=0; i--) { if(crossyState.tiles[i].x <= crossyState.camX - 100) crossyState.tiles.splice(i,1); }
        for(let i=crossyState.objects.length-1; i>=0; i--) { if(crossyState.objects[i].tileX <= crossyState.camX - 100) crossyState.objects.splice(i,1); }
        for (let o of crossyState.objects) { if (o.type === 'car' || o.type === 'log') { o.y += o.speed; if (o.y > LOGICAL_HEIGHT + 50) o.y = -50; if (o.y < -50) o.y = LOGICAL_HEIGHT + 50; } }
        for(let t of crossyState.tiles) { if(t.type === 'rail') { t.trainTimer++; if (t.trainTimer > 300) { if (t.trainTimer > 360) t.trainActive = true; if (t.trainTimer > 400) { t.trainTimer = 0; t.trainActive = false; } } } }
        let targetCamX = crossyState.birdWorldX - 100; crossyState.camX += (targetCamX - crossyState.camX) * 0.1;
    }

    let lastTime = performance.now(); let accumulator = 0;
    function loop(now) { requestAnimationFrame(loop); let frameTime = (now - lastTime) / 1000; if (frameTime > 0.1) frameTime = 0.1; lastTime = now; const dt = frameTime * 60; update(dt); draw(); }

    function update(dt) { bird.update(dt); fg.update(dt); pipes.update(dt); marioObjects.update(dt); crossyObjects.update(dt); debrisSystem.update(dt); Input.update(); frames++; }

    const bg={
        draw:function(){
            ctx.save();
            if(screenShake>0){let dx=(Math.random()-0.5)*screenShake,dy=(Math.random()-0.5)*screenShake;ctx.translate(dx,dy);screenShake*=0.9;if(screenShake<0.5)screenShake=0;}
            const s=userData.equippedSkin;
            if(s==='mario'){ctx.fillStyle='#6b8cff';ctx.fillRect(0,0,logicalWidth,LOGICAL_HEIGHT);}
            else if(s==='crossy'){ctx.fillStyle='#a2d6f9';ctx.fillRect(0,0,logicalWidth,LOGICAL_HEIGHT);}
            else{
                let cur=images.bg;
                if(s==='amongus')cur=images.bgSpace;
                if(cur){const bgW=276,count=Math.ceil(logicalWidth/bgW)+1;for(let i=0;i<count;i++)ctx.drawImage(cur,i*bgW,LOGICAL_HEIGHT-512);}
                else{ctx.fillStyle="#70c5ce";ctx.fillRect(0,0,logicalWidth,LOGICAL_HEIGHT);}
            }
            ctx.restore();
        }
    };
    
    const fg={
        h:112,x:0,
        draw:function(){
            if(userData.equippedSkin==='mario'){
                let gy=LOGICAL_HEIGHT-112;
                for(let seg of marioState.groundSegments){
                    let dx=seg.x-marioState.camX;
                    if(dx+seg.w>0&&dx<logicalWidth){
                        for(let tx=0;tx<seg.w;tx+=32){
                            if(images.marioGround) ctx.drawImage(images.marioGround,dx+tx,gy,32,32);
                            else { ctx.fillStyle='#E45C10'; ctx.fillRect(dx+tx,gy,32,32); }
                        }
                        ctx.fillStyle = '#6d4007'; ctx.fillRect(dx, gy + 32, seg.w, 112 - 32);
                    }
                }
                return;
            }
            if(userData.equippedSkin==='crossy')return;
            let fy=LOGICAL_HEIGHT-112;const bw=336,c=Math.ceil(logicalWidth/bw)+1;
            ctx.save();
            if(images.base){
                if(userData.equippedSkin==='amongus')ctx.filter='hue-rotate(220deg) saturate(1.5) brightness(0.8)';
                for(let i=0;i<c;i++)ctx.drawImage(images.base,this.x+(i*bw),fy);
            } else {
                ctx.fillStyle="#DED895";ctx.fillRect(0,fy,logicalWidth,112);
            }
            if(crackParams.active){ctx.fillStyle="#000";ctx.fillRect(crackParams.x-crackParams.width/2,fy,crackParams.width,112);}
            ctx.restore();
        },
        update:function(dt){
            if(userData.equippedSkin!=='mario'&&userData.equippedSkin!=='crossy'&&(state.current===state.game||state.current===state.getReady))
                this.x=(this.x-getGameSpeed()*dt)%336;
        }
    };
    
    const marioObjects={
        draw:function(){
            if(userData.equippedSkin!=='mario')return;
            for(let plat of marioState.platforms){
                let dx=plat.x-marioState.camX;
                if(dx>-100&&dx<logicalWidth){
                    for(let i=0;i<plat.w;i+=32)
                        if(images.marioBrick)ctx.drawImage(images.marioBrick,dx+i,plat.y,32,32);
                        else{ctx.fillStyle='#B85000';ctx.fillRect(dx+i,plat.y,32,32);}
                }
            }
            for(let coin of marioState.coins){
                if(!coin.collected){
                    let dx=coin.x-marioState.camX;
                    if(dx>-50&&dx<logicalWidth&&images.marioCoin&&images.marioCoin.length){
                        let f=Math.floor((frames/10)%4);
                        ctx.drawImage(images.marioCoin[f],dx+2,coin.y+4,20,24);
                    }
                }
            }
            for(let en of marioState.enemies){
                let dx=en.x-marioState.camX;
                if(dx>-50&&dx<logicalWidth&&!en.dead){
                    let f=Math.floor(frames/10)%2,s=(images.marioGoomba&&images.marioGoomba[f])?images.marioGoomba[f]:null;
                    if(s)ctx.drawImage(s,dx,en.y,32,32);else{ctx.fillStyle='brown';ctx.fillRect(dx,en.y,32,32);}
                }
            }
        },
        update:function(dt){
            if(state.current!==state.game||userData.equippedSkin!=='mario')return;
            updateMarioLevel(dt);
            for(let en of marioState.enemies){
                if(en.dead)continue;
                let dx=en.x-marioState.camX,cx=dx+16,cy=en.y+16;
                if(Math.abs(bird.x-cx)<30&&Math.abs(bird.y-cy)<30){
                    if(bird.speed>0&&bird.y<en.y+10){en.dead=true;bird.speed=-4.0;playSound('hit');}
                    else{
                        if(state.current===state.game&&!marioState.died){state.current=state.over;marioState.died=true;flashOpacity=1;stopBGM();playSound('mario_die');bird.speed=-10;bird.onGround=false;}
                    }
                }
            }
            for(let coin of marioState.coins){
                if(!coin.collected){
                    let dx=coin.x-marioState.camX;
                    if(Math.abs(bird.x-(dx+16))<30&&Math.abs(bird.y-(coin.y+16))<30){
                        coin.collected=true;userData.coins++;playSound('coin');document.getElementById('shopTriggerBtn').innerText=`SHOP (${userData.coins})`;saveData();
                    }
                }
            }
        }
    };
    
    const crossyObjects={
        draw:function(){
            if(userData.equippedSkin!=='crossy')return;
            let gy=crossyState.groundY;
            for(let t of crossyState.tiles){
                let dx=t.x-crossyState.camX;
                if(dx>-100&&dx<logicalWidth){
                    if(t.type==='grass'){ctx.fillStyle='#8bc34a';ctx.fillRect(dx,0,40,LOGICAL_HEIGHT);ctx.fillStyle='#7cb342';ctx.fillRect(dx,gy-20,40,40);}
                    else if(t.type==='road'){ctx.fillStyle='#555';ctx.fillRect(dx,0,40,LOGICAL_HEIGHT);ctx.strokeStyle='#FFF';ctx.setLineDash([5,10]);ctx.beginPath();ctx.moveTo(dx+20,0);ctx.lineTo(dx+20,LOGICAL_HEIGHT);ctx.stroke();ctx.setLineDash([]);}
                    else if(t.type==='river'){ctx.fillStyle='#42a5f5';ctx.fillRect(dx,0,40,LOGICAL_HEIGHT);}
                    else if(t.type==='rail'){
                        ctx.fillStyle='#8d6e63';ctx.fillRect(dx,0,40,LOGICAL_HEIGHT);ctx.fillStyle='#Silver';ctx.fillRect(dx+10,0,5,LOGICAL_HEIGHT);ctx.fillRect(dx+25,0,5,LOGICAL_HEIGHT);ctx.fillStyle='#3e2723';
                        for(let y=0;y<LOGICAL_HEIGHT;y+=20)ctx.fillRect(dx+5,y,30,5);
                        if(t.trainTimer>300){ctx.fillStyle=(Math.floor(frames/5)%2===0)?'#F00':'#300';ctx.beginPath();ctx.arc(dx+20,gy,10,0,6.28);ctx.fill();}
                    }
                }
            }
            for(let o of crossyState.objects){
                let dx=o.tileX-crossyState.camX;
                if(dx>-100&&dx<logicalWidth){
                    let cx=dx+20;
                    if(o.type==='coin'){
                        if(!o.collected){
                            ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(cx,o.y,8,0,6.28);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='#FFF';ctx.font='10px FlappyFont';ctx.fillText("$",cx-3,o.y+3+Math.sin(frames*0.1)*3);
                        }
                        continue;
                    }
                    ctx.save();ctx.translate(cx,o.y);
                    if(o.type==='car'){
                        ctx.rotate(1.57);if(o.speed<0)ctx.rotate(3.14);
                        if(images.voxelCar)ctx.drawImage(images.voxelCar,-20,-10);else{ctx.fillStyle='blue';ctx.fillRect(-15,-10,30,20);}
                    }else if(o.type==='log'){
                        if(images.log){ctx.rotate(1.57);ctx.drawImage(images.log,-30,-10);}else{ctx.fillStyle='#5D4037';ctx.fillRect(-10,-30,20,60);}
                    }
                    ctx.restore();
                }
            }
            for(let t of crossyState.tiles){
                if(t.type==='rail'&&t.trainActive){
                    let dx=t.x-crossyState.camX;
                    if(dx>-100&&dx<logicalWidth){ctx.fillStyle='#c0392b';ctx.fillRect(dx+5,0,30,LOGICAL_HEIGHT);ctx.fillStyle='#FFF';ctx.fillRect(dx+10,Math.random()*LOGICAL_HEIGHT,2,50);}
                }
            }
        },
        update:function(dt){
            if(state.current!==state.game||userData.equippedSkin!=='crossy')return;
            updateCrossyLevel(dt);
            let tile=crossyState.tiles.find(t=>Math.abs(t.x-crossyState.birdWorldX)<10);
            if(tile){
                for(let o of crossyState.objects){
                    if(o.type==='coin'&&!o.collected&&o.tileX===tile.x&&Math.abs(bird.y-o.y)<30){
                        o.collected=true;userData.coins++;playSound('coin');document.getElementById('shopTriggerBtn').innerText=`SHOP (${userData.coins})`;saveData();
                    }
                }
                if(tile.type==='road'){
                    for(let o of crossyState.objects)if(o.type==='car'&&o.tileX===tile.x&&Math.abs(bird.y-o.y)<25){state.current=state.over;playSound('hit');}
                }else if(tile.type==='river'){
                    let onLog=false;
                    for(let o of crossyState.objects)if(o.type==='log'&&o.tileX===tile.x&&Math.abs(bird.y-o.y)<30){onLog=true;if(!bird.inAir)bird.y+=o.speed*dt;}
                    if(!onLog&&!bird.inAir){state.current=state.over;playSound('hit');}
                }else if(tile.type==='rail'&&tile.trainActive){
                    state.current=state.over;playSound('hit');
                }
            }
        }
    };

    const bird = {
        animation:[0,1,2,1],x:50,y:150,w:34,h:24,radius:12,frame:0,speed:0,gravity:0.25,jump:4.6,rotation:0,onGround:false,inAir:false,
        jumpStartPos:0,jumpEndPos:0,jumpTimer:0,jumpStartY:0,jumpEndY:0,jumps:0,sizeScale:1,deflating:false,
        moveCrossy:function(d){
            if(this.inAir)return;
            this.inAir=true;this.jumpTimer=0;this.jumpStartPos=crossyState.birdWorldX;this.jumpStartY=this.y;this.jumpEndY=this.y;
            if(d==='right'){this.jumpEndPos=this.jumpStartPos+40;score.value++;userData.highScore=Math.max(score.value,userData.highScore);saveData();}
            else if(d==='left')this.jumpEndPos=this.jumpStartPos-40;
            else if(d==='up'){this.jumpEndPos=this.jumpStartPos;this.jumpEndY=this.jumpStartY-40;}
            else if(d==='down'){this.jumpEndPos=this.jumpStartPos;this.jumpEndY=this.jumpStartY+40;}
            if(this.jumpEndY<20)this.jumpEndY=20;if(this.jumpEndY>LOGICAL_HEIGHT-20)this.jumpEndY=LOGICAL_HEIGHT-20;
            playSound('flap');
        },
        flap:function(){
            const s=userData.equippedSkin;
            if(s==='crossy'){if(state.current===state.game&&!this.inAir){this.moveCrossy('right');return true;}return false;}
            if(s==='gd'){if(this.onGround){this.speed=-8.8;this.onGround=false;return true;}return false;}
            else if(s==='mario'){if(this.onGround){this.speed=-8.5;this.onGround=false;return true;}return false;}
            else{this.speed=-this.jump;this.rotation=-25*DEGREE;return true;}
        },
        draw:function(){
            if(state.current===state.over&&(userData.equippedSkin==='gd'))return;
            let sp;
            if(userData.equippedSkin==='crossy'){
                sp=images.voxelChicken;if(!sp)return;
                ctx.save();let jy=0;if(this.inAir)jy=-Math.sin(this.jumpTimer*Math.PI)*20;
                ctx.translate(this.x,this.y+jy);ctx.drawImage(sp,-16,-16);ctx.restore();
                return;
            }
            if(state.current===state.over&&userData.equippedSkin==='amongus'){
                if(images.birdDeadAU){const i=new Image();i.src=images.birdDeadAU.toDataURL();sp=i;}
            }else if(userData.equippedSkin==='mario'){
                if(state.current===state.over)sp=images.marioDead;
                else if(!this.onGround&&state.current===state.game)sp=images.marioJump;
                else{let f=Math.floor((frames/5)%3);sp=(images.marioWalk&&images.marioWalk[f])?images.marioWalk[f]:images.marioWalk[0];}
            }else{
                if(images.birds&&images.birds[userData.equippedSkin]){let arr=images.birds[userData.equippedSkin];if(arr&&arr.length)sp=arr[this.animation[this.frame]];}
            }
            if(!sp)return;
            let dw=this.w,dh=this.h;
            if(userData.equippedSkin==='bigo'){dw=50*this.sizeScale;dh=50*this.sizeScale;}
            if(userData.equippedSkin==='gd'){dw=30;dh=30;}
            if(userData.equippedSkin==='mario'){dw=32;dh=32;}
            ctx.save();ctx.translate(this.x,this.y);
            let r=this.rotation;
            if(state.current===state.falling||userData.equippedSkin==='mario')r=0;
            ctx.rotate(r);
            if(sp.complete||sp instanceof HTMLCanvasElement){
                if(userData.equippedSkin==='mario')ctx.drawImage(sp,-16,-16,32,32);
                else ctx.drawImage(sp,-dw/2,-dh/2,dw,dh);
            }
            ctx.restore();
        },
        update:function(dt){
            if(this.deflating){
                this.sizeScale -= 0.05 * dt; 
                this.rotation = Math.sin(frames * 0.8) * 0.5; // Wobble effect
                if(this.sizeScale <= 1){ this.sizeScale = 1; this.deflating = false; }
            }
            
            if(flashOpacity>0)flashOpacity-=dt*0.05;
            let period=state.current===state.getReady?10:9;
            this.frame+=frames%period===0?1:0;this.frame%=this.animation.length;
            if(userData.equippedSkin==='bigo')this.radius=18*this.sizeScale;else if(userData.equippedSkin==='gd')this.radius=15;else if(['mario'].includes(userData.equippedSkin))this.radius=14;else this.radius=12;
            
            if(state.current===state.getReady){
                this.jumps=0;this.sizeScale=1;this.deflating=false;
                if(userData.equippedSkin==='gd'){this.y=LOGICAL_HEIGHT-112-15;this.rotation=0;this.speed=0;}
                else if(userData.equippedSkin==='mario'){this.y=LOGICAL_HEIGHT-112-16;this.rotation=0;this.speed=0;updateMarioLevel(dt);}
                else if(userData.equippedSkin==='crossy'){this.x=50;this.y=crossyState.groundY;this.rotation=0;this.speed=0;initCrossyLevel();}
                else if(userData.equippedSkin==='ufo'){this.y=100;this.rotation=0;this.speed=0;}
                else{this.y=150;this.rotation=0;this.speed=0;}
            }else if(state.current===state.falling){
                this.speed+=(this.gravity*1.5)*dt;this.y+=this.speed*dt;crackParams.width+=3*dt;
                if(this.y>LOGICAL_HEIGHT+60){state.current=state.over;flashOpacity=1;playSound('hit');}
            }else if(state.current===state.game){
                if(userData.equippedSkin==='crossy'){
                    if(this.inAir){
                        this.jumpTimer+=0.1*dt;if(this.jumpTimer>=1){this.jumpTimer=1;this.inAir=false;}
                        crossyState.birdWorldX=this.jumpStartPos+(this.jumpEndPos-this.jumpStartPos)*this.jumpTimer;
                        this.y=this.jumpStartY+(this.jumpEndY-this.jumpStartY)*this.jumpTimer;
                    }
                    this.x=(crossyState.birdWorldX+20)-crossyState.camX;
                    return;
                }
                let g=this.gravity;
                if(userData.equippedSkin==='gd'||userData.equippedSkin==='mario')g=0.45;
                this.speed+=g*dt;this.y+=this.speed*dt;
                
                if(userData.equippedSkin==='mario'){
                    if(state.current===state.over&&marioState.died)return;
                    let fy=LOGICAL_HEIGHT-112,gr=false,ax=marioState.camX+this.x;
                    for(let i=0;i<marioState.platforms.length;i++){
                        let p=marioState.platforms[i],px=p.x-marioState.camX;
                        if(this.x+this.radius>px&&this.x-this.radius<px+p.w){
                            let pb=p.y+32;
                            if(this.y+this.radius>=p.y&&this.y+this.radius<=p.y+16&&this.speed>=0){this.y=p.y-this.radius;this.speed=0;gr=true;}
                            else if(this.y-this.radius<=pb&&this.y-this.radius>=pb-16&&this.speed<0){
                                marioState.platforms.splice(i,1);i--;this.speed=0;debrisSystem.createBrickDebris(px+p.w/2,p.y+16);playSound('break');
                            }
                            else if(this.y-this.radius<pb&&this.y+this.radius>p.y+12){
                                if(state.current===state.game&&!marioState.died){state.current=state.over;marioState.died=true;flashOpacity=1;stopBGM();playSound('mario_die');bird.speed=-10;bird.onGround=false;}
                            }
                        }
                    }
                    let og=false;
                    for(let s of marioState.groundSegments){if(ax+this.radius>s.x&&ax-this.radius<s.x+s.w){og=true;break;}}
                    if(og){
                        if(this.y>=fy-16&&this.y<=fy+16&&this.speed>=0){this.y=fy-16;this.speed=0;gr=true;}
                    }else{
                        if(this.y>fy&&state.current===state.game&&!marioState.died){state.current=state.over;marioState.died=true;flashOpacity=1;stopBGM();playSound('mario_die');bird.speed=-10;bird.onGround=false;}
                    }
                    this.onGround=gr;
                    if(this.y>LOGICAL_HEIGHT+50&&state.current===state.game&&!marioState.died){state.current=state.over;marioState.died=true;flashOpacity=1;stopBGM();playSound('mario_die');}
                }else{
                    if(this.speed>=this.jump){if(userData.equippedSkin!=='gd'){this.rotation=90*DEGREE;this.frame=1;}}else{if(userData.equippedSkin!=='gd')this.rotation=-25*DEGREE;}
                    if(userData.equippedSkin==='gd'){
                        let fy=LOGICAL_HEIGHT-112-15;
                        if(this.y>=fy){this.y=fy;this.speed=0;this.onGround=true;let r=this.rotation/1.57;this.rotation=Math.round(r)*1.57;}else{this.rotation+=dt*0.04;}
                    }else{
                        let fy=LOGICAL_HEIGHT-112-this.h/2;
                        if(this.y>=fy){
                            if(userData.equippedSkin==='bigo'){
                                if(state.current===state.game){state.current=state.falling;screenShake=25;crackParams.active=true;crackParams.x=this.x;crackParams.width=10;playSound('hit');}
                            }else{
                                this.y=fy;
                                if(state.current===state.game){
                                    state.current=state.over;flashOpacity=1;
                                    if(userData.equippedSkin==='amongus')playSound('die');else playSound('hit');
                                    if(['clown','grenade'].includes(userData.equippedSkin))debrisSystem.createConfetti(this.x,this.y);
                                }
                            }
                        }
                    }
                }
            }else if(state.current===state.over){
                let g=this.gravity;
                if(userData.equippedSkin==='mario'&&marioState.died)g=0.45;
                this.speed+=g*dt;this.y+=this.speed*dt;
                if(['mario','crossy','bigo'].indexOf(userData.equippedSkin)===-1){
                    let fy=LOGICAL_HEIGHT-112-this.h/2;
                    if(this.y>=fy){this.y=fy;this.speed=0;this.rotation=90*DEGREE;}
                }
            }
        }
    };

    const pipes = { 
        position: [], w: 52, gap: 100, lastSpawn: 0, 
        update: function(dt) { 
            if (userData.equippedSkin === 'mario' || userData.equippedSkin === 'crossy') return; 
            if(state.current !== state.game) return; 
            this.lastSpawn += dt; 
            if(this.lastSpawn > 100) { 
                this.lastSpawn = 0; let sc = (userData.equippedSkin === 'gd')?Math.floor(Math.random()*3)+1:0; let hc=false; 
                if(userData.equippedSkin==='bigo')hc=true; else if(userData.equippedSkin==='gd')hc=Math.random()<0.5; else hc=Math.random()<0.4; 
                this.position.push({ x: logicalWidth, y: -150 * (Math.random() + 1), passed: false, hasCoin: hc, hasBurger: userData.equippedSkin === 'bigo', collected: false, broken: false, spikes: sc, timeOffset: Math.random() * 10 }); 
            } 
            for(let i=this.position.length-1; i>=0; i--) { 
                let p = this.position[i]; let cg=this.gap; let by=p.y+320+cg; let col=false; 
                if(userData.equippedSkin==='gd'){
                    let sy=LOGICAL_HEIGHT-112,bb=bird.y+bird.radius,br=bird.x+bird.radius,bl=bird.x-bird.radius,sw=p.spikes*30;
                    if(br>p.x+10&&bl<p.x+sw-10){if(bb>sy-20)col=true;}
                }else{
                    if(!p.broken){
                        let bt=p.y+320,bbot=by;
                        if(bird.x+bird.radius>p.x&&bird.x-bird.radius<p.x+this.w&&(bird.y-bird.radius<bt||bird.y+bird.radius>bbot))col=true;
                    }
                }
                if(col){
                    if(userData.equippedSkin==='bigo'){if(!p.broken){p.broken=true;debrisSystem.create(p.x+this.w/2,p.y+320);playSound('hit');screenShake=10;}}
                    else{
                        state.current=state.over;flashOpacity=1;playSound('hit');
                        if(userData.equippedSkin==='gd')debrisSystem.createGDExplosion(bird.x,bird.y);
                        if(userData.equippedSkin!=='amongus'&&userData.equippedSkin!=='gd')setTimeout(()=>playSound('die'),300);
                    }
                }
                let sc=false;
                if(userData.equippedSkin==='bigo'){
                    if(p.hasBurger&&!p.burgerCollected){
                        let cx=p.x+this.w/2,cy=p.y+320+this.gap/2;
                        if(Math.hypot(bird.x-cx,bird.y-cy)<35*bird.sizeScale){
                            p.burgerCollected=true;score.value++;userData.highScore=Math.max(score.value,userData.highScore);playSound('chomp');saveData();
                            if(!bird.deflating) {
                                bird.sizeScale += 0.15;
                                if(bird.sizeScale > 2.5) { bird.deflating = true; playSound('hit'); }
                            }
                        }
                    }
                }else if(userData.equippedSkin==='gd'){
                    if(!p.passed&&bird.x>p.x+(p.spikes*30))sc=true;
                }else{
                    if(!p.passed&&bird.x-bird.radius>p.x+this.w)sc=true;
                }
                if(sc){p.passed=true;score.value++;userData.highScore=Math.max(score.value,userData.highScore);playSound('point');saveData();if(userData.equippedSkin==='rabbit')bird.jumps=0;}
                if(p.hasCoin&&!p.coinCollected){
                    let cx=p.x+this.w/2,cy=p.y+320+cg/2;
                    if(userData.equippedSkin==='gd'){cx=p.x+(p.spikes*30)+60;cy=LOGICAL_HEIGHT-112-20;}
                    if(userData.equippedSkin==='bigo'){cx=p.x+120;cy=LOGICAL_HEIGHT/2;}
                    let d=30;
                    if(Math.hypot(bird.x-cx,bird.y-cy)<d){p.coinCollected=true;userData.coins++;saveData();playSound('coin');document.getElementById('shopTriggerBtn').innerText=`SHOP (${userData.coins})`;}
                }
                p.x-=getGameSpeed()*dt;
                if(p.x+150<=0){this.position.splice(i,1);}
            }
        },
        draw: function() { 
            if (userData.equippedSkin === 'mario' || userData.equippedSkin === 'crossy') return; 
            let isAU = userData.equippedSkin === 'amongus'; let isGD = userData.equippedSkin === 'gd'; 
            for(let p of this.position) { 
                if (!p.broken) { 
                    let cg=this.gap; 
                    if (isGD) { 
                        let fy = LOGICAL_HEIGHT - 112; ctx.fillStyle = '#333'; ctx.beginPath(); 
                        for(let i=0; i<p.spikes; i++) { let sx = p.x + (i * 30); ctx.moveTo(sx, fy); ctx.lineTo(sx + 15, fy - 30); ctx.lineTo(sx + 30, fy); } 
                        ctx.fill(); ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2; ctx.stroke(); 
                    } else { 
                        let ty = p.y; let by = p.y + 320 + cg; 
                        if (images.pipe) { 
                            ctx.save(); if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)'; 
                            ctx.translate(p.x + this.w/2, ty + 160); ctx.rotate(Math.PI); ctx.drawImage(images.pipe, -this.w/2, -160, this.w, 320); ctx.restore(); 
                            ctx.save(); if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)'; 
                            ctx.drawImage(images.pipe, p.x, by); ctx.restore(); 
                        } else { 
                            ctx.fillStyle = "green"; ctx.fillRect(p.x, ty, this.w, 320); ctx.fillRect(p.x, by, this.w, 320); 
                        } 
                    } 
                } 
                let cg=this.gap; 
                if(p.hasBurger&&!p.burgerCollected&&images.burger){ctx.drawImage(images.burger,p.x+this.w/2-12,p.y+320+cg/2-10);} 
                if(p.hasCoin&&!p.coinCollected){
                    let cx=p.x+this.w/2,cy=p.y+320+cg/2;
                    if(isGD){cx=p.x+(p.spikes*30)+60;cy=LOGICAL_HEIGHT-112-20;}
                    if(userData.equippedSkin==='bigo'){cx=p.x+120;cy=LOGICAL_HEIGHT/2;}
                    ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(cx,cy,10,0,6.28);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='#FFF';ctx.font='12px FlappyFont';ctx.fillText("$",cx-3,cy+3);
                } 
            } 
        } 
    };

    const score = { value: 0, draw: function() { ctx.fillStyle = '#FFF'; ctx.strokeStyle = '#000'; if (state.current === state.game) { ctx.lineWidth = 2; ctx.font = '35px FlappyFont'; let text = this.value; if (userData.equippedSkin === 'mario') text = marioState.timer.toFixed(2); ctx.fillText(text, logicalWidth / 2, 50); ctx.strokeText(text, logicalWidth / 2, 50); } }, reset: function() { this.value = 0; } };

    const Input = {
        active: 'mouse', focusIndex: 1, navContext: 'menu', lastAxis: 0, btnPressed: false, held: false,
        update: function() { const pads = navigator.getGamepads ? navigator.getGamepads() : []; const pad = pads[0]; if (pad) this.handleGamepad(pad); },
        handleGamepad: function(pad) { const axisX = pad.axes[0]; const axisY = pad.axes[1]; const btnA = pad.buttons[0].pressed; const btnB = pad.buttons[1].pressed; const dpadLeft = pad.buttons[14].pressed; const dpadRight = pad.buttons[15].pressed; const dpadUp = pad.buttons[12].pressed; const dpadDown = pad.buttons[13].pressed; let move = 0; if (axisX < -0.5 || dpadLeft) move = -1; else if (axisX > 0.5 || dpadRight) move = 1; if (this.navContext === 'menu' || this.navContext === 'shop') { if (move !== 0 && this.lastAxis === 0) { this.moveFocus(move); this.active = 'gamepad'; resumeAudio(); } } else if (this.navContext === 'settings') { let vMove = 0; if (axisY < -0.5 || dpadUp) vMove = -1; else if (axisY > 0.5 || dpadDown) vMove = 1; if (vMove !== 0 && this.lastAxis === 0) { this.moveFocus(vMove); this.active = 'gamepad'; resumeAudio(); } if (move !== 0 && this.lastAxis === 0) { this.changeSetting(move); } } this.lastAxis = (Math.abs(axisX) > 0.5 || Math.abs(axisY) > 0.5 || dpadLeft || dpadRight || dpadUp || dpadDown) ? 1 : 0; 
        this.held = btnA; if (btnA && !this.btnPressed) { this.btnPressed = true; this.active = 'gamepad'; resumeAudio(); this.triggerAction(); } else if (!btnA) { this.btnPressed = false; } if (btnB && (this.navContext === 'shop' || this.navContext === 'settings')) { this.closeModal(); } },
        moveFocus: function(dir) { let max = 0; if (this.navContext === 'menu') max = 2; if (this.navContext === 'shop') max = shopConfig.length - 1; if (this.navContext === 'settings') max = 2; this.focusIndex += dir; if (this.focusIndex < 0) this.focusIndex = max; if (this.focusIndex > max) this.focusIndex = 0; this.renderFocus(); },
        renderFocus: function() { document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused')); if (this.navContext === 'menu') { const btns = [ document.getElementById('shopTriggerBtn'), document.getElementById('startTriggerBtn'), document.getElementById('settingsTriggerBtn') ]; if(btns[this.focusIndex]) btns[this.focusIndex].classList.add('focused'); } else if (this.navContext === 'shop') { const items = document.querySelectorAll('.shop-item'); if(items[this.focusIndex]) { items[this.focusIndex].classList.add('focused'); items[this.focusIndex].scrollIntoView({block: 'center', behavior: 'smooth'}); } } else if (this.navContext === 'settings') { if(this.focusIndex===0) document.querySelector('.custom-select').classList.add('focused'); if(this.focusIndex===1) document.getElementById('fullscreenToggle').classList.add('focused'); if(this.focusIndex===2) document.getElementById('exportDataBtn').classList.add('focused'); } },
        triggerAction: function() { 
            if (this.navContext === 'shop') { const item = shopConfig[this.focusIndex]; handleShopClick(item); return; } 
            if (this.navContext === 'settings') { 
                if (this.focusIndex === 1) document.getElementById('fullscreenToggle').click(); 
                if (this.focusIndex === 0) { 
                    const arr = ['retro', 'native', '720', '1080']; let idx = arr.indexOf(gameSettings.resolution); 
                    idx = (idx+1)%arr.length; gameSettings.resolution = arr[idx]; 
                    localStorage.setItem('fb_res', gameSettings.resolution); 
                    document.getElementById('currentResDisplay').innerText = document.querySelector(`div[data-value="${gameSettings.resolution}"]`).innerText; 
                    resize(); 
                } 
                if(this.focusIndex === 2) { openDataModal('export'); } 
                return; 
            } 
            if (state.current === state.game) { if(bird.flap()) playSound('flap'); return; } 
            if (state.current === state.over) { resetGame(); state.current = state.getReady; return; } 
            if (this.navContext === 'menu') { 
                if (this.focusIndex === 0) document.getElementById('shopTriggerBtn').click(); 
                else if (this.focusIndex === 1) { 
                    state.current = state.game; if(bird.flap()) playSound('flap'); 
                    if (userData.equippedSkin === 'mario') startBGM(); 
                } 
                else if (this.focusIndex === 2) document.getElementById('settingsTriggerBtn').click(); 
            } 
        },
        changeSetting: function(dir) { if (this.focusIndex === 0) { const arr = ['retro', 'native', '720', '1080']; let idx = arr.indexOf(gameSettings.resolution) + dir; if(idx < 0) idx = arr.length-1; if(idx >= arr.length) idx = 0; gameSettings.resolution = arr[idx]; localStorage.setItem('fb_res', gameSettings.resolution); document.getElementById('currentResDisplay').innerText = document.querySelector(`div[data-value="${gameSettings.resolution}"]`).innerText; resize(); } },
        openModal: function(context) { this.navContext = context; this.focusIndex = 0; setTimeout(() => this.renderFocus(), 50); },
        closeModal: function() { if (this.navContext === 'shop') document.getElementById('closeShopX').click(); if (this.navContext === 'settings') document.getElementById('closeSettingsX').click(); this.navContext = 'menu'; this.focusIndex = 1; this.renderFocus(); }
    };

    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save(); if (globalScale !== 1) ctx.scale(globalScale, globalScale);
        bg.draw(); 
        pipes.draw(); marioObjects.draw(); crossyObjects.draw(); debrisSystem.draw(); fg.draw(); bird.draw(); score.draw(); 
        if (flashOpacity > 0) { ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`; ctx.fillRect(0, 0, logicalWidth, LOGICAL_HEIGHT); }
        // D-Pad Visibility
        const dpad = document.getElementById('crossy-controls');
        if (userData.equippedSkin === 'crossy' && state.current === state.game && isTouch) dpad.style.display = 'flex'; else dpad.style.display = 'none';
        // UI
        if (state.current === state.getReady) {
            if (images.msg) ctx.drawImage(images.msg, logicalWidth/2 - images.msg.width/2, 100);
            document.getElementById('shopTriggerBtn').style.display = 'block'; document.getElementById('startTriggerBtn').style.display = 'block'; document.getElementById('settingsTriggerBtn').style.display = 'block'; document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`;
        } else if (state.current === state.over) {
            document.getElementById('shopTriggerBtn').style.display = 'none'; document.getElementById('startTriggerBtn').style.display = 'none'; document.getElementById('settingsTriggerBtn').style.display = 'none';
            let centerX = logicalWidth / 2;
            if (images.gameover) ctx.drawImage(images.gameover, centerX - images.gameover.width/2, 80);
            ctx.fillStyle = '#DED895'; ctx.fillRect(centerX - 100, 140, 200, 110); ctx.strokeRect(centerX - 100, 140, 200, 110);
            ctx.fillStyle = '#E57338'; ctx.font = '18px FlappyFont'; ctx.textAlign = 'left'; ctx.fillText("SCORE", centerX - 85, 170); ctx.fillText("BEST", centerX - 85, 210);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'right';
            let displayScore = score.value; let displayHigh = userData.highScore;
            if (userData.equippedSkin === 'mario') { displayScore = marioState.timer.toFixed(2) + "s"; }
            ctx.fillText(displayScore, centerX + 70, 170); ctx.fillText(displayHigh, centerX + 70, 210);
            ctx.fillStyle = '#73BF2E'; ctx.fillRect(centerX - 41, 263, 83, 35); ctx.strokeRect(centerX - 41, 263, 83, 35);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'center'; ctx.fillText("RESTART", centerX, 288);
            if(score.value >= 10) { ctx.fillStyle = score.value >= 20 ? '#FFD700' : '#C0C0C0'; ctx.beginPath(); ctx.arc(centerX - 65, 195, 18, 0, 6.28); ctx.fill(); ctx.stroke(); }
        } else {
            document.getElementById('shopTriggerBtn').style.display = 'none'; document.getElementById('startTriggerBtn').style.display = 'none'; document.getElementById('settingsTriggerBtn').style.display = 'none';
        }
        ctx.restore(); 
    }

    function resetGame() { 
        stopBGM(); bird.speed = 0; bird.y = 150; pipes.position = []; score.value = 0; frames = 0; 
        debrisSystem.particles = []; crackParams={active:false,width:0,x:0}; pipes.lastSpawn = 0; flashOpacity = 0;
        if (userData.equippedSkin === 'mario') initMarioLevel();
        if (userData.equippedSkin === 'crossy') initCrossyLevel();
        Input.focusIndex = 1; Input.renderFocus();
    }
    
    function saveData() { localStorage.setItem('fb_highScore', userData.highScore); localStorage.setItem('fb_coins', userData.coins); localStorage.setItem('fb_skins', JSON.stringify(userData.unlockedSkins)); localStorage.setItem('fb_equipped', userData.equippedSkin); }
    
    // Updated Shop Config
    const shopConfig=[
        {id:'yellow',name:'Original',price:0},
        {id:'bigo',name:'Big O',price:10},
        {id:'amongus',name:'Among Us',price:5},
        {id:'gd',name:'Dash',price:25},
        {id:'crossy',name:'Crossy',price:75},
        {id:'mario',name:'Mario',price:40}
    ];

    async function initGame() {
        const audioProms = Object.keys(ASSETS.audio).map(k => loadSound(ASSETS.audio[k], k));
        const loadImg = (src) => new Promise(r => { const img = new Image(); if(!src.startsWith('data')) img.crossOrigin = "anonymous"; img.onload = () => r(img); img.onerror = () => r(null); img.src = src; });
        images.bg = await loadImg(ASSETS.sprites.bg); images.base = await loadImg(ASSETS.sprites.base); images.pipe = await loadImg(ASSETS.sprites.pipe); images.msg = await loadImg(ASSETS.sprites.msg); images.gameover = await loadImg(ASSETS.sprites.gameover);
        images.marioBrick = await loadImg(ASSETS.sprites.marioBrick); images.marioGround = await loadImg(ASSETS.sprites.marioGround); images.marioJump = await loadImg(ASSETS.sprites.marioJump); images.marioDead = await loadImg(ASSETS.sprites.marioDead);
        images.marioWalk = []; for(let url of ASSETS.sprites.marioWalk) images.marioWalk.push(await loadImg(url));
        images.marioCoin = []; for(let url of ASSETS.sprites.marioCoin) images.marioCoin.push(await loadImg(url));
        images.marioGoomba = []; for(let url of ASSETS.sprites.marioGoomba) images.marioGoomba.push(await loadImg(url));

        images.bgSpace = Gen.space(); images.birdDeadAU = Gen.au_dead(); images.burger = Gen.burger(); 
        images.voxelChicken = Gen.crossy(); images.voxelCar = Gen.car(); images.log = Gen.log();
        
        images.birds = {};
        const proceduralMap = { amongus: Gen.au, bigo: Gen.bigo, gd: Gen.gd, crossy: Gen.crossy };
        
        for(let s of shopConfig) {
             let id = s.id;
             if (id === 'mario') { images.birds[id] = images.marioWalk; continue; }
             if (id === 'crossy') { images.birds[id] = [images.voxelChicken]; continue; }
             if (proceduralMap[id]) { let a = proceduralMap[id](); images.birds[id] = [a,a,a]; continue; }
             if (id === 'yellow') {
                 const arr = []; for(let u of ASSETS.sprites.birdYellow) arr.push(await loadImg(u));
                 images.birds.yellow = arr;
             }
        }

        // Initialize UI
        const container = document.getElementById('shopItemsContainer'); container.innerHTML = '';
        shopConfig.sort((a,b)=>a.price-b.price);
        shopConfig.forEach(item => {
            const div=document.createElement('div'); div.className='shop-item'; div.id=`shop-item-${item.id}`; div.onclick=(e)=>{e.stopPropagation();handleShopClick(item);};
            const img=document.createElement('img');
            if(item.id==='mario') img.src=MARIO_BASE_URL+"walk1.png";
            else if(proceduralMap[item.id]) img.src = proceduralMap[item.id]().toDataURL();
            else if(item.id==='yellow') img.src="https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png";
            const name=document.createElement('div'); name.innerText=item.name; name.style.fontSize='12px'; name.style.marginTop='5px';
            const cost=document.createElement('div'); cost.className='item-cost';
            div.appendChild(img);div.appendChild(name);div.appendChild(cost);container.appendChild(div);
        });
        updateShopUI();
        await Promise.all(audioProms);
        document.getElementById('loading-overlay').style.display = 'none';
        if(userData.equippedSkin === 'mario') initMarioLevel();
        if(userData.equippedSkin === 'crossy') initCrossyLevel();
        requestAnimationFrame(loop);
    }
    initGame();

    // UI Helpers
    function updateShopUI(){document.getElementById('shopCoinCount').innerText=userData.coins;shopConfig.forEach(i=>{const e=document.getElementById(`shop-item-${i.id}`),c=e.querySelector('.item-cost'),u=userData.unlockedSkins.includes(i.id),q=userData.equippedSkin===i.id;e.classList.remove('locked','selected');if(!u)e.classList.add('locked');if(q)e.classList.add('selected');c.innerText=q?"EQUIPPED":(u?"OWNED":`${i.price} COINS`);if(Input.navContext==='shop'&&Input.focusIndex===shopConfig.indexOf(i))e.classList.add('focused');else e.classList.remove('focused');});}
    function handleShopClick(i){if(userData.unlockedSkins.includes(i.id)){userData.equippedSkin=i.id;playSound('flap');if(i.id==='mario')initMarioLevel();else if(i.id==='crossy')initCrossyLevel();else stopBGM();}else{if(userData.coins>=i.price){userData.coins-=i.price;userData.unlockedSkins.push(i.id);userData.equippedSkin=i.id;playSound('point');if(i.id==='mario')initMarioLevel();else if(i.id==='crossy')initCrossyLevel();else stopBGM();}else playSound('hit');}saveData();updateShopUI();}
    document.getElementById('shopTriggerBtn').onclick=(e)=>{e.stopPropagation();updateShopUI();document.getElementById('shop-modal').style.display='flex';Input.openModal('shop');};document.getElementById('startTriggerBtn').onclick=(e)=>{e.stopPropagation();state.current=state.game;if(bird.flap())playSound('flap');if(userData.equippedSkin==='mario')startBGM();};document.getElementById('settingsTriggerBtn').onclick=(e)=>{e.stopPropagation();document.getElementById('settings-modal').style.display='flex';Input.openModal('settings');};document.getElementById('closeShopX').onclick=(e)=>{e.stopPropagation();document.getElementById('shop-modal').style.display='none';Input.closeModal();};document.getElementById('closeSettingsX').onclick=(e)=>{e.stopPropagation();document.getElementById('settings-modal').style.display='none';Input.closeModal();};
    const handleInputDown=(e)=>{Input.held=true;if(document.getElementById('shop-modal').style.display==='flex'||document.getElementById('settings-modal').style.display==='flex')return;if(state.current===state.over){let c=getGameCoords(e),cx=logicalWidth/2;if(c.x>=cx-41&&c.x<=cx+42&&c.y>=263&&c.y<=298){resetGame();state.current=state.getReady;}return;}if(state.current===state.getReady){state.current=state.game;if(userData.equippedSkin==='mario')startBGM();}if(state.current===state.game){if(bird.flap()){playSound('flap');lastFlapFrame=frames;}}};
    function getGameCoords(e){let r=canvas.getBoundingClientRect();return{x:(e.clientX-r.left)*(canvas.width/r.width)/globalScale,y:(e.clientY-r.top)*(canvas.height/r.height)/globalScale};}
    const handleInputUp=()=>{Input.held=false;};canvas.addEventListener('pointerdown',handleInputDown);canvas.addEventListener('pointerup',handleInputUp);canvas.addEventListener('pointerleave',handleInputUp);
    
    // Data Modal logic
    const dataModal=document.getElementById('data-io-modal'),ioTitle=document.getElementById('io-title'),ioTextarea=document.getElementById('io-textarea'),ioActionBtn=document.getElementById('io-action-btn');let ioMode='export';
    function openDataModal(m){ioMode=m;dataModal.style.display='flex';if(m==='export'){ioTitle.innerText="EXPORT DATA";ioActionBtn.innerText="COPY";try{ioTextarea.value=btoa(JSON.stringify(userData));}catch(e){ioTextarea.value="Error";}ioTextarea.readOnly=true;}else{ioTitle.innerText="IMPORT DATA";ioActionBtn.innerText="LOAD";ioTextarea.value="";ioTextarea.readOnly=false;ioTextarea.focus();}}
    document.getElementById('exportDataBtn').onclick=(e)=>{e.stopPropagation();openDataModal('export');};document.getElementById('importDataBtn').onclick=(e)=>{e.stopPropagation();openDataModal('import');};document.getElementById('closeDataX').onclick=(e)=>{e.stopPropagation();dataModal.style.display='none';};
    ioActionBtn.onclick=(e)=>{e.stopPropagation();if(ioMode==='export'){ioTextarea.select();document.execCommand('copy');ioActionBtn.innerText="COPIED!";setTimeout(()=>ioActionBtn.innerText="COPY",1500);}else{try{const d=JSON.parse(atob(ioTextarea.value.trim()));if(d&&typeof d.coins==='number'){userData=d;saveData();ioActionBtn.innerText="LOADED!";updateShopUI();document.getElementById('shopTriggerBtn').innerText=`SHOP (${userData.coins})`;resetGame();setTimeout(()=>{dataModal.style.display='none';ioActionBtn.innerText="LOAD";},1000);}else ioActionBtn.innerText="INVALID";}catch(e){ioActionBtn.innerText="ERROR";}}};
    function toggleFullscreen(){if(!document.fullscreenElement){document.documentElement.requestFullscreen().catch(e=>{});document.getElementById('fullscreenToggle').innerText="ON";document.getElementById('fullscreenToggle').classList.remove('off');}else{document.exitFullscreen();document.getElementById('fullscreenToggle').innerText="OFF";document.getElementById('fullscreenToggle').classList.add('off');}}document.getElementById('fullscreenToggle').onclick=(e)=>{e.stopPropagation();toggleFullscreen();};
    
    const dpadUp=document.getElementById('c-up'),dpadDown=document.getElementById('c-down'),dpadLeft=document.getElementById('c-left'),dpadRight=document.getElementById('c-right');
    function handleDpad(e,d){e.preventDefault();e.stopPropagation();if(state.current===state.game&&userData.equippedSkin==='crossy')bird.moveCrossy(d);}
    [dpadUp,dpadDown,dpadLeft,dpadRight].forEach(b=>['touchstart','mousedown'].forEach(ev=>b.addEventListener(ev,e=>handleDpad(e,b.id.replace('c-','')))));
    window.addEventListener('keydown',e=>{resumeAudio();if(e.repeat)return;if(dataModal.style.display==='flex'){if(e.code==='Escape')dataModal.style.display='none';return;}if(Input.navContext==='shop'||Input.navContext==='settings'){Input.active='gamepad';switch(e.code){case 'ArrowLeft':if(Input.navContext==='settings')Input.changeSetting(-1);else Input.moveFocus(-1);break;case 'ArrowRight':if(Input.navContext==='settings')Input.changeSetting(1);else Input.moveFocus(1);break;case 'ArrowUp':if(Input.navContext==='shop')Input.moveFocus(-3);else Input.moveFocus(-1);break;case 'ArrowDown':if(Input.navContext==='shop')Input.moveFocus(3);else Input.moveFocus(1);break;case 'Enter':case 'Space':Input.triggerAction();break;case 'Escape':case 'Backspace':Input.closeModal();break;}return;}if(state.current===state.game&&userData.equippedSkin==='crossy'){switch(e.code){case 'ArrowUp':case 'KeyW':bird.moveCrossy('up');return;case 'ArrowDown':case 'KeyS':bird.moveCrossy('down');return;case 'ArrowLeft':case 'KeyA':bird.moveCrossy('left');return;case 'ArrowRight':case 'KeyD':bird.moveCrossy('right');return;}}if(state.current===state.game){if(['Space','ArrowUp','Enter','KeyW'].includes(e.code))if(bird.flap())playSound('flap');return;}Input.active='gamepad';switch(e.code){case 'ArrowLeft':Input.moveFocus(-1);break;case 'ArrowRight':Input.moveFocus(1);break;case 'Enter':case 'Space':if(Input.navContext==='menu')Input.triggerAction();else if(state.current===state.getReady){if(document.getElementById('shop-modal').style.display!=='flex'&&document.getElementById('settings-modal').style.display!=='flex'){state.current=state.game;if(bird.flap())playSound('flap');if(userData.equippedSkin==='mario')startBGM();}}break;case 'Escape':case 'Backspace':Input.closeModal();break;}});
</script>
</body>
</html>
