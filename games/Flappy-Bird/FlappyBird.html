<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird Pro</title>
    <style>
        @font-face {
            font-family: 'FlappyFont';
            src: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/fonts/04B_19__.TTF') format('truetype');
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent scrolling */
            touch-action: none;
            font-family: 'FlappyFont', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            background-color: #70c5ce;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            /* Critical for the optimization: ensures the low-res canvas looks sharp when stretched */
            image-rendering: pixelated; 
        }

        /* UI Elements */
        #shopTriggerBtn {
            position: absolute;
            bottom: 5vh; 
            left: 50%;
            transform: translateX(-50%);
            background: #E57338;
            border: 2px solid #FFF;
            color: white;
            padding: 10px 20px;
            font-family: 'FlappyFont', sans-serif;
            font-size: 3vh; 
            cursor: pointer;
            text-shadow: 2px 2px 0 #000;
            box-shadow: 0 4px 0 #9e4f24;
            display: none;
            text-transform: uppercase;
            z-index: 10;
            white-space: nowrap;
        }
        
        #shopTriggerBtn:active {
            transform: translateX(-50%) translateY(4px);
            box-shadow: none;
        }

        #shop-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: white;
            padding-top: 5vh;
            box-sizing: border-box;
        }

        #shop-modal h2 {
            margin: 0 0 2vh 0;
            font-size: 5vh;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
        }

        .coin-display {
            font-size: 3vh;
            margin-bottom: 2vh;
            color: #FFF;
        }

        .shop-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            gap: 10px;
            width: 90%;
            height: 70%;
            overflow-y: auto;
            padding: 5px;
        }

        .shop-item {
            background: #4ec0ca;
            border: 2px solid #fff;
            padding: 5px;
            width: 100px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            flex-shrink: 0;
        }

        .shop-item.locked { filter: grayscale(1); opacity: 0.6; }
        .shop-item.selected { border-color: #FFD700; background: #fff; color: #333; }
        .shop-item img { width: 50px; margin-bottom: 5px; object-fit: contain; }
        .item-cost { font-size: 16px; text-align: center; }

        .close-x {
            position: absolute;
            top: 2vh;
            right: 2vh;
            left: auto;
            background: #d32f2f;
            border: 2px solid #FFF;
            color: white;
            font-family: 'FlappyFont', sans-serif;
            font-size: 3vh;
            width: 5vh;
            height: 5vh;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 0 #8b0000;
        }
        .close-x:active { transform: translateY(2px); box-shadow: none; }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #70c5ce;
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            text-shadow: 2px 2px 0 #000;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="loading-overlay">LOADING...</div>
    <button id="shopTriggerBtn">SHOP</button>

    <div id="shop-modal">
        <button id="closeShopX" class="close-x">X</button>
        <h2>SKIN SHOP</h2>
        <div class="coin-display">COINS: <span id="shopCoinCount">0</span></div>
        <div class="shop-items" id="shopItemsContainer"></div>
    </div>
</div>

<script>
    // --- 1. Configuration & Assets ---
    const ASSETS = {
        sprites: {
            bg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png",
            base: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/base.png",
            pipe: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png",
            msg: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/message.png",
            gameover: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/gameover.png",
            birdYellow: [
                "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-downflap.png",
                "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png",
                "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-upflap.png"
            ]
        },
        audio: {
            flap: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/wing.wav",
            point: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/point.wav",
            hit: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/hit.wav",
            die: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/die.wav",
            coin: "https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/audio/swoosh.wav",
            au_point: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Task%20Complete.mp3",
            au_kill: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Impostor%20Kill.mp3",
            bigo_flap: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Stomp.mp3",
            bigo_chomp: "https://raw.githubusercontent.com/JasenC4PlaysOfficial/Html-Games/main/games/Flappy-Bird/Chomp.mp3"
        }
    };

    // --- 2. Asset Generators (Robust Polyfills) ---
    function drawRoundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
    }

    function createAmongUsAsset(type) {
        const cvs = document.createElement('canvas'); cvs.width = 34; cvs.height = 24; const cx = cvs.getContext('2d');
        const color = '#C51111'; const visor = '#9ECEF5';
        if (type === 'dead') {
            cx.fillStyle='#DDD'; cx.fillRect(14,8,6,8); cx.beginPath(); cx.arc(14,8,3,0,Math.PI*2); cx.fill(); cx.beginPath(); cx.arc(20,8,3,0,Math.PI*2); cx.fill();
            cx.fillStyle=color; cx.beginPath(); cx.moveTo(6,16); cx.lineTo(28,16); cx.lineTo(28,20); cx.quadraticCurveTo(28,24,24,24); cx.lineTo(10,24); cx.quadraticCurveTo(6,24,6,20); cx.fill(); cx.stroke();
        } else {
            cx.fillStyle=color; drawRoundRect(cx, 0,6,10,14,2); cx.fill(); cx.stroke();
            cx.beginPath(); drawRoundRect(cx, 6,2,22,22,8); cx.fill(); cx.stroke();
            cx.fillStyle=visor; cx.beginPath(); cx.ellipse(22,9,8,5,0,0,Math.PI*2); cx.fill(); cx.stroke();
            cx.fillStyle='#FFF'; cx.beginPath(); cx.ellipse(20,7,4,2,0,0,Math.PI*2); cx.fill();
        }
        return cvs;
    }

    function createBigOAsset() {
        const cvs = document.createElement('canvas'); cvs.width = 44; cvs.height = 34; const cx = cvs.getContext('2d');
        cx.fillStyle='#F5CBA7'; cx.beginPath(); cx.arc(22,17,16,0,Math.PI*2); cx.fill();
        cx.fillStyle='#2980B9'; cx.beginPath(); cx.arc(22,28,16,Math.PI,0); cx.fill(); 
        cx.fillStyle='#4A235A'; cx.beginPath(); cx.arc(22,17,16,0.2,2.9); cx.lineTo(22,22); cx.fill();
        cx.fillStyle='#000'; cx.beginPath(); cx.arc(16,14,2,0,Math.PI*2); cx.fill(); cx.beginPath(); cx.arc(28,14,2,0,Math.PI*2); cx.fill();
        cx.strokeStyle='#000'; cx.lineWidth=2; cx.beginPath(); cx.arc(22,17,16,0,Math.PI*2); cx.stroke();
        return cvs;
    }

    function createGDAsset() {
        const cvs = document.createElement('canvas'); cvs.width=30; cvs.height=30; const cx=cvs.getContext('2d');
        cx.fillStyle = '#FFD700'; cx.fillRect(0,0,30,30);
        cx.fillStyle = '#000'; cx.fillRect(6,6,6,6); cx.fillRect(18,6,6,6); cx.fillRect(6,18,18,4);
        cx.strokeStyle = '#000'; cx.lineWidth = 2; cx.strokeRect(1,1,28,28);
        return cvs;
    }

    function createBurgerAsset() {
        const cvs = document.createElement('canvas'); cvs.width=24; cvs.height=20; const cx=cvs.getContext('2d');
        cx.fillStyle='#E67E22'; cx.fillRect(2,14,20,4); cx.fillStyle='#2ECC71'; cx.fillRect(1,12,22,2);
        cx.fillStyle='#6E2C00'; cx.fillRect(2,8,20,4); cx.fillStyle='#E67E22'; cx.beginPath(); cx.arc(12,8,10,Math.PI,0); cx.fill();
        cx.fillStyle='#F5B7B1'; cx.fillRect(8,2,2,2); cx.fillRect(14,3,2,2); cx.fillRect(11,5,2,2);
        cx.strokeStyle='#000'; cx.lineWidth=1; cx.strokeRect(2,14,20,4);
        return cvs;
    }

    function createSpaceBg() {
        const cvs = document.createElement('canvas'); cvs.width=320; cvs.height=480; const cx=cvs.getContext('2d');
        cx.fillStyle='#050510'; cx.fillRect(0,0,320,480); cx.fillStyle='#FFF';
        for(let i=0; i<100; i++) { cx.globalAlpha=Math.random(); cx.fillRect(Math.random()*320, Math.random()*480, 1, 1); }
        cx.globalAlpha=1.0; return cvs;
    }

    // --- 3. Audio Engine ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const soundBuffers = {};

    async function loadSound(url, key) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
        } catch(e) { console.warn("Failed loading sound:", key); }
    }

    function playSound(name) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        let key = name;
        if (userData.equippedSkin === 'amongus') {
            if (name === 'point') key = 'au_point';
            else if (name === 'hit' || name === 'die') key = 'au_kill';
        } else if (userData.equippedSkin === 'bigo') {
            if (name === 'flap') key = 'bigo_flap';
            if (name === 'chomp') key = 'bigo_chomp'; 
        }
        const buffer = soundBuffers[key];
        if (buffer) {
            const src = audioCtx.createBufferSource();
            src.buffer = buffer;
            src.connect(audioCtx.destination);
            src.start(0);
        }
    }

    // --- 4. Game State & Optimized Scaling System ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // OPTIMIZATION: Always false to ensure sharp pixels on low-res canvas
    ctx.imageSmoothingEnabled = false;

    // SCALING LOGIC
    // We now use a fixed internal height of 480px.
    // The width adapts to the screen aspect ratio.
    const LOGICAL_HEIGHT = 480;
    let logicalWidth = 320; 

    function resize() {
        const scale = window.innerHeight / LOGICAL_HEIGHT;
        
        // OPTIMIZATION: Set canvas dimensions to small logic units
        // CSS will stretch this to fullscreen via GPU
        canvas.height = LOGICAL_HEIGHT;
        canvas.width = Math.ceil(window.innerWidth / scale);
        
        if (canvas.width < 320) canvas.width = 320; // Min width safeguard
        
        logicalWidth = canvas.width;
        ctx.imageSmoothingEnabled = false;
    }
    window.addEventListener('resize', resize);
    resize();

    let frames = 0;
    let screenShake = 0;
    const DEGREE = Math.PI / 180;
    const state = { current: 0, getReady: 0, game: 1, over: 2, falling: 3 };

    let userData = {
        highScore: parseInt(localStorage.getItem('fb_highScore')) || 0,
        coins: parseInt(localStorage.getItem('fb_coins')) || 0,
        unlockedSkins: JSON.parse(localStorage.getItem('fb_skins')) || ['yellow', 'amongus', 'bigo', 'gd'],
        equippedSkin: localStorage.getItem('fb_equipped') || 'yellow'
    };

    const images = {};
    let debris = [];
    let crackParams = { active: false, width: 0, x: 0 }; 

    function getGameSpeed() {
        if (userData.equippedSkin === 'gd') return 5;
        return 2;
    }

    // --- 5. Game Objects ---
    const bg = {
        draw: function() {
            ctx.save();
            if(screenShake > 0) {
                let dx = (Math.random() - 0.5) * screenShake;
                let dy = (Math.random() - 0.5) * screenShake;
                ctx.translate(dx, dy);
                screenShake *= 0.9;
                if(screenShake < 0.5) screenShake = 0;
            }

            let cur = (userData.equippedSkin === 'amongus') ? images.bgSpace : images.bg;
            if(cur) {
                const bgW = 276; 
                // Optimization: Only draw enough tiles to fill current width
                const count = Math.ceil(logicalWidth / bgW) + 1;
                for(let i=0; i<count; i++) {
                    ctx.drawImage(cur, i * bgW, LOGICAL_HEIGHT - 512); 
                }
            } else {
                ctx.fillStyle = "#70c5ce";
                ctx.fillRect(0, 0, logicalWidth, LOGICAL_HEIGHT);
            }
            
            ctx.restore(); 
        }
    };

    const fg = {
        h: 112, x: 0, 
        draw: function() {
            if (images.base) {
                ctx.save();
                if (userData.equippedSkin === 'amongus') {
                    ctx.filter = 'hue-rotate(220deg) saturate(1.5) brightness(0.8)';
                }
                
                let floorY = LOGICAL_HEIGHT - 112;
                const baseW = 336;
                const count = Math.ceil(logicalWidth / baseW) + 1;
                for(let i=0; i<count; i++) {
                     ctx.drawImage(images.base, this.x + (i * baseW), floorY);
                }
                
                if (crackParams.active) {
                     ctx.fillStyle = "#000";
                     ctx.fillRect(crackParams.x - crackParams.width/2, floorY, crackParams.width, 112);
                }

                ctx.restore();
            }
        },
        update: function() {
            if (state.current === state.game || state.current === state.getReady) {
                this.x = (this.x - getGameSpeed()) % 336;
            }
        }
    };

    const bird = {
        animation: [0, 1, 2, 1], x: 50, y: 150, w: 34, h: 24, radius: 12,
        frame: 0, speed: 0, gravity: 0.25, jump: 4.6, rotation: 0, onGround: false,
        flap: function() {
            if (userData.equippedSkin === 'gd') {
                if (this.onGround) {
                    this.speed = -8.8; 
                    this.onGround = false;
                }
            } else {
                this.speed = -this.jump;
                this.rotation = -25 * DEGREE;
            }
        },
        draw: function() {
            let sprite;
            if (state.current === state.over && userData.equippedSkin === 'amongus') {
                if (images.birdDeadAU) {
                    const img = new Image(); img.src = images.birdDeadAU.toDataURL();
                    sprite = img;
                }
            } else {
                if(images.birds && images.birds[userData.equippedSkin]) {
                    let arr = images.birds[userData.equippedSkin];
                    if (arr && arr.length) sprite = arr[this.animation[this.frame]];
                }
            }
            if(!sprite) return;
            
            let drawW = this.w; let drawH = this.h;
            if (userData.equippedSkin === 'bigo') { drawW = 44; drawH = 34; }
            if (userData.equippedSkin === 'gd') { drawW = 30; drawH = 30; }

            ctx.save();
            ctx.translate(this.x, this.y);
            
            let rot = this.rotation;
            if (state.current === state.over && userData.equippedSkin === 'amongus') rot = 0;
            if (state.current === state.falling) rot = 0; 

            ctx.rotate(rot);
            if (sprite.complete || sprite instanceof HTMLCanvasElement) {
                ctx.drawImage(sprite, -drawW/2, -drawH/2, drawW, drawH);
            }
            ctx.restore();
        },
        update: function() {
            let period = state.current === state.getReady ? 10 : 5;
            this.frame += frames % period === 0 ? 1 : 0;
            this.frame %= this.animation.length;
            
            if(userData.equippedSkin === 'bigo') this.radius = 18; 
            else if(userData.equippedSkin === 'gd') this.radius = 15;
            else this.radius = 12;

            if(state.current === state.getReady) {
                if (userData.equippedSkin === 'gd') {
                    this.y = LOGICAL_HEIGHT - 112 - 15;
                    this.rotation = 0; this.speed = 0;
                } else {
                    this.y = 150; this.rotation = 0; this.speed = 0;
                }
            } 
            else if (state.current === state.falling) {
                this.speed += this.gravity * 1.5; 
                this.y += this.speed;
                crackParams.width += 3; 
                if (this.y > LOGICAL_HEIGHT + 60) {
                    state.current = state.over; 
                    playSound('hit'); 
                }
            }
            else {
                let g = this.gravity;
                if (userData.equippedSkin === 'gd') g = 0.45;
                this.speed += g;
                this.y += this.speed;

                if (userData.equippedSkin === 'gd') {
                    if (!this.onGround) {
                        this.rotation += 0.05;
                    } else {
                        let nearest90 = Math.round(this.rotation / (Math.PI/2)) * (Math.PI/2);
                        this.rotation = nearest90;
                    }
                } else {
                    if (this.speed >= this.jump) {
                        this.rotation = 90 * DEGREE; this.frame = 1;
                    } else {
                        this.rotation = -25 * DEGREE;
                    }
                }

                if(this.y - this.radius < 0) { this.y = this.radius; this.speed = 0; }
                
                let floorY = LOGICAL_HEIGHT - 112 - (userData.equippedSkin === 'gd' ? 15 : this.h/2);
                if(this.y >= floorY) {
                    if (userData.equippedSkin === 'bigo') {
                        if (state.current === state.game) {
                            state.current = state.falling;
                            screenShake = 25;
                            crackParams.active = true; crackParams.x = this.x; crackParams.width = 10;
                            playSound('hit');
                        }
                    } else if (userData.equippedSkin === 'gd') {
                        this.y = floorY;
                        this.speed = 0;
                        this.onGround = true;
                    } else {
                        this.y = floorY;
                        if(state.current === state.game) { 
                            state.current = state.over; 
                            if(userData.equippedSkin === 'amongus') playSound('die');
                            else playSound('hit');
                        }
                    }
                } else {
                    this.onGround = false;
                }
            }
        }
    };

    const pipes = {
        position: [], w: 52, gap: 100,
        update: function() {
            if(state.current !== state.game) return;
            
            let spawnRate = 100;
            if (userData.equippedSkin === 'gd') spawnRate = 90;

            if(frames % spawnRate === 0) {
                let spikeCount = 0;
                if (userData.equippedSkin === 'gd') spikeCount = Math.floor(Math.random() * 3) + 1;

                this.position.push({ 
                    x: logicalWidth, 
                    y: -150 * (Math.random() + 1), 
                    passed: false, 
                    hasCoin: userData.equippedSkin !== 'bigo' && userData.equippedSkin !== 'gd' && Math.random() < 0.4, 
                    hasBurger: userData.equippedSkin === 'bigo',
                    collected: false,
                    broken: false,
                    spikes: spikeCount 
                });
            }

            for(let i=0; i<this.position.length; i++) {
                let p = this.position[i];
                let bY = p.y + 320 + this.gap;
                let collided = false;

                if (userData.equippedSkin === 'gd') {
                    let spikeY = LOGICAL_HEIGHT - 112;
                    let birdBottom = bird.y + bird.radius;
                    let birdRight = bird.x + bird.radius;
                    let birdLeft = bird.x - bird.radius;
                    let spikesW = p.spikes * 30; 
                    
                    if (birdRight > p.x + 10 && birdLeft < p.x + spikesW - 10) {
                        if (birdBottom > spikeY - 20) collided = true;
                    }
                } else {
                    if (!p.broken) {
                        if(bird.x+bird.radius > p.x && bird.x-bird.radius < p.x+this.w && (bird.y-bird.radius < p.y+320 || bird.y+bird.radius > bY)) {
                            collided = true;
                        }
                    }
                }

                if (collided) {
                    if (userData.equippedSkin === 'bigo') {
                        p.broken = true; createDebris(p.x + this.w/2, p.y + 320); playSound('hit');
                    } else {
                        state.current = state.over; 
                        playSound('hit');
                        if (userData.equippedSkin !== 'amongus' && userData.equippedSkin !== 'gd') setTimeout(() => playSound('die'), 300);
                    }
                }

                let scoreCondition = false;
                if (userData.equippedSkin === 'bigo') {
                    if (p.hasBurger && !p.collected) {
                        let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2;
                        if(Math.hypot(bird.x-cx, bird.y-cy) < 35) { 
                            p.collected = true; score.value++;
                            userData.highScore = Math.max(score.value, userData.highScore);
                            playSound('chomp'); saveData();
                        }
                    }
                } else if (userData.equippedSkin === 'gd') {
                    if(!p.passed && bird.x > p.x + (p.spikes*30)) scoreCondition = true;
                } else {
                    if(!p.passed && bird.x - bird.radius > p.x + this.w) scoreCondition = true;
                }

                if(scoreCondition) {
                    p.passed = true; score.value++;
                    userData.highScore = Math.max(score.value, userData.highScore);
                    playSound('point'); saveData();
                }

                if(p.hasCoin && !p.collected) {
                    let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2;
                    if (userData.equippedSkin === 'gd') { cx = p.x + (p.spikes*30) + 100; cy = LOGICAL_HEIGHT - 112 - 20; }
                    
                    if(Math.hypot(bird.x-cx, bird.y-cy) < 30) { 
                        p.collected = true; userData.coins++; saveData(); playSound('coin');
                        document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`; 
                    }
                }
                
                p.x -= getGameSpeed();
                if(p.x + 150 <= 0) { this.position.shift(); i--; }
            }
        },
        draw: function() {
            let isAU = userData.equippedSkin === 'amongus';
            let isGD = userData.equippedSkin === 'gd';

            for(let p of this.position) {
                if (p.broken) continue; 
                
                if (isGD) {
                    let floorY = LOGICAL_HEIGHT - 112;
                    ctx.fillStyle = '#333'; ctx.beginPath();
                    for(let i=0; i<p.spikes; i++) {
                        let sx = p.x + (i * 30);
                        ctx.moveTo(sx, floorY); ctx.lineTo(sx + 15, floorY - 30); ctx.lineTo(sx + 30, floorY);
                    }
                    ctx.fill(); ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2; ctx.stroke();
                } else {
                    if (images.pipe) {
                        let topY = p.y;
                        let bottomY = p.y + 320 + this.gap;

                        ctx.save();
                        if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)';
                        ctx.translate(p.x + this.w/2, topY + 160); ctx.rotate(Math.PI);
                        ctx.drawImage(images.pipe, -this.w/2, -160, this.w, 320); 
                        ctx.restore();

                        ctx.save();
                        if(isAU) ctx.filter = 'grayscale(1) contrast(1.5) brightness(0.8)';
                        ctx.drawImage(images.pipe, p.x, bottomY);
                        ctx.restore();
                    } else {
                         ctx.fillStyle = "green";
                         ctx.fillRect(p.x, p.y, this.w, 320);
                         ctx.fillRect(p.x, p.y + 320 + this.gap, this.w, 320);
                    }
                    
                    if(p.hasBurger && !p.collected && images.burger) {
                        ctx.drawImage(images.burger, p.x + this.w/2 - 12, p.y + 320 + this.gap/2 - 10);
                    }
                }

                if(p.hasCoin && !p.collected) {
                    let cx = p.x + this.w/2, cy = p.y + 320 + this.gap/2;
                    if (isGD) { cx = p.x + (p.spikes*30) + 100; cy = LOGICAL_HEIGHT - 112 - 20; }
                    ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                    ctx.fillStyle = '#FFF'; ctx.font = '12px FlappyFont'; ctx.fillText("$", cx-3, cy+3);
                }
            }
        }
    };

    const score = {
        value: 0,
        draw: function() {
            ctx.fillStyle = '#FFF'; ctx.strokeStyle = '#000';
            if (state.current === state.game) {
                ctx.lineWidth = 2; ctx.font = '35px FlappyFont';
                ctx.fillText(this.value, logicalWidth / 2, 50);
                ctx.strokeText(this.value, logicalWidth / 2, 50);
            }
        },
        reset: function() { this.value = 0; }
    };

    function createDebris(x, y) {
        for(let i=0; i<10; i++) debris.push({ x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 30, color: '#558022' });
    }
    function updateDebris() {
        for(let i=0; i<debris.length; i++) {
            let p = debris[i]; p.x += p.vx; p.y += p.vy; p.life--;
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 6, 6);
            if(p.life <= 0) { debris.splice(i, 1); i--; }
        }
    }

    // OPTIMIZATION: Main Draw Loop
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        
        // Removed global ctx.scale(). We now draw 1:1 to the low-res canvas
        
        bg.draw(); 
        
        try {
            pipes.draw(); 
            bird.draw(); 
            fg.draw(); 
            score.draw(); 
            updateDebris(); 
        } catch(e) {
            console.error("Draw error:", e);
        }

        if (state.current === state.getReady) {
            if (images.msg) ctx.drawImage(images.msg, logicalWidth/2 - images.msg.width/2, 100);
            document.getElementById('shopTriggerBtn').style.display = 'block'; 
            document.getElementById('shopTriggerBtn').innerText = `SHOP (${userData.coins})`;
        } else if (state.current === state.over) {
            document.getElementById('shopTriggerBtn').style.display = 'none';
            let centerX = logicalWidth / 2;
            if (images.gameover) ctx.drawImage(images.gameover, centerX - images.gameover.width/2, 80);

            ctx.fillStyle = '#DED895'; ctx.fillRect(centerX - 100, 140, 200, 110); ctx.strokeRect(centerX - 100, 140, 200, 110);
            ctx.fillStyle = '#E57338'; ctx.font = '18px FlappyFont'; ctx.textAlign = 'left';
            ctx.fillText("SCORE", centerX - 85, 170); ctx.fillText("BEST", centerX - 85, 210);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'right';
            ctx.fillText(score.value, centerX + 70, 170); ctx.fillText(userData.highScore, centerX + 70, 210);
            ctx.fillStyle = '#73BF2E'; ctx.fillRect(centerX - 41, 263, 83, 35); ctx.strokeRect(centerX - 41, 263, 83, 35);
            ctx.fillStyle = '#FFF'; ctx.textAlign = 'center'; ctx.fillText("START", centerX, 288);
            
            if(score.value >= 10) {
                ctx.fillStyle = score.value >= 20 ? '#FFD700' : '#C0C0C0';
                ctx.beginPath(); ctx.arc(centerX - 65, 195, 18, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            }
        } else {
            document.getElementById('shopTriggerBtn').style.display = 'none';
        }
        
        // No restore needed as we didn't save/scale globally
    }

    function loop() {
        bird.update(); fg.update(); pipes.update(); draw(); frames++; requestAnimationFrame(loop);
    }
    function resetGame() { bird.speed = 0; bird.y = 150; pipes.position = []; score.value = 0; frames = 0; debris = []; crackParams={active:false,width:0,x:0}; }

    function saveData() {
        localStorage.setItem('fb_highScore', userData.highScore);
        localStorage.setItem('fb_coins', userData.coins);
        localStorage.setItem('fb_skins', JSON.stringify(userData.unlockedSkins));
        localStorage.setItem('fb_equipped', userData.equippedSkin);
    }

    const shopConfig = [
        { id: 'yellow', name: 'Original', price: 0 },
        { id: 'amongus', name: 'Among Us', price: 0 },
        { id: 'bigo', name: 'Big O', price: 0 },
        { id: 'gd', name: 'Dash', price: 0 }
    ];

    function initShop() {
        const container = document.getElementById('shopItemsContainer'); container.innerHTML = '';
        shopConfig.forEach(item => {
            const div = document.createElement('div'); div.className = 'shop-item'; div.id = `shop-item-${item.id}`;
            div.onclick = (e) => { e.stopPropagation(); handleShopClick(item); };
            const img = document.createElement('img');
            if(item.id === 'amongus') img.src = createAmongUsAsset('alive').toDataURL();
            else if(item.id === 'bigo') img.src = createBigOAsset().toDataURL();
            else if(item.id === 'gd') img.src = createGDAsset().toDataURL();
            else if(ASSETS.sprites.birdYellow && ASSETS.sprites.birdYellow[0]) img.src = ASSETS.sprites.birdYellow[0];
            const name = document.createElement('div'); name.innerText = item.name; name.style.fontSize = '12px'; name.style.marginTop = '5px';
            const cost = document.createElement('div'); cost.className = 'item-cost';
            div.appendChild(img); div.appendChild(name); div.appendChild(cost); container.appendChild(div);
        });
        updateShopUI();
    }

    function updateShopUI() {
        document.getElementById('shopCoinCount').innerText = userData.coins;
        shopConfig.forEach(item => {
            const el = document.getElementById(`shop-item-${item.id}`);
            const costEl = el.querySelector('.item-cost');
            const isUnlocked = userData.unlockedSkins.includes(item.id);
            const isEquipped = userData.equippedSkin === item.id;
            el.classList.remove('locked', 'selected');
            if (!isUnlocked) el.classList.add('locked');
            if (isEquipped) el.classList.add('selected');
            costEl.innerText = isEquipped ? "EQUIPPED" : (isUnlocked ? "OWNED" : `${item.price} COINS`);
        });
    }

    function handleShopClick(item) {
        if (userData.unlockedSkins.includes(item.id)) {
            userData.equippedSkin = item.id; playSound('flap');
        } else {
            if (userData.coins >= item.price) {
                userData.coins -= item.price; userData.unlockedSkins.push(item.id); userData.equippedSkin = item.id; playSound('point');
            } else playSound('hit');
        }
        saveData(); updateShopUI();
    }

    const shopModal = document.getElementById('shop-modal');
    const shopBtn = document.getElementById('shopTriggerBtn');
    shopBtn.onclick = (e) => { e.stopPropagation(); updateShopUI(); shopModal.style.display = 'flex'; };
    document.getElementById('closeShopX').onclick = (e) => { e.stopPropagation(); shopModal.style.display = 'none'; shopBtn.innerText = `SHOP (${userData.coins})`; };
    
    // --- Optimized Responsive Input ---
    function getGameCoords(e) {
        let rect = canvas.getBoundingClientRect();
        // Updated mapping logic for Low-Res Canvas
        return {
            x: (e.clientX - rect.left) * (canvas.width / rect.width),
            y: (e.clientY - rect.top) * (canvas.height / rect.height)
        };
    }

    canvas.addEventListener('pointerdown', (e) => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (shopModal.style.display === 'flex') return;
        
        if (state.current === state.over) {
            let coords = getGameCoords(e);
            let centerX = logicalWidth / 2;
            
            // Scaled Start Button hit detection
            if (coords.x >= centerX - 41 && coords.x <= centerX + 42 &&
                coords.y >= 263 && coords.y <= 298) {
                resetGame();
                state.current = state.getReady;
            }
            return;
        }

        if (state.current === state.getReady) state.current = state.game;
        if (state.current === state.game) { bird.flap(); playSound('flap'); }
    });

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            if (e.repeat) return;
            if (shopModal.style.display === 'flex') return;
            if (state.current === state.getReady) state.current = state.game;
            if (state.current === state.game) { bird.flap(); playSound('flap'); }
        }
    });

    async function initGame() {
        const audioProms = Object.keys(ASSETS.audio).map(k => loadSound(ASSETS.audio[k], k));
        audioProms.push(loadSound(ASSETS.audio.au_point, 'au_point'));
        audioProms.push(loadSound(ASSETS.audio.au_kill, 'au_kill'));
        audioProms.push(loadSound(ASSETS.audio.bigo_flap, 'bigo_flap'));
        audioProms.push(loadSound(ASSETS.audio.bigo_chomp, 'bigo_chomp'));

        // Robust image loader that returns null on error instead of throwing
        const loadImg = (src) => new Promise(r => { const img = new Image(); if(!src.startsWith('data')) img.crossOrigin = "anonymous"; img.onload = () => r(img); img.onerror = () => r(null); img.src = src; });
        
        images.bg = await loadImg(ASSETS.sprites.bg);
        images.base = await loadImg(ASSETS.sprites.base);
        images.pipe = await loadImg(ASSETS.sprites.pipe);
        images.msg = await loadImg(ASSETS.sprites.msg);
        images.gameover = await loadImg(ASSETS.sprites.gameover);
        images.bgSpace = createSpaceBg();
        images.birdDeadAU = createAmongUsAsset('dead');
        images.burger = createBurgerAsset();
        
        const auAlive = createAmongUsAsset('alive');
        const bigOAlive = createBigOAsset();
        const gdAlive = createGDAsset();

        images.birds = {};
        for(let c of ['yellow', 'blue', 'red', 'amongus', 'bigo', 'gd']) {
            images.birds[c] = [];
            if(c === 'amongus') { const img = new Image(); img.src = auAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if (c === 'bigo') { const img = new Image(); img.src = bigOAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if (c === 'gd') { const img = new Image(); img.src = gdAlive.toDataURL(); images.birds[c] = [img, img, img]; }
            else if(ASSETS.sprites['bird' + c.charAt(0).toUpperCase() + c.slice(1)]) {
                const arr = ASSETS.sprites['bird'+c.charAt(0).toUpperCase()+c.slice(1)];
                for(let s of arr) images.birds[c].push(await loadImg(s));
            }
        }
        await Promise.all(audioProms);
        document.getElementById('loading-overlay').style.display = 'none';
        initShop(); loop();
    }
    initGame();
</script>
</body>
</html>